<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="保守型公式的再平衡#
本文提出了保守型公式的方法：Python中的保守型公式：简化的量化投资
这只是众多可能的再平衡方法中的一种，但它相对易于理解。方法概要如下：

从Y个股票（比如1000个中的100个）中选出x只股票
选股标准为：

低波动性
高净派息收益率（Net Payout Yield，NPY）
高动量
每月再平衡一次



了解了这些概念后，接下来我们将展示如何在Backtrader中实现这一策略。
数据#
即使有一个获胜的策略，如果没有可用的数据，那么一切都不会成真。因此，需要考虑数据的格式和如何加载它。
假设有一组CSV文件（“逗号分隔值”），每个文件包含以下特征：

每月的OHLCV数据
额外的列包含净派息收益率（NPY），以形成一个ohlcvn数据集。

CSV数据格式如下：
date, open, high, low, close, volume, npy
2001-12-31, 1.0, 1.0, 1.0, 1.0, 0.5, 3.0
2002-01-31, 2.0, 2.5, 1.1, 1.2, 3.0, 5.0
...即每行表示一个月的数据。接下来，可以通过Backtrader的CSV数据加载引擎创建一个简单的扩展类。
class NetPayOutData(bt.feeds.GenericCSVData):
    lines = ('npy',)  # 增加一行，用于存储净派息收益率
    params = dict(
        npy=6,  # npy字段位于第6列（基于0的索引）
        dtformat='%Y-%m-%d',  # 设置日期格式为yyyy-mm-dd
        timeframe=bt.TimeFrame.Months,  # 设置时间框架为按月
        openinterest=-1,  # -1表示没有openinterest字段
    )这样就完成了对数据源的扩展。注意，通过lines=('npy',)，已经将净派息收益率（NPY）数据添加到了OHLCV数据流中。其他常见的字段（如open、high等）已经是GenericCSVData的一部分。通过在params中指定位置，我们能够告诉Backtrader净派息收益率所在的列。
策略#
接下来，我们将逻辑封装到Backtrader的标准策略中。为了使其尽可能通用和可自定义，我们将采用与数据源相同的params方法。
首先，我们来回顾一下快速总结中的一个要点：

从一个Y个股票的宇宙中选择x个股票

策略本身不负责将股票添加到股票宇宙中，但它负责选择股票。假设宇宙中有1000只股票，但在代码中设置了x=100，那么即使只有50只股票被加入，策略也会选择100只。为了应对这种情况，我们会做如下处理：

设置selperc参数，默认值为0.10（即10%），表示从宇宙中选择的股票数量。

例如，如果宇宙中有1000只股票，则选择100只；如果只有50只股票，则选择5只。
股票的排名公式如下：
(momentum * net payout) / volatility即，动量更大、派息收益率更高、波动性更低的股票会有更高的评分。"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://www.poloxue.com/backtrader/docs/19-articles/05-rebalancing-conserative/"><meta property="og:site_name" content="Backtrader 中文"><meta property="og:title" content="保守型公式的再平衡"><meta property="og:description" content="保守型公式的再平衡# 本文提出了保守型公式的方法：Python中的保守型公式：简化的量化投资
这只是众多可能的再平衡方法中的一种，但它相对易于理解。方法概要如下：
从Y个股票（比如1000个中的100个）中选出x只股票 选股标准为： 低波动性 高净派息收益率（Net Payout Yield，NPY） 高动量 每月再平衡一次 了解了这些概念后，接下来我们将展示如何在Backtrader中实现这一策略。
数据# 即使有一个获胜的策略，如果没有可用的数据，那么一切都不会成真。因此，需要考虑数据的格式和如何加载它。
假设有一组CSV文件（“逗号分隔值”），每个文件包含以下特征：
每月的OHLCV数据 额外的列包含净派息收益率（NPY），以形成一个ohlcvn数据集。 CSV数据格式如下：
date, open, high, low, close, volume, npy 2001-12-31, 1.0, 1.0, 1.0, 1.0, 0.5, 3.0 2002-01-31, 2.0, 2.5, 1.1, 1.2, 3.0, 5.0 ...即每行表示一个月的数据。接下来，可以通过Backtrader的CSV数据加载引擎创建一个简单的扩展类。
class NetPayOutData(bt.feeds.GenericCSVData): lines = ('npy',) # 增加一行，用于存储净派息收益率 params = dict( npy=6, # npy字段位于第6列（基于0的索引） dtformat='%Y-%m-%d', # 设置日期格式为yyyy-mm-dd timeframe=bt.TimeFrame.Months, # 设置时间框架为按月 openinterest=-1, # -1表示没有openinterest字段 )这样就完成了对数据源的扩展。注意，通过lines=('npy',)，已经将净派息收益率（NPY）数据添加到了OHLCV数据流中。其他常见的字段（如open、high等）已经是GenericCSVData的一部分。通过在params中指定位置，我们能够告诉Backtrader净派息收益率所在的列。
策略# 接下来，我们将逻辑封装到Backtrader的标准策略中。为了使其尽可能通用和可自定义，我们将采用与数据源相同的params方法。
首先，我们来回顾一下快速总结中的一个要点：
从一个Y个股票的宇宙中选择x个股票 策略本身不负责将股票添加到股票宇宙中，但它负责选择股票。假设宇宙中有1000只股票，但在代码中设置了x=100，那么即使只有50只股票被加入，策略也会选择100只。为了应对这种情况，我们会做如下处理：
设置selperc参数，默认值为0.10（即10%），表示从宇宙中选择的股票数量。 例如，如果宇宙中有1000只股票，则选择100只；如果只有50只股票，则选择5只。
股票的排名公式如下：
(momentum * net payout) / volatility即，动量更大、派息收益率更高、波动性更低的股票会有更高的评分。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2025-01-03T19:00:57+08:00"><title>保守型公式的再平衡 | Backtrader 中文</title><link rel=icon href=/backtrader/favicon.png><link rel=manifest href=/backtrader/manifest.json><link rel=canonical href=https://www.poloxue.com/backtrader/docs/19-articles/05-rebalancing-conserative/><link rel=stylesheet href=/backtrader/book.min.f079ea268834b2e0459e63011be648e8a3cc0e4819a71206873f891528fbfdf6.css integrity="sha256-8HnqJog0suBFnmMBG+ZI6KPMDkgZpxIGhz+JFSj7/fY=" crossorigin=anonymous><script defer src=/backtrader/fuse.min.js></script><script defer src=/backtrader/en.search.min.a7d56874a33e233f953f540ef3c11c0be93860fdfe14aa34680dadfe5117545b.js integrity="sha256-p9VodKM+Iz+VP1QO88EcC+k4YP3+FKo0aA2t/lEXVFs=" crossorigin=anonymous></script><script defer src=/backtrader/sw.min.6e7f3387f593f3527ac4d321c3f23a8d1e0c070c219a9f97642913dc39d4b5ff.js integrity="sha256-bn8zh/WT81J6xNMhw/I6jR4MBwwhmp+XZCkT3DnUtf8=" crossorigin=anonymous></script><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-docs"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/backtrader/><img src=/backtrader/logo.png alt=Logo><span>Backtrader 中文</span></a></h2><div class="book-search hidden"><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><a href=/backtrader/docs/01-introduction/>介绍</a><ul></ul></li><li><a href=/backtrader/docs/02-installation/>安装指南</a><ul></ul></li><li><input type=checkbox id=section-ef1b0f3b48f1accf5a8e12976586a132 class=toggle>
<label for=section-ef1b0f3b48f1accf5a8e12976586a132 class=flex><a href=/backtrader/docs/03-quickstart/>快速开始</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/03-quickstart/01-setup/>环境设置</a></li><li><a href=/backtrader/docs/03-quickstart/02-cash/>账户配置</a></li><li><a href=/backtrader/docs/03-quickstart/03-datafeed/>配置数据</a></li><li><a href=/backtrader/docs/03-quickstart/04-first-strategy/>第一个策略</a></li><li><a href=/backtrader/docs/03-quickstart/0401-basic-concept/>基础概念</a></li><li><a href=/backtrader/docs/03-quickstart/05-strategy-logic/>开始交易</a></li><li><a href=/backtrader/docs/03-quickstart/06-sell/>卖出操作</a></li><li><a href=/backtrader/docs/03-quickstart/07-commission/>交易监控</a></li><li><a href=/backtrader/docs/03-quickstart/08-parameters/>参数定义</a></li><li><a href=/backtrader/docs/03-quickstart/09-indicators/>技术指标</a></li><li><a href=/backtrader/docs/03-quickstart/10-plotting/>可视化</a></li><li><a href=/backtrader/docs/03-quickstart/11-optimization/>策略优化</a></li></ul></li><li><input type=checkbox id=section-8b6cc0ccf66e33ea233e54e3e1c71bd0 class=toggle>
<label for=section-8b6cc0ccf66e33ea233e54e3e1c71bd0 class=flex><a href=/backtrader/docs/04-concepts/>核心概念</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/04-concepts/01-platform-concepts/>平台概念</a><ul><li><a href=/backtrader/docs/04-concepts/01-platform-concepts/01-datafeed/>数据源 DataFeed</a></li><li><a href=/backtrader/docs/04-concepts/01-platform-concepts/02-params/>策略参数</a></li><li><a href=/backtrader/docs/04-concepts/01-platform-concepts/03-line/>线 Line 类</a></li><li><a href=/backtrader/docs/04-concepts/01-platform-concepts/04-index/>索引和切片</a></li><li><a href=/backtrader/docs/04-concepts/01-platform-concepts/05-operator/>运算符</a></li></ul></li><li><a href=/backtrader/docs/04-concepts/02-operate-the-platform/>平台操作</a><ul><li><a href=/backtrader/docs/04-concepts/02-operate-the-platform/01-iteration/>Line 迭代器</a></li><li><a href=/backtrader/docs/04-concepts/02-operate-the-platform/02-startup/>启动运行</a></li></ul></li></ul></li><li><input type=checkbox id=section-1d25046da157a996ab4b83cedd86be47 class=toggle>
<label for=section-1d25046da157a996ab4b83cedd86be47 class=flex><a href=/backtrader/docs/05-cerebro/>Cerebro</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/05-cerebro/01-cerebro/>Cerebro</a></li><li><a href=/backtrader/docs/05-cerebro/02-reference/>参数说明</a></li><li><a href=/backtrader/docs/05-cerebro/03-saving-memory/>节省内存</a></li><li><a href=/backtrader/docs/05-cerebro/04-optimization-improvements/>优化改进</a></li><li><a href=/backtrader/docs/05-cerebro/05-exceptions/>异常 Exceptions</a></li><li><a href=/backtrader/docs/05-cerebro/06-logging-writer/>日志 Logging - Writter</a></li></ul></li><li><input type=checkbox id=section-b39bf4495a5a92ed51fcc77b0cf4545f class=toggle>
<label for=section-b39bf4495a5a92ed51fcc77b0cf4545f class=flex><a role=button>DataFeed</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/06-datafeed/01-datafeeds/>Data Feeds</a></li><li><a href=/backtrader/docs/06-datafeed/02-datafeed-extending/>扩展数据源</a></li><li><a href=/backtrader/docs/06-datafeed/03-datafeed-development-csv/>开发 CSV 数据源</a></li><li><a href=/backtrader/docs/06-datafeed/04-datafeed-development-general/>开发 Binary 数据源</a></li><li><a href=/backtrader/docs/06-datafeed/05-datafeed-multiple-timeframes/>多时间框架</a></li><li><a href=/backtrader/docs/06-datafeed/06-datafeed-resampling/>重采样</a></li><li><a href=/backtrader/docs/06-datafeed/07-datafeed-replay/>数据回放</a></li><li><a href=/backtrader/docs/06-datafeed/08-datafeed-rollover/>数据滚动</a></li><li><a>过滤器 Filters</a><ul><li><a href=/backtrader/docs/06-datafeed/09-datafeed-filters/01-datafeed-filters/>过滤器 Filters</a></li><li><a href=/backtrader/docs/06-datafeed/09-datafeed-filters/02-datafeed-filters-referrence/>参考文档</a></li></ul></li><li><a href=/backtrader/docs/06-datafeed/10-datafeed-yahoo/>Yahoo 数据源说明</a></li><li><a href=/backtrader/docs/06-datafeed/11-datafeed-pandas/>Pandas 数据源示例</a></li><li><a href=/backtrader/docs/06-datafeed/12-datafeed-reference/>数据源参考</a></li></ul></li><li><input type=checkbox id=section-e3fe58eaef3418b317102036dce25013 class=toggle>
<label for=section-e3fe58eaef3418b317102036dce25013 class=flex><a role=button>Strategy</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/07-strategy/01-strategy/>Strategy</a></li><li><a href=/backtrader/docs/07-strategy/02-strategy-with-signals/>信号策略</a></li><li><a href=/backtrader/docs/07-strategy/03-strategy-references/>策略参考</a></li></ul></li><li><input type=checkbox id=section-cad109a715fc3bbeef472f4f0cad4358 class=toggle>
<label for=section-cad109a715fc3bbeef472f4f0cad4358 class=flex><a role=button>Indicator</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/08-indicators/01-using-indicators/>使用指标</a></li><li><a href=/backtrader/docs/08-indicators/02-indicators-development/>指标开发</a></li><li><a href=/backtrader/docs/08-indicators/03-timeframe-mixing/>周期混合</a></li><li><a href=/backtrader/docs/08-indicators/04-talib/>TA-Lib</a></li></ul></li><li><input type=checkbox id=section-56aaa6caa9d538f335a48813aa684f48 class=toggle>
<label for=section-56aaa6caa9d538f335a48813aa684f48 class=flex><a role=button>Order</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/09-orders/01-general/>订单</a></li><li><a href=/backtrader/docs/09-orders/02-creation-execution/>创建/执行</a></li><li><a href=/backtrader/docs/09-orders/03-target-orders/>目标订单</a></li><li><a href=/backtrader/docs/09-orders/04-oco-orders/>OCO 订单</a></li><li><a href=/backtrader/docs/09-orders/05-bracket-orders/>Bracket Orders</a></li><li><a href=/backtrader/docs/09-orders/06-future-spot-compensation/>期货和现货补偿</a></li><li><a href=/backtrader/docs/09-orders/07-stop-trails/>跟踪止损（限价）</a></li></ul></li><li><input type=checkbox id=section-44410e36d2de519599cb0e5e09a3b2ed class=toggle>
<label for=section-44410e36d2de519599cb0e5e09a3b2ed class=flex><a role=button>Broker</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/10-broker/01-broker/>Broker</a></li><li><a href=/backtrader/docs/10-broker/02-slippage/>滑点</a></li><li><a href=/backtrader/docs/10-broker/03-cheat-on-open/>开盘作弊</a></li><li><a href=/backtrader/docs/10-broker/04-volume-filling-filler/>填充器</a></li><li><a href=/backtrader/docs/10-broker/05-position/>Position</a></li><li><a href=/backtrader/docs/10-broker/06-trade/>Trade</a></li></ul></li><li><input type=checkbox id=section-ae52187dba190ff9aaf14da3856b7cd3 class=toggle>
<label for=section-ae52187dba190ff9aaf14da3856b7cd3 class=flex><a role=button>Commission</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/11-commission-schemes/01-commission-schemes/>佣金</a></li><li><a href=/backtrader/docs/11-commission-schemes/02-commission-schemes-extending/>扩展</a></li><li><a href=/backtrader/docs/11-commission-schemes/03-customization/>自定义佣金</a></li><li><a href=/backtrader/docs/11-commission-schemes/04-credit-interests/>利息</a></li></ul></li><li><input type=checkbox id=section-c06d50c5f364fda6157cd2e0322dd59c class=toggle>
<label for=section-c06d50c5f364fda6157cd2e0322dd59c class=flex><a role=button>Analyzer</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/12-analyzers/01-analyzers/>Analyzers</a></li><li><a href=/backtrader/docs/12-analyzers/02-pyfolio/>Pyfolio</a></li><li><a href=/backtrader/docs/12-analyzers/03-pyfolio-integration/>Pyfolio 集成</a></li><li><a href=/backtrader/docs/12-analyzers/04-reference/>Reference</a></li></ul></li><li><input type=checkbox id=section-c8768af388a3e3ade998ccab1da7af20 class=toggle>
<label for=section-c8768af388a3e3ade998ccab1da7af20 class=flex><a role=button>Observer</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/13-observers/01-statistics/>统计</a></li><li><a href=/backtrader/docs/13-observers/02-benchmarking/>基准测试</a></li><li><a href=/backtrader/docs/13-observers/03-reference/>参考</a></li></ul></li><li><input type=checkbox id=section-71aa242f05842258d04bb7390059ae0c class=toggle>
<label for=section-71aa242f05842258d04bb7390059ae0c class=flex><a role=button>Sizer</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/14-sizers/01-sizers/>sizers</a></li><li><a href=/backtrader/docs/14-sizers/02-reference/>参考</a></li></ul></li><li><input type=checkbox id=section-5787874ab2a916d11389152b4141fa73 class=toggle>
<label for=section-5787874ab2a916d11389152b4141fa73 class=flex><a href=/backtrader/docs/15-livetrading/>实盘</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/15-livetrading/01-interactive-brokers/>Interactive Brokers</a></li><li><a href=/backtrader/docs/15-livetrading/02-qanda-v1-0/>Qanda</a></li><li><a href=/backtrader/docs/15-livetrading/03-visual-chart/>Visual Chart</a></li></ul></li><li><input type=checkbox id=section-3dcf1c9f08afe4d22a0a825dccbf62c9 class=toggle>
<label for=section-3dcf1c9f08afe4d22a0a825dccbf62c9 class=flex><a role=button>绘图</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/16-plotting/01-plotting/>Plotting</a></li><li><a href=/backtrader/docs/16-plotting/02-ploting-date-ranges/>绘制日期范围</a></li><li><a href=/backtrader/docs/16-plotting/03-plotting-same-axis/>同轴绘图</a></li></ul></li><li><input type=checkbox id=section-b6e31488b3e951ce956583dfc7ccd8a2 class=toggle>
<label for=section-b6e31488b3e951ce956583dfc7ccd8a2 class=flex><a role=button>日期时间</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/17-datetime/01-management/>管理</a></li><li><a href=/backtrader/docs/17-datetime/02-timer/>定时器</a></li><li><a href=/backtrader/docs/17-datetime/03-trading-calendars/>交易日历</a></li></ul></li><li><a href=/backtrader/docs/18-automated-running/>自动运行</a><ul></ul></li><li><input type=checkbox id=section-1c57bab4ff24bdea61d636c257658085 class=toggle checked>
<label for=section-1c57bab4ff24bdea61d636c257658085 class=flex><a role=button>官方文章</a>
<img src=/backtrader/icons/chevron-right.svg class=book-icon></label><ul><li><a href=/backtrader/docs/19-articles/01-out-of-memory/>超大内存</a></li><li><a href=/backtrader/docs/19-articles/02-cross-backtesting-pitfalls/>跨平台回测的陷进</a></li><li><a href=/backtrader/docs/19-articles/03-fractional-sizes/>加密货币中的分位仓位</a></li><li><a href=/backtrader/docs/19-articles/04-beating-the-random-entry/>打败随机入场</a></li><li><a href=/backtrader/docs/19-articles/05-rebalancing-conserative/ class=active>保守型公式的再平衡</a></li><li><a href=/backtrader/docs/19-articles/06-mfi-generic/>MFI 通用版</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/backtrader/icons/menu.svg class=book-icon alt=Menu></label><h3>保守型公式的再平衡</h3><label for=toc-control><img src=/backtrader/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><ul><li><a href=#数据>数据</a></li><li><a href=#策略>策略</a></li><li><a href=#策略实现>策略实现</a></li><li><a href=#运行和评估>运行和评估</a></li><li><a href=#性能评估>性能评估</a></li><li><a href=#完整脚本>完整脚本</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=保守型公式的再平衡>保守型公式的再平衡<a class=anchor href=#%e4%bf%9d%e5%ae%88%e5%9e%8b%e5%85%ac%e5%bc%8f%e7%9a%84%e5%86%8d%e5%b9%b3%e8%a1%a1>#</a></h1><p>本文提出了保守型公式的方法：<strong>Python中的保守型公式：简化的量化投资</strong></p><p>这只是众多可能的再平衡方法中的一种，但它相对易于理解。方法概要如下：</p><ul><li>从Y个股票（比如1000个中的100个）中选出x只股票</li><li>选股标准为：<ul><li>低波动性</li><li>高净派息收益率（Net Payout Yield，NPY）</li><li>高动量</li><li>每月再平衡一次</li></ul></li></ul><p>了解了这些概念后，接下来我们将展示如何在Backtrader中实现这一策略。</p><h3 id=数据>数据<a class=anchor href=#%e6%95%b0%e6%8d%ae>#</a></h3><p>即使有一个获胜的策略，如果没有可用的数据，那么一切都不会成真。因此，需要考虑数据的格式和如何加载它。</p><p>假设有一组CSV文件（“逗号分隔值”），每个文件包含以下特征：</p><ul><li>每月的OHLCV数据</li><li>额外的列包含净派息收益率（NPY），以形成一个ohlcvn数据集。</li></ul><p>CSV数据格式如下：</p><pre tabindex=0><code>date, open, high, low, close, volume, npy
2001-12-31, 1.0, 1.0, 1.0, 1.0, 0.5, 3.0
2002-01-31, 2.0, 2.5, 1.1, 1.2, 3.0, 5.0
...</code></pre><p>即每行表示一个月的数据。接下来，可以通过Backtrader的CSV数据加载引擎创建一个简单的扩展类。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NetPayOutData</span>(bt<span style=color:#f92672>.</span>feeds<span style=color:#f92672>.</span>GenericCSVData):
</span></span><span style=display:flex><span>    lines <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#39;npy&#39;</span>,)  <span style=color:#75715e># 增加一行，用于存储净派息收益率</span>
</span></span><span style=display:flex><span>    params <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>        npy<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>,  <span style=color:#75715e># npy字段位于第6列（基于0的索引）</span>
</span></span><span style=display:flex><span>        dtformat<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#39;</span>,  <span style=color:#75715e># 设置日期格式为yyyy-mm-dd</span>
</span></span><span style=display:flex><span>        timeframe<span style=color:#f92672>=</span>bt<span style=color:#f92672>.</span>TimeFrame<span style=color:#f92672>.</span>Months,  <span style=color:#75715e># 设置时间框架为按月</span>
</span></span><span style=display:flex><span>        openinterest<span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span>,  <span style=color:#75715e># -1表示没有openinterest字段</span>
</span></span><span style=display:flex><span>    )</span></span></code></pre></div><p>这样就完成了对数据源的扩展。注意，通过<code>lines=('npy',)</code>，已经将净派息收益率（NPY）数据添加到了OHLCV数据流中。其他常见的字段（如open、high等）已经是<code>GenericCSVData</code>的一部分。通过在<code>params</code>中指定位置，我们能够告诉Backtrader净派息收益率所在的列。</p><h3 id=策略>策略<a class=anchor href=#%e7%ad%96%e7%95%a5>#</a></h3><p>接下来，我们将逻辑封装到Backtrader的标准策略中。为了使其尽可能通用和可自定义，我们将采用与数据源相同的<code>params</code>方法。</p><p>首先，我们来回顾一下快速总结中的一个要点：</p><ul><li>从一个Y个股票的宇宙中选择x个股票</li></ul><p>策略本身不负责将股票添加到股票宇宙中，但它负责选择股票。假设宇宙中有1000只股票，但在代码中设置了x=100，那么即使只有50只股票被加入，策略也会选择100只。为了应对这种情况，我们会做如下处理：</p><ul><li>设置<code>selperc</code>参数，默认值为0.10（即10%），表示从宇宙中选择的股票数量。</li></ul><p>例如，如果宇宙中有1000只股票，则选择100只；如果只有50只股票，则选择5只。</p><p>股票的排名公式如下：</p><pre tabindex=0><code>(momentum * net payout) / volatility</code></pre><p>即，动量更大、派息收益率更高、波动性更低的股票会有更高的评分。</p><p>动量使用“变动率”指标（ROC，Rate of Change），它衡量的是价格在一段时间内的变化比率。</p><p>净派息收益率已经作为数据的一部分包含在内。</p><p>波动性则使用股票的标准差（标准差基于n周期的回报率）来计算。</p><p>有了这些信息后，策略可以初始化所需的参数，并设置将在每个月的迭代中使用的指标和计算方法。</p><h3 id=策略实现>策略实现<a class=anchor href=#%e7%ad%96%e7%95%a5%e5%ae%9e%e7%8e%b0>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>St</span>(bt<span style=color:#f92672>.</span>Strategy):
</span></span><span style=display:flex><span>    params <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>        selcperc<span style=color:#f92672>=</span><span style=color:#ae81ff>0.10</span>,  <span style=color:#75715e># 从宇宙中选择的股票比例</span>
</span></span><span style=display:flex><span>        rperiod<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,  <span style=color:#75715e># 回报率计算周期，默认为1个周期</span>
</span></span><span style=display:flex><span>        vperiod<span style=color:#f92672>=</span><span style=color:#ae81ff>36</span>,  <span style=color:#75715e># 波动性回顾期，默认为36个周期</span>
</span></span><span style=display:flex><span>        mperiod<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>,  <span style=color:#75715e># 动量回顾期，默认为12个周期</span>
</span></span><span style=display:flex><span>        reserve<span style=color:#f92672>=</span><span style=color:#ae81ff>0.05</span>  <span style=color:#75715e># 5%的预留资本</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>log</span>(self, arg):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>date(), arg))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#75715e># 计算选股数量</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>selnum <span style=color:#f92672>=</span> int(len(self<span style=color:#f92672>.</span>datas) <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>selcperc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 每只股票的资本分配比例</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>perctarget <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1.0</span> <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>reserve) <span style=color:#f92672>/</span> self<span style=color:#f92672>.</span>selnum
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 计算回报率、波动性和动量</span>
</span></span><span style=display:flex><span>        rs <span style=color:#f92672>=</span> [bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>PctChange(d, period<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>rperiod) <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>datas]
</span></span><span style=display:flex><span>        vs <span style=color:#f92672>=</span> [bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>StdDev(ret, period<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>vperiod) <span style=color:#66d9ef>for</span> ret <span style=color:#f92672>in</span> rs]
</span></span><span style=display:flex><span>        ms <span style=color:#f92672>=</span> [bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>ROC(d, period<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>mperiod) <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>datas]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 排名公式： (动量 * 净派息收益率) / 波动性</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>ranks <span style=color:#f92672>=</span> {d: d<span style=color:#f92672>.</span>npy <span style=color:#f92672>*</span> m <span style=color:#f92672>/</span> v <span style=color:#66d9ef>for</span> d, v, m <span style=color:#f92672>in</span> zip(self<span style=color:#f92672>.</span>datas, vs, ms)}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>next</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#75715e># 按排名排序</span>
</span></span><span style=display:flex><span>        ranks <span style=color:#f92672>=</span> sorted(
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>ranks<span style=color:#f92672>.</span>items(),  <span style=color:#75715e># 获取(d, rank)对</span>
</span></span><span style=display:flex><span>            key<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> x: x[<span style=color:#ae81ff>1</span>][<span style=color:#ae81ff>0</span>],  <span style=color:#75715e># 使用排名（元素1）进行排序</span>
</span></span><span style=display:flex><span>            reverse<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,  <span style=color:#75715e># 按排名从高到低排序</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 获取排名前selnum的股票</span>
</span></span><span style=display:flex><span>        rtop <span style=color:#f92672>=</span> dict(ranks[:self<span style=color:#f92672>.</span>selnum])
</span></span><span style=display:flex><span>        <span style=color:#75715e># 获取排名低的股票</span>
</span></span><span style=display:flex><span>        rbot <span style=color:#f92672>=</span> dict(ranks[self<span style=color:#f92672>.</span>selnum:])
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e># 获取当前持有的股票</span>
</span></span><span style=display:flex><span>        posdata <span style=color:#f92672>=</span> [d <span style=color:#66d9ef>for</span> d, pos <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>getpositions()<span style=color:#f92672>.</span>items() <span style=color:#66d9ef>if</span> pos]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 卖出那些不再是前排名的股票</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> (d <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> posdata <span style=color:#66d9ef>if</span> d <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> rtop):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>log(<span style=color:#e6db74>&#39;Exit </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> - Rank </span><span style=color:#e6db74>{:.2f}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(d<span style=color:#f92672>.</span>_name, rbot[d][<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>order_target_percent(d, target<span style=color:#f92672>=</span><span style=color:#ae81ff>0.0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 重新平衡已经排名前的股票</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> (d <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> posdata <span style=color:#66d9ef>if</span> d <span style=color:#f92672>in</span> rtop):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>log(<span style=color:#e6db74>&#39;Rebal </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> - Rank </span><span style=color:#e6db74>{:.2f}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(d<span style=color:#f92672>.</span>_name, rtop[d][<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>order_target_percent(d, target<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>perctarget)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>del</span> rtop[d]  <span style=color:#75715e># 删除已处理的股票</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 为新进入的排名前的股票设置目标订单</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> rtop:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>log(<span style=color:#e6db74>&#39;Enter </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> - Rank </span><span style=color:#e6db74>{:.2f}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(d<span style=color:#f92672>.</span>_name, rtop[d][<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>order_target_percent(d, target<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>perctarget)</span></span></code></pre></div><h3 id=运行和评估>运行和评估<a class=anchor href=#%e8%bf%90%e8%a1%8c%e5%92%8c%e8%af%84%e4%bc%b0>#</a></h3><p>我们需要一些额外的代码来实现数据加载和运行策略的框架。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(args<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    args <span style=color:#f92672>=</span> parse_args(args)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cerebro <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>Cerebro()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 加载数据文件</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> fname <span style=color:#f92672>in</span> glob<span style=color:#f92672>.</span>glob(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(args<span style=color:#f92672>.</span>datadir, <span style=color:#e6db74>&#39;*&#39;</span>)):
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> NetPayOutData(dataname<span style=color:#f92672>=</span>fname, <span style=color:#f92672>**</span>dkwargs)
</span></span><span style=display:flex><span>        cerebro<span style=color:#f92672>.</span>adddata(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 添加策略</span>
</span></span><span style=display:flex><span>    cerebro<span style=color:#f92672>.</span>addstrategy(St, <span style=color:#f92672>**</span>eval(<span style=color:#e6db74>&#39;dict(&#39;</span> <span style=color:#f92672>+</span> args<span style=color:#f92672>.</span>strat <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;)&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 设置初始现金</span>
</span></span><span style=display:flex><span>    cerebro<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>setcash(args<span style=color:#f92672>.</span>cash)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cerebro<span style=color:#f92672>.</span>run()  <span style=color:#75715e># 执行策略</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 基本的性能评估</span>
</span></span><span style=display:flex><span>    pnl <span style=color:#f92672>=</span> cerebro<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>get_value() <span style=color:#f92672>-</span> args<span style=color:#f92672>.</span>cash
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Profit ... or Loss: </span><span style=color:#e6db74>{:.2f}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(pnl))</span></span></code></pre></div><h3 id=性能评估>性能评估<a class=anchor href=#%e6%80%a7%e8%83%bd%e8%af%84%e4%bc%b0>#</a></h3><p>一种简单的评估方法是计算最终资产值减去初始现金的差额。</p><p>Backtrader还提供了内置的性能分析器，如Sharpe比率、加权回报率、SQN等，具体可参考文档进行进一步的性能分析。</p><h3 id=完整脚本>完整脚本<a class=anchor href=#%e5%ae%8c%e6%95%b4%e8%84%9a%e6%9c%ac>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> argparse
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> glob
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os.path
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> backtrader <span style=color:#66d9ef>as</span> bt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NetPayOutData</span>(bt<span style=color:#f92672>.</span>feeds<span style=color:#f92672>.</span>GenericCSVData):
</span></span><span style=display:flex><span>    lines <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#39;npy&#39;</span>,)  <span style=color:#75715e># add a line containing the net payout yield</span>
</span></span><span style=display:flex><span>    params <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>        npy<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span>,  <span style=color:#75715e># npy field is in the 6th column (0 based index)</span>
</span></span><span style=display:flex><span>        dtformat<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#39;</span>,  <span style=color:#75715e># fix date format a yyyy-mm-dd</span>
</span></span><span style=display:flex><span>        timeframe<span style=color:#f92672>=</span>bt<span style=color:#f92672>.</span>TimeFrame<span style=color:#f92672>.</span>Months,  <span style=color:#75715e># fixed the timeframe</span>
</span></span><span style=display:flex><span>        openinterest<span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span>,  <span style=color:#75715e># -1 indicates there is no openinterest field</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>St</span>(bt<span style=color:#f92672>.</span>Strategy):
</span></span><span style=display:flex><span>    params <span style=color:#f92672>=</span> dict(
</span></span><span style=display:flex><span>        selcperc<span style=color:#f92672>=</span><span style=color:#ae81ff>0.10</span>,  <span style=color:#75715e># percentage of stocks to select from the universe</span>
</span></span><span style=display:flex><span>        rperiod<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>,  <span style=color:#75715e># period for the returns calculation, default 1 period</span>
</span></span><span style=display:flex><span>        vperiod<span style=color:#f92672>=</span><span style=color:#ae81ff>36</span>,  <span style=color:#75715e># lookback period for volatility - default 36 periods</span>
</span></span><span style=display:flex><span>        mperiod<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>,  <span style=color:#75715e># lookback period for momentum - default 12 periods</span>
</span></span><span style=display:flex><span>        reserve<span style=color:#f92672>=</span><span style=color:#ae81ff>0.05</span>  <span style=color:#75715e># 5% reserve capital</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>log</span>(self, arg):
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{}</span><span style=color:#e6db74> </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>date(), arg))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__init__</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#75715e># calculate 1st the amount of stocks that will be selected</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>selnum <span style=color:#f92672>=</span> int(len(self<span style=color:#f92672>.</span>datas) <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>selcperc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># allocation perc per stock</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># reserve kept to make sure orders are not rejected due to</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># margin. Prices are calculated when known (close), but orders can only</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># be executed next day (opening price). Price can gap upwards</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>perctarget <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1.0</span> <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>reserve) <span style=color:#f92672>/</span> self<span style=color:#f92672>.</span>selnum
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># returns, volatilities and momentums</span>
</span></span><span style=display:flex><span>        rs <span style=color:#f92672>=</span> [bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>PctChange(d, period<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>rperiod) <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>datas]
</span></span><span style=display:flex><span>        vs <span style=color:#f92672>=</span> [bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>StdDev(ret, period<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>vperiod) <span style=color:#66d9ef>for</span> ret <span style=color:#f92672>in</span> rs]
</span></span><span style=display:flex><span>        ms <span style=color:#f92672>=</span> [bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>ROC(d, period<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>mperiod) <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>datas]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># simple rank formula: (momentum * net payout) / volatility</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># the highest ranked: low vol, large momentum, large payout</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>ranks <span style=color:#f92672>=</span> {d: d<span style=color:#f92672>.</span>npy <span style=color:#f92672>*</span> m <span style=color:#f92672>/</span> v <span style=color:#66d9ef>for</span> d, v, m <span style=color:#f92672>in</span> zip(self<span style=color:#f92672>.</span>datas, vs, ms)}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>next</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#75715e># sort data and current rank</span>
</span></span><span style=display:flex><span>        ranks <span style=color:#f92672>=</span> sorted(
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>ranks<span style=color:#f92672>.</span>items(),  <span style=color:#75715e># get the (d, rank), pair</span>
</span></span><span style=display:flex><span>            key<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> x: x[<span style=color:#ae81ff>1</span>][<span style=color:#ae81ff>0</span>],  <span style=color:#75715e># use rank (elem 1) and current time &#34;0&#34;</span>
</span></span><span style=display:flex><span>            reverse<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,  <span style=color:#75715e># highest ranked 1st ... please</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># put top ranked in dict with data as key to test for presence</span>
</span></span><span style=display:flex><span>        rtop <span style=color:#f92672>=</span> dict(ranks[:self<span style=color:#f92672>.</span>selnum])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># For logging purposes of stocks leaving the portfolio</span>
</span></span><span style=display:flex><span>        rbot <span style=color:#f92672>=</span> dict(ranks[self<span style=color:#f92672>.</span>selnum:])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># prepare quick lookup list of stocks currently holding a position</span>
</span></span><span style=display:flex><span>        posdata <span style=color:#f92672>=</span> [d <span style=color:#66d9ef>for</span> d, pos <span style=color:#f92672>in</span> self<span style=color:#f92672>.</span>getpositions()<span style=color:#f92672>.</span>items() <span style=color:#66d9ef>if</span> pos]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># remove those no longer top ranked</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># do this first to issue sell orders and free cash</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> (d <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> posdata <span style=color:#66d9ef>if</span> d <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> rtop):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>log(<span style=color:#e6db74>&#39;Leave </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> - Rank </span><span style=color:#e6db74>{:.2f}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(d<span style=color:#f92672>.</span>_name, rbot[d][<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>order_target_percent(d, target<span style=color:#f92672>=</span><span style=color:#ae81ff>0.0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># rebalance those already top ranked and still there</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> (d <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> posdata <span style=color:#66d9ef>if</span> d <span style=color:#f92672>in</span> rtop):
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>log(<span style=color:#e6db74>&#39;Rebal </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> - Rank </span><span style=color:#e6db74>{:.2f}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(d<span style=color:#f92672>.</span>_name, rtop[d][<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>order_target_percent(d, target<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>perctarget)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>del</span> rtop[d]  <span style=color:#75715e># remove it, to simplify next iteration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># issue a target order for the newly top ranked stocks</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># do this last, as this will generate buy orders consuming cash</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> rtop:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>log(<span style=color:#e6db74>&#39;Enter </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> - Rank </span><span style=color:#e6db74>{:.2f}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(d<span style=color:#f92672>.</span>_name, rtop[d][<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>order_target_percent(d, target<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>perctarget)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>run</span>(args<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    args <span style=color:#f92672>=</span> parse_args(args)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cerebro <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>Cerebro()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Data feed kwargs</span>
</span></span><span style=display:flex><span>    dkwargs <span style=color:#f92672>=</span> dict(<span style=color:#f92672>**</span>eval(<span style=color:#e6db74>&#39;dict(&#39;</span> <span style=color:#f92672>+</span> args<span style=color:#f92672>.</span>dargs <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;)&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Parse from/to-date</span>
</span></span><span style=display:flex><span>    dtfmt, tmfmt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;T%H:%M:%S&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> args<span style=color:#f92672>.</span>fromdate:
</span></span><span style=display:flex><span>        fmt <span style=color:#f92672>=</span> dtfmt <span style=color:#f92672>+</span> tmfmt <span style=color:#f92672>*</span> (<span style=color:#e6db74>&#39;T&#39;</span> <span style=color:#f92672>in</span> args<span style=color:#f92672>.</span>fromdate)
</span></span><span style=display:flex><span>        dkwargs[<span style=color:#e6db74>&#39;fromdate&#39;</span>] <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>strptime(args<span style=color:#f92672>.</span>fromdate, fmt)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> args<span style=color:#f92672>.</span>todate:
</span></span><span style=display:flex><span>        fmt <span style=color:#f92672>=</span> dtfmt <span style=color:#f92672>+</span> tmfmt <span style=color:#f92672>*</span> (<span style=color:#e6db74>&#39;T&#39;</span> <span style=color:#f92672>in</span> args<span style=color:#f92672>.</span>todate)
</span></span><span style=display:flex><span>        dkwargs[<span style=color:#e6db74>&#39;todate&#39;</span>] <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>strptime(args<span style=color:#f92672>.</span>todate, fmt)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># add all the data files available in the directory datadir</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> fname <span style=color:#f92672>in</span> glob<span style=color:#f92672>.</span>glob(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(args<span style=color:#f92672>.</span>datadir, <span style=color:#e6db74>&#39;*&#39;</span>)):
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> NetPayOutData(dataname<span style=color:#f92672>=</span>fname, <span style=color:#f92672>**</span>dkwargs)
</span></span><span style=display:flex><span>        cerebro<span style=color:#f92672>.</span>adddata(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># add strategy</span>
</span></span><span style=display:flex><span>    cerebro<span style=color:#f92672>.</span>addstrategy(St, <span style=color:#f92672>**</span>eval(<span style=color:#e6db74>&#39;dict(&#39;</span> <span style=color:#f92672>+</span> args<span style=color:#f92672>.</span>strat <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;)&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># set the cash</span>
</span></span><span style=display:flex><span>    cerebro<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>setcash(args<span style=color:#f92672>.</span>cash)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cerebro<span style=color:#f92672>.</span>run()  <span style=color:#75715e># execute it all</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Basic performance evaluation ... final value ... minus starting cash</span>
</span></span><span style=display:flex><span>    pnl <span style=color:#f92672>=</span> cerebro<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>get_value() <span style=color:#f92672>-</span> args<span style=color:#f92672>.</span>cash
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#39;Profit ... or Loss: </span><span style=color:#e6db74>{:.2f}</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>format(pnl))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>parse_args</span>(pargs<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    parser <span style=color:#f92672>=</span> argparse<span style=color:#f92672>.</span>ArgumentParser(
</span></span><span style=display:flex><span>        formatter_class<span style=color:#f92672>=</span>argparse<span style=color:#f92672>.</span>ArgumentDefaultsHelpFormatter,
</span></span><span style=display:flex><span>        description<span style=color:#f92672>=</span>(<span style=color:#e6db74>&#39;Rebalancing with the Conservative Formula&#39;</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--datadir&#39;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>                        help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Directory with data files&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--dargs&#39;</span>, default<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>                        metavar<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kwargs&#39;</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kwargs in k1=v1,k2=v2 format&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Defaults for dates</span>
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--fromdate&#39;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, default<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>                        help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Date[time] in YYYY-MM-DD[THH:MM:SS] format&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--todate&#39;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, default<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>                        help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Date[time] in YYYY-MM-DD[THH:MM:SS] format&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--cerebro&#39;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, default<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>                        metavar<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kwargs&#39;</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kwargs in k1=v1,k2=v2 format&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--cash&#39;</span>, default<span style=color:#f92672>=</span><span style=color:#ae81ff>1000000.0</span>, type<span style=color:#f92672>=</span>float,
</span></span><span style=display:flex><span>                        metavar<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kwargs&#39;</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kwargs in k1=v1,k2=v2 format&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parser<span style=color:#f92672>.</span>add_argument(<span style=color:#e6db74>&#39;--strat&#39;</span>, required<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>, default<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>                        metavar<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kwargs&#39;</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;kwargs in k1=v1,k2=v2 format&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> parser<span style=color:#f92672>.</span>parse_args(pargs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    run()</span></span></code></pre></div><p>这个完整的脚本展示了如何在Backtrader中实现基于保守型公式的股票选择和再平衡策略。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/backtrader/docs/19-articles/04-beating-the-random-entry/ class="flex align-center"><img src=/backtrader/icons/backward.svg class=book-icon alt=Previous title=打败随机入场>
<span>打败随机入场</span>
</a></span><span><a href=/backtrader/docs/19-articles/06-mfi-generic/ class="flex align-center"><span>MFI 通用版</span>
<img src=/backtrader/icons/forward.svg class=book-icon alt=Next title="MFI 通用版"></a></span></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script><div class=book-comments><script src=https://utteranc.es/client.js repo=poloxue/blog issue-term=pathname theme=github-dark crossorigin=anonymous async></script></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><ul><li><a href=#数据>数据</a></li><li><a href=#策略>策略</a></li><li><a href=#策略实现>策略实现</a></li><li><a href=#运行和评估>运行和评估</a></li><li><a href=#性能评估>性能评估</a></li><li><a href=#完整脚本>完整脚本</a></li></ul></li></ul></nav></div></aside></main></body></html>
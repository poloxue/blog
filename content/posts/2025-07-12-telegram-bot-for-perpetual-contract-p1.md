---
title: "CEX 永续合约跨交易所套利 Telegram Bot（1）- 项目需求"
date: 2025-07-12T16:02:49+08:00
draft: true
comment: true
description: "本文旨在详细阐述 CEX 永续合约跨交易所套利 Telegram Bot 的项目需求。"
---

我想开发一个系统化的基于 telegram bot 实现快捷操作跨交易所永续合约的套利机器人，目标是实现永续合约的套利机会的全市场价差报警，并提供人工下单、仓位监控、盈亏分析和净值记录。

本文旨在详细阐述 CEX 永续合约跨交易所套利 Telegram Bot 的项目需求，将只描述项目需求。

> 说明：
>
> - 本文不谈任何的交互方式，后续补齐网页端和 Telegram bot 的交互设计。
>
> - 本文不谈任何的技术细节，后续补上架构、表设计等，优先跑通全部模块。

## 项目描述

该机器人将用于识别并执行跨交易所的永续合约套利机会，会同时考虑资金费率和永续合约价差，并通过 Telegram 平台提供便捷的报警、信息查询与交易操作。

> 说明：
>
> 1. 该机器人扫描的价差配对范围是选定市场的全部可配对品种，如 Binance、Bybit 和 OKX 三个交易所两两组合配对关联其所有永续合约交易对。
>
> 2. 该机器人支持多交易所两两组合套利，如同时有 OKX、Bybit、Binance、Bitget，但每个交易所只能同时有一个账号。
>
> 3. 该机器人只考虑人工低频交易，下单方式暂定只考虑支持 Market Order。
>
> 4. 该机器人暂只支持单用户使用，不考虑多 telegram 用户支持，这个还要考虑用户管理，太复杂了。
>
> 5. 该机器人是单用户机器人，交易所的 API 认证信息直接保存在配置文件中即可。

## 功能模块

机器人的功能模块包括价差配对的管理、全市场定时计算扫描与告警、交易下单与状态追踪、盈亏分析与净值统计。

![](https://cdn.delivr.net/gh/poloxue/images@2025-07/2025-07-12-telegram-bot-for-perpetual-contract-p1-01-v1.png)

价差配对关系的管理是个基础能力，从而便于实现扫描全市场价差配对，除了自动配对，还支持人工输入，目标是尽量不遗漏那些不明显的潜在机会。

开始具体拆解下每个功能模块要实现的功能。

## 用户交互

这个套利机器人系统目标是提供两个交互终端，分别是 telegram bot 和网页端。

## 配对管理

价差配对关系的管理，将说明这个关系是什么，如何管理这个关系。

### 配对关系

什么是价差配对关系呢？

价差配对交易要保持不能暴露风险敞口，实现配对品种的完成对冲，是一种中性交易策略。因而，配对的两个品种必须是相关品种。

一般而言，跨市场的相同基础币种与锚定同一法币的稳定币间的两个交易对，即可构成一个价差配对。例如，BTC/USDT.BYBIT 可以与 BTC/USDT.OKX 进行配对，也可以与 BTC/USDC.BYBIT 或 BTC/USD.BYBIT 进行配对。

具体说说描述一个价差配对关系要包括的几个要素吧。

**配对交易对**

首先是可组成价差配对的两个交易对，如 BTC/USDT.BYBIT 和 BTC/USDT.OKX。这个是最基础的要素。

当然，本项目是要实现一个永续合约的跨交易所套利，这两个交易对也必须是永续合约。

**价差公式**

价差公式，即计算两个交易对价差的公式，识别某个价差对是否有套利空间。

对于跨市场套利的这个场景，一般而言，价差公式就是 `(A-B)/B`，如 BTC/USDT.BYBIT 和 BTC/USDT.OKX，假设 A 是 BTC/USDT.BYBIT，B 是 BTC/USDT.OKX，配对价差公式: `(A-B)/B`。

有些特别情况，配对的交易对间的价格并不是完全 1:1 的关系，如 1000PEPE/USDT.BINANCE（A）和 PEPE/USDT.OKX（B），1000PEPE 价格是 PEPE * 1000 得来的，此时价差计算方式就是 `(A-1000*B)/(1000*B)`。

对于这类场景，难以通过程序自动配对，要人工介入校对配置到系统。

注：此处其实还有个资金费率差公式，因为是固定的 A-B，即合约 A 的资金费率 - 合约 B 的资金费率，因而无需配置。

**交易公式**

价差配对是为了交易而从价差中获利。为了理解为什么要交易公式，先说说如何从价差获利吧。

永续合约的价差套利的收益其实要由两个部分组成：价差回归和资金费。

**价差收益**

通过做空价差获利，如果价差 > 某阈值（手续费+滑点）> 0，则卖 A 买 B，获取价差回归的收益；

通过做多价差获利，如果价差 < -某阈值（手续费+滑点）< 0，则买 A 卖 B，获取价差回归的收益。 

**资金费率收益**

除了价差回归的收益，永续合约场景下，还有资金费率的套利，当然这个可能是正，也可能是负。

举例说明：

如果 A 合约的资金费率是 -0.1%，而 B 是 0.01%，此时的资金费率差是 -0.11%。如果是做多价差，即买 A 卖 B，就能拿到正的资金费，反之就是支出资金费给别人。

**价差回归+资金费**

实际交易要同时考虑两者，假设此时资金费率差是 -0.11%。

如果价差小于 0，则做多价差。

收益是价差回归收益 + 8 小时的资金费率套利收入（0.11%） - 交易成本。

如果价差大于 0，则做空价差。

收益是价差回归收益 - 8 小时的资金费率套利支出（0.11%） - 交易成本。

如果持有时间足够长，且资金费率收益为正，就能多次拿到资金费率收益，否则就是多次支出。这个在跨交易所永续合约价差套利的时候要考虑的。

**交易公式详解**

无论是从价差回归中获利，还是资金费率套利，完整获得这个收益的前提是，配对的合约必须是完成对冲，如 1 单位 A 合约和 1 单位 B 合约的基准币价值是相同的，则交易公式就是 A-B。

这看起来和价差公式很像，似乎可以复用价差公式。

但实际情况是，不同交易所的同一交易对的 1 个合约的价值差异很大，如 BTC/USDT.OKX（A） 的 1 合约是 0.01BTC，而 BTC/USDT.BYBIT（B） 的 1 个合约的价值就是 1 BTC。于是，实际的交易公式应该是 100 * A - B，这样才能实现完全的对冲。

在实际配对时，这个合约实际乘数是可以从合约基础信息里拿到。我们要做的就是根据这个合约乘数推算出真正的交易公式。

如果是类似 1000PEPE 和 PEPE 的场景，PEPE 的实际乘数在基础的乘数上还要再乘上 1000，这个特殊情况和价差公式一样，要人工校对整理到价差配对列表里。

---

到这里，就介绍完了价差配对关系里涉及的三个核心要素：两个永续合约交易对、价差计算公式和交易公式。

### 添加配对

添加价差配对关系有两种方式：默认匹配和人工校对匹配。

**支持价差配对默认配对规则**

默认规则如前面所言，跨市场的相同基础币种与锚定同一法币的稳定币间的两个交易对，即可构成一个价差配对。例如，BTC/USDT.BYBIT 可以与 BTC/USDT.OKX 进行配对，也可以与 BTC/USDC.BYBIT 或 BTC/USD 进行配对。

对于默认规则配对，要实现 10 分钟定时扫描不同交易所的永续合约，发现新的价差配对关系就保存到数据库，便于价差扫描和交易。这部分是有定时任务自动完成，不需人工介入。

默认匹配前，用户要设置默认配对的交易所列表，假设我的机器人要支持 4 个交易所，分别是 Binance、OKX、Bybit 和 Bitget，这个要提前配置到系统中。

**支持配置添加价差配对**

使用者要能够手动添加自定义的价差配对，如我可以添加 1000PEPE/USDT.BINANCE 和 PEPE/USDT.BINANCE 作为新的配对，但这个交易对无法通过默认匹配规则生成。

添加一个配对要填写的基础元素有：

- 交易对 A；
- 交易对 B；
- 价差公式；
- 交易公式；

系统要能接收和存储这些自定义价差配对，将其与自动识别价差配对保存在一起，便于后续的价差扫描和查询。

### 删除配对

系统需要提供机制来移除不需要的价差配对，以保持配对列表的正确性。当前想到的，有两种情况需要删除已配置到系统的价差配对。

**手动删除**，要能支持手动删除指定的价差配对，主要用于处理错配的情况，如在不同交易所可能出现同名但不同币的情况；

**退市删除**，如果某个合约退市下架，能够将从数据库中所有与这个下架合约相关的价差配对删除；

此外，还有一个合约即将下架的场景，交易所公告会发公告，这个要单独保存，以便于后续在 telegram 消息中告知用户，明确风险。

## 全市场价差扫描

系统支持定时（例如每 10 分钟）对配置交易所范围的全市场永续合约价差配对进行套利机会检测。

### 报警规则

价差配对有两个报警规则，分别针对价差和资金费率差：

- 当检测到价差超过某个设定阈值，认为存在套利机会，系统应通过 Telegram 报警。
- 当检测到资金费率大于设定阈值，认为存在套利机会，系统应通过 Telegram 报警。

报警消息中包含有：

- 套利配对名称（SymoblA-SymbolB）；
- 做多价差；
- 做空价差；
- 资金费率差；
- 即将下架时间。

报警信息的字段中，除了基本的信息外，还有 "即将下架时间"，不过它只有在价差配对中包含即将下架的交易对时，才会展示出来。

价差是通过价差公式计算而来的，但具体到这里的做多和做空价差，它们的公式是不一样的。

前面提到，价差公式（Spread Formula）可以是 `(A-B)/B`，或者是 `(A-1000*B)/(1000*B)`。但无论什么形式，都有 A、B 两个变量。

因为要尽可能算出实际交易的价差，计算做空和做多价差所需的 A、B 变量取值要基于实际的 orderbook 挂单计算实际差价，

对于 Long Spread（做多价差）：

- A 是 A_ask_price_1，按最佳卖价买入；
- B 是 B_bid_price_1，按最佳买价卖出；

对于 Short Spread（做空价差）；

- A 是 A_bid_price_1，按最佳买价卖出；
- B 是 B_ask_price_1，按最佳卖家买入；

此外，因为做多价差和做空价差是带有方向的，显示的价差数字也要考虑下，以便于查看：

**做多价差公式：** `Long Spread = -Spread`，Spread 为负时，做多价差才能获利，取负拿到做到价差的实际收益；

**做空价差公式：** `Short Spread = Spread`，价差为正即表示获利，无需取负；

简言之，只有正值的情况下，你的操作才可能赚钱，而这个价差的数值要体现出这一点。

注：要想减少价差与实际交易的误差，识别这个价差的实际可交易量，还需要考虑 OrderBook 的实际深度，这个先不加上了。

### 报警实时性

由于采用定期扫描的方式，非实时监听的价差监控。不过，定时扫描拿到的是实时价格，计算的价差触发了报警规则，应立刻无延迟推送告警消息给用户。

## 配对查看

系统支持了灵活的价差配对查看方式，可以从全市场搜索查询，或者按价差排序拉取配对列表。

### 列表查询

系统会提供价差配对查询功能，支持两种价差配对查询方式：按价差排序和模糊匹配查询。

查询结果字段：

- Pair Name，即配对名称，如果含即将下架合约，提示 "Delisting"。
- Long Spread，做多价差；
- Short Spread，做空价差；
- Funding Rate Spread，资金费率差。

**按价差排序的查询**

价差配对的排序支持 4 种方式，分别是：

- 按 Long Spread（做多价差）降序排序；
- 按 Short Spread（做空价差）降序排序；
- 按 Long Short Spread（做多做空价差的最大值）降序排序；
- 按 Funding Rate Spread （资金费率差）降序排序；

**模糊查询**

支持模糊匹配查询套利交易对品种，就是通过输入部分交易对名称来查找相关的套利配对。如输入 ETH，会显示所有与 ETH 有关的价差配对。

这个没有太多介绍的。

### 配对详情

价差配对详情是为了帮助使用者确认价差配对的最新价差和资金费率差等信息，这个详情查看可从多个渠道可触发，如报警消息、配对列表查询结果等。

一旦触发查看价差配对的详情，将会得到和报警消息类似的如下格式信息：


- 配对名称，如BTC/USDT.BINANCE-BTC/USDT.BYBIT
- 做多价差；
- 做空价差；
- 资金费率差；
- 下架时间，即 Delisting Date，如果有的话；

字段含义还是和前面描述一致，Delisting Date 只有在包含要下降合约的价差配对上才显示。

## 套利交易

有了价差监控的能力，接下来就是正式的套利交易。目标是能在价差配对详情消息上进行下单交易。

这个下单操作可以是来自于网页端，或是 Telegram bot 指令。

下单动作要提供确认机制，防止误触发。

## 套利监控

下单完成后，这个价差配对的套利就正式启动了。这个阶段的系统要提供监控套利状态的能力，查询仓位和盈亏情况。

这部分提供两个功能，分别是查询全部进行中套利，查看套利详情。

### 套利列表

进行中的套利列表，显示有如下字段：

- 配对名称；
- 未结盈亏；
- 资金费；

### 套利详情

套利详情查看某个运行中套利的详细信息，包括内容有：

- 配对名称；
- 做多价差；
- 做空价差；
- 资金费率；
- 下架时间，如果包含即将下架的合约；
- 未结盈亏；
- 已结盈亏；
  - 资金费用；
  - 手续费；
- 仓位列表，配对交易对的仓位；
  - 交易对；
  - 入场价；
  - 出场价；
  - 仓位数量；
  - 未结盈亏；

这里面包含了这个套利的详细信息，如未结盈亏、已结盈亏，包括资金费和手续费详情，还有当前的仓位信息。

## 关闭套利

系统应支持平仓正在运行的套利交易对，关闭套利头寸。

这部分操作由在套利详情消息部分提供一个按钮实现，这个标识为 `[Close Positions]`，和启动套利一样，点击按钮同样要提供确认提醒。

当套利平仓完成后，会展示整个套利的最终盈亏组成，清晰总结这次套利的最终成果。

## 历史盈亏

为了便于复盘优化交易，系统提供历史套利盈亏查看的能力。

在每次套利平仓后，套利的结果都会保存起来，便于复盘分析，就是上面关闭套利的成果展示内容。

### 历史列表

首先是查看历史套利记录，telegram 默认搜索最近的 20 条套利记录，网页端支持按日期时间范围搜索。

单个套利显示字段包括套利交易的盈亏，资金费率和手续费，开仓时间、平仓时间等。同时包含一些汇总数据，如总盈亏和套利次数、总手续费、总资金费率等等。

### 历史详情

通过历史列表可进入到某个历史的套利中，查看这笔套利的详情信息。

包含内容如：

- 配对名称；
- 已结盈亏；
  - 资金费；
  - 手续费；
- 仓位记录：
  - 交易对；
  - 入场价格；
  - 出场价格；
  - 仓位数量；
  - 已结盈亏；
  - 手续费；
  - 资金费；
  - 开仓时间；
  - 平仓时间；
- 开仓时间；
- 平仓时间；

## 每日净值

系统按日期记录每日净值，帮助用户了解资金变化情况。

网页端查看整体的净值曲线变化，网页端会提供如净值曲线图、每日盈亏、每日套利次数，直观展示每日的净值变化。

Telegram 端提供命令实现拉取净值列表，即日期和净值的对应表，粗略展示日期和净值的变化。 

这个功能是为了实现账户级别的净值观察，便于观察策略的长期有效性。

## 保证金监控

为了确保套利过程中的资金安全，本系统设计了保证金风控模块，以避免任何爆仓风险。一旦发生爆仓，不仅会导致当前套利失败，还可能引发资金不可控的连锁反应。

为此，系统引入了两项关键机制：

**维持保证金率监控：** 实时追踪各账户的维持保证金占比，当风险临近时发出预警，保障风控前置干预；

**链上应急补仓机制：** 当账户保证金率接近阈值时，系统可通过链上转账，将资金从备用地址自动或手动注入高风险账户，以避免强平。

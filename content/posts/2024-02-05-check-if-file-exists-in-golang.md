---
title: "Go 中如何检查文件是否存在？可能产生竞态条件？"
date: 2024-01-31T20:09:13+08:00
draft: true
comment: true
description: "Go 语言如何检查文件是否存在呢？"
---

Go 语言如何检查文件是否存在呢？

如果你用的是 Python，可通过 `os.path.exists` 这样的标准库函数实现。遗憾的是，Go 标准库没有提供这样直接的函数，但好在，没有直接的，却有不那么直接的方法。

本文将基于这个话题展开，介绍 Go 中如何检查文件是否存在。

另外，我们在最后还会了解到一个小注意点，即在判断文件是否存在时，如避免过程中潜在的竞态条件。

## `os.Stat` 检查文件状态

虽说 Go 标准库没有提供类似于 `os.Exists` 这样的直接检查文件是否存在的函数。这种方法的基本思路是尝试获取文件的状态，然后检查返回的错误是否指示文件不存在。

示例代码如下：

```go
_, err := os.Stat("/path/to/file")
if os.IsNotExist(err) {
    // 文件不存在
}
```

我们使用 os.Stat 获取文件状态。如果文件不存在，它会返回一个 error。通过检查 os.IsNotExist 函数检查，确定文件是否存在。

## Go1.13 后推荐使用 `errors.Is`

自 Go 1.13 起，推荐使用 `os.Stat` 和 `errors.Is` 的组合。这种方法提供了更一致和灵活的错误处理方式。

示例代码如下：

```go
if _, err := os.Stat("/path/to/whatever"); errors.Is(err, os.ErrNotExist) {
    // 文件不存在
}
```

在这个示例中，我们使用 `os.Stat` 函数来获取文件的状态，然后使用 `errors.Is` 函数来判断返回的错误是否是 `os.ErrNotExist`。

## 直接使用 Open 避免竞态条件

在这里，提一个建议，即要尽量避免检查文件是否存在，因为这种检查可能引入竞态条件。

文件的状态可能在检查和使用间发生变化。更好的做法是直接尝试打开或操作文件，并根据操作的结果来处理错误。

示例代码如下：

```go
file, err := os.Open("/path/to/file")
if err != nil {
    if errors.Is(err, os.ErrNotExist) {
        // 文件不存在
    } else {
        // 处理其他类型的错误
    }
}
```

如上代码中，你通过 `open` 直接打开一个文件，如果文件不存在，`os.Open` 将返回一个错误，就可以检查error 确定下一步的操作。

通过这种方式，我们可以避免文件打开时引入竞态条件。


## open 是原子操作？

读到这里，可能有人不禁问，为什么 open 能避免竞态条件呢？它是原子操作吗？

是的。

其实大部分的系统调用都是原子操作，操作系统会保证操作过程不受到干扰。如果操作出现问题，也会进行回滚操作.

这一点对于 Open 同样使用。

当你使用 open 打开一个文件时，系统会确保在这个操作完成前，不会有其他操作干扰，包括如检查文件是否存在、创建文件描述符、分配必要的资源等。如果文件不存在，open 调用将返回错误 error，我们以此判断操作是否成功。

## 结论

本文通过一个小小的问题：Go 语言中如何检查文件是否存，除了引出 Go 中检查文件是否存在的基本方法。同时，还介绍了文件操作时如何避免潜在的竞态条件，并了解到一个有趣的知识，Unix 系统调用是原子性操作。

最后，还是希望本文能帮助各位在 GO 语言的学习道路上起到一点微末作用。



<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Backtesting.py 由浅入深 PartI: 快速上手使用 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Backtesting.py 由浅入深 PartI: 快速上手使用"><meta itemprop=description content="本文将介绍 **Backtesting.py**，一个轻量级的 Python 的交易回测框架。"><meta itemprop=datePublished content="2024-12-18T12:15:18+08:00"><meta itemprop=dateModified content="2024-12-18T12:15:18+08:00"><meta itemprop=wordCount content="632"><meta itemprop=keywords content><meta property="og:title" content="Backtesting.py 由浅入深 PartI: 快速上手使用"><meta property="og:description" content="本文将介绍 **Backtesting.py**，一个轻量级的 Python 的交易回测框架。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2024-12-12-backtestingpy-guide-part1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-18T12:15:18+08:00"><meta property="article:modified_time" content="2024-12-18T12:15:18+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Backtesting.py 由浅入深 PartI: 快速上手使用"><meta name=twitter:description content="本文将介绍 **Backtesting.py**，一个轻量级的 Python 的交易回测框架。"><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.png alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/posts/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts>文章列表</a></li><li><a href=/tags>分类标签</a></li><li><a href=/about/>关于我</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>18</span>
<span class=rest>Dec 2024</span></div></div><div class=matter><h1 class=title>Backtesting.py 由浅入深 PartI: 快速上手使用</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#什么是-backtestingpy>什么是 Backtesting.py</a></li><li><a href=#安装>安装</a></li><li><a href=#编写第一个策略>编写第一个策略</a></li><li><a href=#参数优化>参数优化</a><ol><li><a href=#优化示例>优化示例</a></li><li><a href=#参数约束>参数约束</a></li><li><a href=#评价标准>评价标准</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></aside><p>在算法交易中，验证一个策略是否有效至关重要，但该如何验证呢？</p><p>我们可以通过模拟盘或直接实盘测试策略，但能看到的问题有限。最快捷有效的方式是基于历史数据回测（Backtesting），模拟策略在过去市场中的表现，在评估收益和风险后，再进行模拟和实盘。</p><p>那该如何回测呢？</p><p>回测的方式有很多，既可以手工测试、也可以借助 excel 或是 python 的向量计算库，如 numpy 和 pandas 进行。不过这些方式都比较原始，我们可使用市面一些现成的回测框架，不仅能尽可能避免回测中常见的问题，还能把重点放在策略的逻辑上。</p><p>本文将先介绍 <strong>Backtesting.py</strong>，一个 Python 实现轻量级、事件驱动的回测框架。之所以先介绍它，主要是它非常简单。</p><h2 id=什么是-backtestingpy>什么是 Backtesting.py</h2><p>Backtesting.py 是一个轻量级的 Python 回测框架，专注于策略回测的核心功能，适合快速实现和测试交易策略。与其他回测框架，如 VectorBT 或 Backtrader 等回测框架相比，Backtesting.py 简化了使用流程，没有过多复杂功能，自然地，它更加简单易用与高效。</p><p>Backtesting.py 内置了策略参数优化工具，可与 Pandas 数据框和 NumPy 数组兼容，易于集成。当然简单是有代价的，它的缺点是不支持多资产交易和分数股交易，这也限制了它的普适性。</p><p>让我们快速上手 Backtesting.py 的使用吧。</p><h2 id=安装>安装</h2><p>确保你已经有了 Python 环境，使用如下命令安装 backtesting.py 和 TA-Lib 两个依赖包。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install backtesting TA-Lib
</span></span></code></pre></td></tr></table></div></div><p>如果 TA-Lib 安装遇到困难，请查看 <a href=https://ta-lib.github.io/ta-lib-python/install.html>TA-Lib 安装指南</a>，或者也可以选择其他技术指标库，如 pandas-ta。</p><h2 id=编写第一个策略>编写第一个策略</h2><p>开始通过 backtesting.py 实现第一个策略，就以均线交叉策略为例。策略的规则也很简单，就是 SMA 金叉买入、死叉卖出。</p><p><strong>导入必要的模块</strong></p><p>首先，创建一个名为 <code>strategy.py</code> 的 Python 文件，开始编写我们的策略。</p><p>导入要用到的模块：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> backtesting <span style=color:#f92672>import</span> Backtest, Strategy
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> backtesting.test <span style=color:#f92672>import</span> GOOG  <span style=color:#75715e># 示例数据</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> talib
</span></span></code></pre></td></tr></table></div></div><p>简单起见，我们就用 backtestingpy 提供的样例数据 GOOG，即 Google 某段时间点的价格数据来演示。</p><p><strong>定义策略类</strong></p><p>我们定义一个名为 <code>MovingAverageCrossStrategy</code> 策略类，继承 <code>Strategy</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MovingAverageCrossStrategy</span>(Strategy):
</span></span><span style=display:flex><span>  <span style=color:#75715e># 参数</span>
</span></span><span style=display:flex><span>  fast_ma_window <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  slow_ma_window <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>init</span>(self):
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>fast_ma <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>I(talib<span style=color:#f92672>.</span>SMA, self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>Close, timeperiod<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>fast_ma_window)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>slow_ma <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>I(talib<span style=color:#f92672>.</span>SMA, self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>Close, timeperiod<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>slow_ma_window)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>next</span>(self):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>fast_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&gt;</span> self<span style=color:#f92672>.</span>slow_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>buy()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> self<span style=color:#f92672>.</span>fast_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> self<span style=color:#f92672>.</span>slow_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>close()
</span></span></code></pre></td></tr></table></div></div><p>在 Backtestingpy 中实现的策略要继承 <code>backtesting</code> 下 <code>Strategy</code> 类，实现它的两个方法：<code>init</code> 和 <code>next</code>。<code>Strategy</code> 是框架提供的基类，它规定了策略结构和生命周期，init 方法用于初始化，如指标的向量计算，<code>next</code> 中用于实现提供数据的每个 bar 的执行逻辑。</p><p>策略类上的两个变量 <code>fast_ma_window</code> 和 <code>slow_ma_window</code> 是我们定义的策略参数，代表了均线的快线和慢线的周期，默认设置为 10 和 20。它们是可配置的，在调用策略时，是可以修改这两个参数的值的。</p><p>在 <code>init</code> 初始化阶段，我们可以通过 talib 计算 SMA 均线的快慢线。数据可以通过 <code>self.data</code> 访问，指标计算用到了收盘价，即 <code>self.data.Close</code>。</p><p>在 <code>next</code> 交易逻辑阶段，只需要拿到当前的指标数据，判断是否要入场就行了，<code>self.fast_ma[-1]</code> 和 <code>self.slow_ma[-1]</code> 分别代表了最新的快线和慢线的值，当 <code>fast_ma</code> 大于 <code>slow_ma</code> 且当前没有仓位（<code>self.position.size</code> == 0) 执行买入，否则执行平仓。</p><p><strong>运行回测</strong></p><p>我们要创建 <code>Backtest</code> 实例运行回测，将 Google 数据，策略类、初始金额和交易费率传递 <code>Backtest</code> 完成实例化。</p><p>示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt <span style=color:#f92672>=</span> Backtest(GOOG, MovingAverageCrossStrategy, cash<span style=color:#f92672>=</span><span style=color:#ae81ff>10000</span>, commission<span style=color:#f92672>=</span><span style=color:#ae81ff>0.002</span>, slippge)
</span></span><span style=display:flex><span>stats <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>run()
</span></span></code></pre></td></tr></table></div></div><p>运行 <code>bt.run()</code>，得到它的返回值 <code>stats</code>，这就是我们要的回测结果。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(stats)
</span></span></code></pre></td></tr></table></div></div><p>输出评测结果，如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Start                  2004-08-19 00:00:00 <span style=color:#75715e># 开始时间</span>
</span></span><span style=display:flex><span>End                    2013-03-01 00:00:00 <span style=color:#75715e># 结束时间</span>
</span></span><span style=display:flex><span>Duration                <span style=color:#ae81ff>3116</span> days 00:00:00 <span style=color:#75715e># 总持续时间</span>
</span></span><span style=display:flex><span>Exposure Time <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                61.545624 <span style=color:#75715e># 资金暴露时间比例（%）</span>
</span></span><span style=display:flex><span>Equity Final <span style=color:#f92672>[</span>$<span style=color:#f92672>]</span>                99485.0574 <span style=color:#75715e># 最终净值（美元）</span>
</span></span><span style=display:flex><span>Equity Peak <span style=color:#f92672>[</span>$<span style=color:#f92672>]</span>                100607.2574 <span style=color:#75715e># 最高净值（美元）</span>
</span></span><span style=display:flex><span>Return <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                      894.850574 <span style=color:#75715e># 总收益率（%）</span>
</span></span><span style=display:flex><span>Buy &amp; Hold Return <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>           703.458242 <span style=color:#75715e># 买入持有策略收益率（%）</span>
</span></span><span style=display:flex><span>Return <span style=color:#f92672>(</span>Ann.<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                30.934891 <span style=color:#75715e># 年化收益率（%）</span>
</span></span><span style=display:flex><span>Volatility <span style=color:#f92672>(</span>Ann.<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>            32.215003 <span style=color:#75715e># 年化波动率（%）</span>
</span></span><span style=display:flex><span>Sharpe Ratio                      0.960263 <span style=color:#75715e># 夏普比率（风险调整收益）</span>
</span></span><span style=display:flex><span>Sortino Ratio                     2.125336 <span style=color:#75715e># 索提诺比率（下行风险调整收益）</span>
</span></span><span style=display:flex><span>Calmar Ratio                      1.497421 <span style=color:#75715e># 卡尔玛比率（收益与最大回撤之比）</span>
</span></span><span style=display:flex><span>Max. Drawdown <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>               -20.658779 <span style=color:#75715e># 最大回撤（%）</span>
</span></span><span style=display:flex><span>Avg. Drawdown <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                -3.678412 <span style=color:#75715e># 平均回撤幅度（%）</span>
</span></span><span style=display:flex><span>Max. Drawdown Duration   <span style=color:#ae81ff>584</span> days 00:00:00 <span style=color:#75715e># 最大回撤持续时间</span>
</span></span><span style=display:flex><span>Avg. Drawdown Duration    <span style=color:#ae81ff>38</span> days 00:00:00 <span style=color:#75715e># 平均回撤持续时间</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Trades                                48 # 总交易次数</span>
</span></span><span style=display:flex><span>Win Rate <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                     64.583333 <span style=color:#75715e># 胜率（%）</span>
</span></span><span style=display:flex><span>Best Trade <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                    57.11931 <span style=color:#75715e># 最佳单笔交易收益率（%）</span>
</span></span><span style=display:flex><span>Worst Trade <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                 -12.446769 <span style=color:#75715e># 最差单笔交易收益率（%）</span>
</span></span><span style=display:flex><span>Avg. Trade <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                    4.923007 <span style=color:#75715e># 平均单笔交易收益率（%）</span>
</span></span><span style=display:flex><span>Max. Trade Duration      <span style=color:#ae81ff>121</span> days 00:00:00 <span style=color:#75715e># 最长持仓时间</span>
</span></span><span style=display:flex><span>Avg. Trade Duration       <span style=color:#ae81ff>39</span> days 00:00:00 <span style=color:#75715e># 平均持仓时间</span>
</span></span><span style=display:flex><span>Profit Factor                     4.729158 <span style=color:#75715e># 盈亏比（获利交易总额与亏损交易总额之比）</span>
</span></span><span style=display:flex><span>Expectancy <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                     5.66852 <span style=color:#75715e># 期望收益率（平均每笔交易的收益率）</span>
</span></span><span style=display:flex><span>SQN                               2.643361 <span style=color:#75715e># 系统质量数（策略表现综合评分）</span>
</span></span><span style=display:flex><span>_strategy              MovingAverageCro... <span style=color:#75715e># 策略名称（移动均线交叉）</span>
</span></span><span style=display:flex><span>_equity_curve                          ... <span style=color:#75715e># 净值曲线</span>
</span></span><span style=display:flex><span>_trades                    Size  EntryB... <span style=color:#75715e># 交易详情</span>
</span></span><span style=display:flex><span>dtype: object
</span></span></code></pre></td></tr></table></div></div><p>如上是策略统计数据，有包括初始资金、最终净值、最大回撤等，还有其他评价策略表现的指标，如最大回撤、夏普比率、胜率等。</p><p>如果想查看回测的收益曲线，<code>Backtest</code> 提供方法 <code>plot</code> 查看可视化结果：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt<span style=color:#f92672>.</span>plot()
</span></span></code></pre></td></tr></table></div></div><p>运行上述代码后，你将看到：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-12/2024-12-12-backtestingpy-guide-part1-01.png alt></p><p>图表中显示了策略的收益曲线、买卖点、指标曲线和我们重点的几个交易统计数据，如最终净值、最高净值、最大回撤等。</p><p>除了使用默认参数外，我们可以在调用 <code>bt.run()</code> 修改默认参数：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt<span style=color:#f92672>.</span>run(fast_ma_window<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>, slow_ma_window<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>)
</span></span></code></pre></td></tr></table></div></div><p>在这不到 30 行代码里，我们就实现了一个简单的均线交叉策略，可见 Backtesting.py 的简洁高效。</p><h2 id=参数优化>参数优化</h2><p>在策略开发时，有一个过程非常重要，即参数优化，它是提升回测表现的重要步骤。Backtesting.py 内置了参数优化功能，能助我们快速找到最佳策略参数组合。</p><h3 id=优化示例>优化示例</h3><p>backtestingpy 默认的优化方式是将是将所有的参数组合测试一遍，以下是优化 MovingAverageCross 策略的示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt <span style=color:#f92672>=</span> Backtest(GOOG, MovingAverage, cash<span style=color:#f92672>=</span><span style=color:#ae81ff>10000</span>, commission<span style=color:#f92672>=</span><span style=color:#ae81ff>0.002</span>)
</span></span><span style=display:flex><span>stats <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>print(stats)
</span></span><span style=display:flex><span>bt<span style=color:#f92672>.</span>plot()
</span></span></code></pre></td></tr></table></div></div><p>如果通过 <code>range</code> 指定了参数范围，运行的结果就是表现最好的参数的结果。</p><p>我们可以通过打印策略实例拿到表现最好的参数。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(stats<span style=color:#f92672>.</span>_strategy)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;fast_ma_window&#34;</span>, stats<span style=color:#f92672>.</span>_strategy<span style=color:#f92672>.</span>fast_ma_window)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;slow_ma_window&#34;</span>, stats<span style=color:#f92672>.</span>_strategy<span style=color:#f92672>.</span>slow_ma_window)
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>MovingAverageCrossStrategy<span style=color:#f92672>(</span>fast_ma_window<span style=color:#f92672>=</span>5,slow_ma_window<span style=color:#f92672>=</span>20<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>fast_ma_window <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>slow_ma_window <span style=color:#ae81ff>20</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=参数约束>参数约束</h3><p>上面的优化代码有个明显的不合理，<code>slow_ma_window</code> 可能出现小于 <code>fast_ma_window</code>的情况，如 <code>fast_ma_window=20</code>、<code>slow_ma_window=10</code> 的组合，这不仅不符合策略的逻辑，且还会增加优化耗时。<code>backtestingpy</code> 的优化器提供了参数约束能力，我们可以限制 <code>fast_ma_window</code> 必须小于 <code>slow_ma_window</code>。</p><p>示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>stats <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>这将能极大提升回测优化速度。</p><h3 id=评价标准>评价标准</h3><p>优化器默认只返回了一个表现最好的参数，但这个最好是如何评价的呢？</p><p>backtestingpy 优化器的默认评价标准是 SQN，一句话表述它的含义就是，SQN 通过平均收益（高更好）、收益波动性（低更好）和交易次数（多更好）衡量策略稳健性，值越高越优质。</p><p>假设，我想修改这个评价可以吗？当然可以。<code>optimize</code> 提供了一个名为 <code>maximize</code>参数来修改评价标准。我可以将最大回撤或夏普比率作为评价标准。</p><p>将评价标准改为最大回撤：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window,
</span></span><span style=display:flex><span>    maximize<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Max. Drawdown [%]&#39;</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>将评价标准改为夏普比率：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window,
</span></span><span style=display:flex><span>    maximize<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Sharpe Ratio&#34;</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>这个评价标准默认是选设置的评价指标的最大值，如果想越小越好，可通过传递函数实现，如果选择年化波动率最小的参数组合。</p><p>示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window,
</span></span><span style=display:flex><span>    maximize<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> r: <span style=color:#f92672>-</span>r[<span style=color:#e6db74>&#34;Volatility (Ann.) [%]&#34;</span>],
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>通过 <code>maximize=lambda r: -r["Volatility (Ann.) [%]"]</code> 选择年化波动波动率最小的组合。</p><p>不过，从我平时的使用体验来看，还是默认的 SQN 的优化结果比较合理，它的评价维度更加全面。</p><h2 id=总结>总结</h2><p>本文介绍了 Backtesting.py 回测框架的快速上手使用，从策略创建、回测与参数优化。Backtesting.py 的参数优化部分还有不少的内容，后续文章再继续介绍。</p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#什么是-backtestingpy>什么是 Backtesting.py</a></li><li><a href=#安装>安装</a></li><li><a href=#编写第一个策略>编写第一个策略</a></li><li><a href=#参数优化>参数优化</a><ol><li><a href=#优化示例>优化示例</a></li><li><a href=#参数约束>参数约束</a></li><li><a href=#评价标准>评价标准</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><img style=width:85% src=https://cdn.jsdelivr.net/gh/poloxue/images@main/wechat.png><div class=utterances></div><script src=https://utteranc.es/client.js repo=poloxue/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>
<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Backtesting.py 快速上手 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Backtesting.py 快速上手"><meta itemprop=description content="本文将介绍 **Backtesting.py**，一个轻量级的 Python 的交易回测框架。"><meta itemprop=datePublished content="2024-12-18T12:15:18+08:00"><meta itemprop=dateModified content="2024-12-18T12:15:18+08:00"><meta itemprop=wordCount content="784"><meta itemprop=keywords content><meta property="og:title" content="Backtesting.py 快速上手"><meta property="og:description" content="本文将介绍 **Backtesting.py**，一个轻量级的 Python 的交易回测框架。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2024-12-12-backtestingpy-guide-part1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-18T12:15:18+08:00"><meta property="article:modified_time" content="2024-12-18T12:15:18+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Backtesting.py 快速上手"><meta name=twitter:description content="本文将介绍 **Backtesting.py**，一个轻量级的 Python 的交易回测框架。"><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script>
<script>MathJax={tex:{displayMath:[["[","]"],["$$","$$"]],inlineMath:[["(",")"],["$","$"]]}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.png alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/posts/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>文章列表</a></li><li><a href=/tags>分类标签</a></li><li><a href=/about/about>关于我</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>18</span>
<span class=rest>Dec 2024</span></div></div><div class=matter><h1 class=title>Backtesting.py 快速上手</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#什么是-backtestingpy>什么是 Backtesting.py</a></li><li><a href=#安装>安装</a></li><li><a href=#编写第一个策略>编写第一个策略</a><ol><li><a href=#导入必要的模块>导入必要的模块</a></li><li><a href=#定义策略类>定义策略类</a></li><li><a href=#交叉-crossover>交叉 crossover</a></li><li><a href=#运行回测>运行回测</a></li></ol></li><li><a href=#自定义数据>自定义数据</a><ol><li><a href=#要求格式>要求格式</a></li><li><a href=#示例适配-tushare>示例：适配 tushare</a></li></ol></li><li><a href=#回测图表保存>回测图表保存</a><ol><li><a href=#保存-html-文件>保存 HTML 文件</a></li><li><a href=#动态命名文件>动态命名文件</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></aside><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-12/2024-12-12-backtestingpy-guide-part1-00.png alt></p><p>在算法交易中，验证一个策略是否有效至关重要，但该如何验证呢？</p><p>我们可以通过模拟盘或直接实盘测试策略，但能看到的问题有限。最快捷有效的方式是基于历史数据回测（Backtesting），模拟策略在过去市场中的表现，在评估收益和风险后，再进行模拟和实盘。</p><p>那该如何回测呢？</p><p>回测的方式有很多，既可以手工测试、也可以借助 excel 或是 python 的向量计算库，如 numpy 和 pandas 进行。不过这些方式都比较原始，我们可使用市面一些现成的回测框架，不仅能尽可能避免回测中常见的问题，还能把重点放在策略的逻辑上。</p><p>本文将先介绍 <strong>Backtesting.py</strong>，一个 Python 实现轻量级、事件驱动的回测框架。之所以先介绍它，主要是它非常简单。</p><h2 id=什么是-backtestingpy>什么是 Backtesting.py</h2><p><strong>Backtesting.py</strong> 是一个轻量级的 Python 回测框架，专注于策略回测的核心功能，适合快速实现和测试交易策略。与其他回测框架，如 VectorBT 或 Backtrader 等回测框架相比，<strong>Backtesting.py</strong> 简化了使用流程，没有过多复杂功能，自然地，它更加简单易用与高效。</p><p><strong>Backtesting.py</strong> 内置了策略参数优化工具，可与 Pandas 数据框和 NumPy 数组兼容，易于集成。当然简单是有代价的，它的缺点是不支持多资产交易和分数股交易，这也限制了它的普适性，一般被用于 CTA 策略的回测。</p><p>让我们快速上手 <strong>Backtesting.py</strong> 的使用吧。</p><h2 id=安装>安装</h2><p>确保你已经有了 Python 环境，使用如下命令安装 backtesting.py 和 TA-Lib 两个依赖包。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install backtesting TA-Lib
</span></span></code></pre></td></tr></table></div></div><p>如果 TA-Lib 安装遇到困难，请查看 <a href=https://ta-lib.github.io/ta-lib-python/install.html>TA-Lib 安装指南</a>，或者也可以选择其他技术指标库，如 pandas-ta。</p><h2 id=编写第一个策略>编写第一个策略</h2><p>开始通过 backtesting.py 实现第一个策略，就以均线交叉策略为例。策略的规则也很简单，就是 SMA 金叉开仓买入、死叉平仓。暂时只考虑做多的情况。</p><h3 id=导入必要的模块>导入必要的模块</h3><p>首先，创建一个名为 <code>strategy.py</code> 的 Python 文件，开始编写我们的策略。</p><p>导入要用到的模块：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> backtesting <span style=color:#f92672>import</span> Backtest, Strategy
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> backtesting.test <span style=color:#f92672>import</span> GOOG  <span style=color:#75715e># 示例数据</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> talib
</span></span></code></pre></td></tr></table></div></div><p>简单起见，我们就用 <strong>Backtesting.py</strong> 提供的样例数据 GOOG，即 Google 某段时间点的价格数据来演示。</p><h3 id=定义策略类>定义策略类</h3><p>我们定义一个名为 <code>SMACrossStrategy</code> 策略类，继承 <code>Strategy</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SMACrossStrategy</span>(Strategy):
</span></span><span style=display:flex><span>  <span style=color:#75715e># 参数</span>
</span></span><span style=display:flex><span>  fast_ma_window <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  slow_ma_window <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>init</span>(self):
</span></span><span style=display:flex><span>    <span style=color:#75715e># 初始化阶段：计算指标</span>
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>fast_ma <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>I(talib<span style=color:#f92672>.</span>SMA, self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>Close, timeperiod<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>fast_ma_window)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>slow_ma <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>I(talib<span style=color:#f92672>.</span>SMA, self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>Close, timeperiod<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>slow_ma_window)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>next</span>(self):
</span></span><span style=display:flex><span>    <span style=color:#75715e># 交易阶段：逻辑判断和执行交易</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>fast_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&gt;</span> self<span style=color:#f92672>.</span>slow_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>position:
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>buy()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> self<span style=color:#f92672>.</span>fast_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> self<span style=color:#f92672>.</span>slow_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>is_long:
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>close()
</span></span></code></pre></td></tr></table></div></div><p>在 Backtestingpy 中实现的策略要继承 <code>backtesting</code> 下 <code>Strategy</code> 类，实现它的两个方法：<code>init</code> 和 <code>next</code>。<code>Strategy</code> 是框架提供的基类，它规定了策略结构和生命周期，init 方法用于初始化，如指标的向量计算，<code>next</code> 中用于实现提供数据的每个 bar 的执行逻辑。</p><p>策略类上的两个变量 <code>fast_ma_window</code> 和 <code>slow_ma_window</code> 是我们定义的策略参数，代表了均线的快线和慢线的周期，默认设置为 10 和 20。它们是可配置的，在调用策略时，是可以修改这两个参数的值的。</p><p>在 <code>init</code> 初始化阶段，我们可以通过 talib 计算 SMA 均线的快慢线。数据可以通过 <code>self.data</code> 访问，指标计算用到了收盘价，即 <code>self.data.Close</code>。</p><p>在 <code>next</code> 交易逻辑阶段，只需要拿到当前的指标数据，判断是否要入场就行了，<code>self.fast_ma[-1]</code> 和 <code>self.slow_ma[-1]</code> 分别代表了最新的快线和慢线的值，当 <code>fast_ma</code> 大于 <code>slow_ma</code> 且当前没有仓位（<code>not self.position</code>) 执行买入，否则执行平仓。</p><h3 id=交叉-crossover>交叉 crossover</h3><p>如果你希望策略的判断严格是金叉死叉的那一刻，不仅仅要比较 -1，即当前的指标，还有比较 -2，即上个周期的大小。</p><p>金叉，即快线 fast_ma 上穿慢线 slow_ma：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>fast_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&gt;</span> slow_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> fast_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>] <span style=color:#f92672>&lt;</span> slow_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>]
</span></span></code></pre></td></tr></table></div></div><p>死叉，即快线 fast_ma 下穿慢线 slow_ma，也就是慢线 slow_ma 上穿快线 fast_ma：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>fast_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> slow_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> fast_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>] <span style=color:#f92672>&gt;</span> slow_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>]
</span></span></code></pre></td></tr></table></div></div><p>好在 <strong>Backtesting.py</strong> 提供了一个函数，专门用于判断这种两条线交叉的场景，即 <code>backtesting.lib</code> 下 <code>crossover(s1, s2)</code> 函数，如果 <code>s1</code> 上穿 <code>s2</code>，则返回 <code>True</code>，否则返回 <code>False</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> backtesting.lib <span style=color:#f92672>import</span> crossover
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 金叉</span>
</span></span><span style=display:flex><span>crossover(fast_ma, slow_ma)
</span></span><span style=display:flex><span><span style=color:#75715e># 死叉</span>
</span></span><span style=display:flex><span>crossover(slow_ma, fast_ma)
</span></span></code></pre></td></tr></table></div></div><p>现在就简洁多了。</p><h3 id=运行回测>运行回测</h3><p>我们要创建 <code>Backtest</code> 实例运行回测，将 Google 数据，策略类、初始金额和交易费率传递 <code>Backtest</code> 完成实例化。</p><p>示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt <span style=color:#f92672>=</span> Backtest(GOOG, SMACrossStrategy, cash<span style=color:#f92672>=</span><span style=color:#ae81ff>10000</span>, commission<span style=color:#f92672>=</span><span style=color:#ae81ff>0.002</span>)
</span></span><span style=display:flex><span>stats <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>run()
</span></span></code></pre></td></tr></table></div></div><p>现在运行代码，<code>bt.run()</code> 的返回值 <code>stats</code> 就是我们要的回测结果。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(stats)
</span></span></code></pre></td></tr></table></div></div><p>输出评测结果，如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Start                  2004-08-19 00:00:00 <span style=color:#75715e># 开始时间</span>
</span></span><span style=display:flex><span>End                    2013-03-01 00:00:00 <span style=color:#75715e># 结束时间</span>
</span></span><span style=display:flex><span>Duration                <span style=color:#ae81ff>3116</span> days 00:00:00 <span style=color:#75715e># 总持续时间</span>
</span></span><span style=display:flex><span>Exposure Time <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                61.545624 <span style=color:#75715e># 资金暴露时间比例（%）</span>
</span></span><span style=display:flex><span>Equity Final <span style=color:#f92672>[</span>$<span style=color:#f92672>]</span>                99485.0574 <span style=color:#75715e># 最终净值（美元）</span>
</span></span><span style=display:flex><span>Equity Peak <span style=color:#f92672>[</span>$<span style=color:#f92672>]</span>                100607.2574 <span style=color:#75715e># 最高净值（美元）</span>
</span></span><span style=display:flex><span>Return <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                      894.850574 <span style=color:#75715e># 总收益率（%）</span>
</span></span><span style=display:flex><span>Buy &amp; Hold Return <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>           703.458242 <span style=color:#75715e># 买入持有策略收益率（%）</span>
</span></span><span style=display:flex><span>Return <span style=color:#f92672>(</span>Ann.<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                30.934891 <span style=color:#75715e># 年化收益率（%）</span>
</span></span><span style=display:flex><span>Volatility <span style=color:#f92672>(</span>Ann.<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>            32.215003 <span style=color:#75715e># 年化波动率（%）</span>
</span></span><span style=display:flex><span>Sharpe Ratio                      0.960263 <span style=color:#75715e># 夏普比率（风险调整收益）</span>
</span></span><span style=display:flex><span>Sortino Ratio                     2.125336 <span style=color:#75715e># 索提诺比率（下行风险调整收益）</span>
</span></span><span style=display:flex><span>Calmar Ratio                      1.497421 <span style=color:#75715e># 卡尔玛比率（收益与最大回撤之比）</span>
</span></span><span style=display:flex><span>Max. Drawdown <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>               -20.658779 <span style=color:#75715e># 最大回撤（%）</span>
</span></span><span style=display:flex><span>Avg. Drawdown <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                -3.678412 <span style=color:#75715e># 平均回撤幅度（%）</span>
</span></span><span style=display:flex><span>Max. Drawdown Duration   <span style=color:#ae81ff>584</span> days 00:00:00 <span style=color:#75715e># 最大回撤持续时间</span>
</span></span><span style=display:flex><span>Avg. Drawdown Duration    <span style=color:#ae81ff>38</span> days 00:00:00 <span style=color:#75715e># 平均回撤持续时间</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Trades                                48 # 总交易次数</span>
</span></span><span style=display:flex><span>Win Rate <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                     64.583333 <span style=color:#75715e># 胜率（%）</span>
</span></span><span style=display:flex><span>Best Trade <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                    57.11931 <span style=color:#75715e># 最佳单笔交易收益率（%）</span>
</span></span><span style=display:flex><span>Worst Trade <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                 -12.446769 <span style=color:#75715e># 最差单笔交易收益率（%）</span>
</span></span><span style=display:flex><span>Avg. Trade <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                    4.923007 <span style=color:#75715e># 平均单笔交易收益率（%）</span>
</span></span><span style=display:flex><span>Max. Trade Duration      <span style=color:#ae81ff>121</span> days 00:00:00 <span style=color:#75715e># 最长持仓时间</span>
</span></span><span style=display:flex><span>Avg. Trade Duration       <span style=color:#ae81ff>39</span> days 00:00:00 <span style=color:#75715e># 平均持仓时间</span>
</span></span><span style=display:flex><span>Profit Factor                     4.729158 <span style=color:#75715e># 盈亏比（获利交易总额与亏损交易总额之比）</span>
</span></span><span style=display:flex><span>Expectancy <span style=color:#f92672>[</span>%<span style=color:#f92672>]</span>                     5.66852 <span style=color:#75715e># 期望收益率（平均每笔交易的收益率）</span>
</span></span><span style=display:flex><span>SQN                               2.643361 <span style=color:#75715e># 系统质量数（策略表现综合评分）</span>
</span></span><span style=display:flex><span>_strategy                 SMACrossStrategy... <span style=color:#75715e># 策略名称（移动均线交叉）</span>
</span></span><span style=display:flex><span>_equity_curve                          ... <span style=color:#75715e># 净值曲线</span>
</span></span><span style=display:flex><span>_trades                    Size  EntryB... <span style=color:#75715e># 交易详情</span>
</span></span><span style=display:flex><span>dtype: object
</span></span></code></pre></td></tr></table></div></div><p>如上是策略统计数据，有包括初始资金、最终净值、最大回撤等，还有其他评价策略表现的指标，如最大回撤、夏普比率、胜率等。</p><p>如果想查看回测的收益曲线，<code>Backtest</code> 提供方法 <code>plot</code> 查看可视化结果：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt<span style=color:#f92672>.</span>plot()
</span></span></code></pre></td></tr></table></div></div><p>运行上述代码后，你将看到：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-12/2024-12-12-backtestingpy-guide-part1-01.png alt></p><p>图表中显示了策略的收益曲线、买卖点、指标曲线和我们重点的几个交易统计数据，如最终净值、最高净值、最大回撤等。</p><p>除了使用默认参数外，我们可以在调用 <code>bt.run()</code> 修改默认参数：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt<span style=color:#f92672>.</span>run(fast_ma_window<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>, slow_ma_window<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span>)
</span></span></code></pre></td></tr></table></div></div><p>在这不到 30 行代码里，我们就实现了一个简单的均线交叉策略，可见 <strong>Backtesting.py</strong> 的简洁高效。</p><h2 id=自定义数据>自定义数据</h2><p><strong>Backtesting.py</strong> 是允许使用自定义数据的。</p><h3 id=要求格式>要求格式</h3><p>数据要求是 <code>pandas.DataFrame</code>，且满足按时间升序排列，时间为 DataFrame 的索引，同时数据列至少包含 <code>Open</code>、<code>High</code>、<code>Low</code>、<code>Close</code>、<code>Volume</code> 五个字段即可。</p><p>查看样例数据格式；</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(GOOG)
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>              Open    High     Low   Close    Volume
</span></span><span style=display:flex><span>2004-08-19  100.00  104.06   95.96  100.34  <span style=color:#ae81ff>22351900</span>
</span></span><span style=display:flex><span>2004-08-20  101.01  109.08  100.50  108.31  <span style=color:#ae81ff>11428600</span>
</span></span><span style=display:flex><span>2004-08-23  110.75  113.48  109.05  109.40   <span style=color:#ae81ff>9137200</span>
</span></span><span style=display:flex><span>2004-08-24  111.24  111.60  103.57  104.87   <span style=color:#ae81ff>7631300</span>
</span></span><span style=display:flex><span>2004-08-25  104.96  108.00  103.88  106.00   <span style=color:#ae81ff>4598900</span>
</span></span><span style=display:flex><span>...            ...     ...     ...     ...       ...
</span></span><span style=display:flex><span>2013-02-25  802.30  808.41  790.49  790.77   <span style=color:#ae81ff>2303900</span>
</span></span><span style=display:flex><span>2013-02-26  795.00  795.95  784.40  790.13   <span style=color:#ae81ff>2202500</span>
</span></span><span style=display:flex><span>2013-02-27  794.80  804.75  791.11  799.78   <span style=color:#ae81ff>2026100</span>
</span></span><span style=display:flex><span>2013-02-28  801.10  806.99  801.03  801.20   <span style=color:#ae81ff>2265800</span>
</span></span><span style=display:flex><span>2013-03-01  797.80  807.14  796.15  806.19   <span style=color:#ae81ff>2175400</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=示例适配-tushare>示例：适配 tushare</h3><p>演示下将 tushare 数据转为 <strong>Backtesting.py</strong> 支持的格式吧。从 tushare 获取南华商品期货黄金指数的价格。</p><p>示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>pro <span style=color:#f92672>=</span> ts<span style=color:#f92672>.</span>pro_api()
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pro<span style=color:#f92672>.</span>index_daily(ts_code<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;AU.NH&#34;</span>, start_date<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;2024-01-01&#34;</span>)
</span></span><span style=display:flex><span>df[<span style=color:#e6db74>&#34;trade_date&#34;</span>] <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>to_datetime(df[<span style=color:#e6db74>&#34;trade_date&#34;</span>])
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>set_index(<span style=color:#e6db74>&#34;trade_date&#34;</span>, inplace<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>index<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Datetime&#34;</span>
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>sort_index(inplace<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>rename(
</span></span><span style=display:flex><span>    columns<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;open&#34;</span>: <span style=color:#e6db74>&#34;Open&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;high&#34;</span>: <span style=color:#e6db74>&#34;High&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;low&#34;</span>: <span style=color:#e6db74>&#34;Low&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;close&#34;</span>: <span style=color:#e6db74>&#34;Close&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;vol&#34;</span>: <span style=color:#e6db74>&#34;Volume&#34;</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    inplace<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[[<span style=color:#e6db74>&#34;Open&#34;</span>, <span style=color:#e6db74>&#34;High&#34;</span>, <span style=color:#e6db74>&#34;Low&#34;</span>, <span style=color:#e6db74>&#34;Close&#34;</span>, <span style=color:#e6db74>&#34;Volume&#34;</span>]]
</span></span><span style=display:flex><span>print(df<span style=color:#f92672>.</span>head())
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>            Open       High        Low      Close    Volume
</span></span><span style=display:flex><span>Datetime
</span></span><span style=display:flex><span>2024-01-02  1805.2399  1813.4864  1802.4661  1811.6872   95373.0
</span></span><span style=display:flex><span>2024-01-03  1810.1883  1812.0918  1803.8779  1809.4987  187356.0
</span></span><span style=display:flex><span>2024-01-04  1799.2201  1804.1197  1792.3877  1802.4116  243384.0
</span></span><span style=display:flex><span>2024-01-05  1802.8461  1808.0885  1799.5808  1805.1527  142594.0
</span></span><span style=display:flex><span>2024-01-08  1801.9185  1813.1337  1796.4979  1802.6821  295652.0
</span></span></code></pre></td></tr></table></div></div><h2 id=回测图表保存>回测图表保存</h2><p><strong>Backtesting.py</strong> 提供了保存回测图表的功能，便于后续分析。</p><h3 id=保存-html-文件>保存 HTML 文件</h3><p>我们上面运行回测时，<strong>Backtesting.py</strong> 会在当前目录下自动生成一个 HTML 文件，即上面展示的回测图表。</p><p>默认的文件名称是 &ldquo;策略类名.html&rdquo;，。</p><p>示例：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SMACrossStrategy.html
</span></span></code></pre></td></tr></table></div></div><p>如果是参数优化得到的结果，文件名会带上参数：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>SMACrossStrategy(fast_ma_window<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>,slow_ma_window<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>)<span style=color:#f92672>.</span>html
</span></span></code></pre></td></tr></table></div></div><p>这个名称在调用 <code>bt.plot</code> 时可以修改。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt<span style=color:#f92672>.</span>plot(filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;results/plot.html&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><p>上述代码将回测结果保存在 <code>results</code> 目录下。如果目录不存在，需要提前创建：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p results
</span></span></code></pre></td></tr></table></div></div><h3 id=动态命名文件>动态命名文件</h3><p>我们也可以动态设置文件名以区分不同的参数组合。例如：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>fast <span style=color:#f92672>=</span>  stats<span style=color:#f92672>.</span>_strategy<span style=color:#f92672>.</span>fast_ma_window
</span></span><span style=display:flex><span>slow <span style=color:#f92672>=</span> stats<span style=color:#f92672>.</span>_strategy<span style=color:#f92672>.</span>slow_ma_window
</span></span><span style=display:flex><span>bt<span style=color:#f92672>.</span>plot(
</span></span><span style=display:flex><span>  filename<span style=color:#f92672>=</span><span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;results/fast</span><span style=color:#e6db74>{</span>fast<span style=color:#e6db74>}</span><span style=color:#e6db74>_slow</span><span style=color:#e6db74>{</span>slow<span style=color:#e6db74>}</span><span style=color:#e6db74>.html&#39;</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>这将保存文件名如 <code>fast10_slow20.html</code> 的 HTML 文件，方便管理批量的回测结果。</p><h2 id=总结>总结</h2><p>本文介绍了 <strong>Backtesting.py</strong> 回测框架的快速上手使用，从策略创建、回测与结果保存。下篇文章介绍 <strong>Backtesting.py</strong> 的参数优化部分，这是策略开发是非常重要的一个点。</p><div>本文来源于 <a href=https://www.poloxue.com>POLOXUE's BLOG</a>，地址： <a href=https://www.poloxue.com/posts/2024-12-12-backtestingpy-guide-part1/>Backtesting.py 快速上手</a></div></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#什么是-backtestingpy>什么是 Backtesting.py</a></li><li><a href=#安装>安装</a></li><li><a href=#编写第一个策略>编写第一个策略</a><ol><li><a href=#导入必要的模块>导入必要的模块</a></li><li><a href=#定义策略类>定义策略类</a></li><li><a href=#交叉-crossover>交叉 crossover</a></li><li><a href=#运行回测>运行回测</a></li></ol></li><li><a href=#自定义数据>自定义数据</a><ol><li><a href=#要求格式>要求格式</a></li><li><a href=#示例适配-tushare>示例：适配 tushare</a></li></ol></li><li><a href=#回测图表保存>回测图表保存</a><ol><li><a href=#保存-html-文件>保存 HTML 文件</a></li><li><a href=#动态命名文件>动态命名文件</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><img style=width:85% src=https://cdn.jsdelivr.net/gh/poloxue/images@main/wechat.png><div class=utterances></div><script src=https://utteranc.es/client.js repo=poloxue/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>
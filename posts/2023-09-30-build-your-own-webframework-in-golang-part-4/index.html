<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>从头构建 Go Web 框架（四）：第三方路由集成 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="从头构建 Go Web 框架（四）：第三方路由集成"><meta itemprop=description content="本系列文章写于 2014 年，相较于 golang 极短的发展历程，这已经是古董级别的一篇文章了，但 web 框架思想概念依然有效。希望通过翻译这个系列文章，能让大家都现有 Go Web 框架有更深的认识。
本文是 &ldquo;构建属于自己的 Web 框架&rdquo; 系列文章中的第四篇，将介绍如何在 Go 中使用三方路由。
第 1 部分：简介，Build Your Own Web Framework In Go 第 2 部分：Go 中间件：最佳实践和示例，Part 2: Middlewares in Go: Best practices and examples 第 3 部分：中间件数据共享，Part 3: Share Values Between Middlewares 第 4 部分：第三方路由，Part 4: Guide to 3rd Party Routers in Golang 第 5 部分：使用 MongoDB 实现 JSON-API，How to implement JSON-API standard in MongoDB and Go 基于 Go 标准库 net/http，已经足够写出一个 Web 应用。但不足的是，它提供的路由能力 http."><meta itemprop=datePublished content="2023-10-09T13:35:05+08:00"><meta itemprop=dateModified content="2023-10-09T13:35:05+08:00"><meta itemprop=wordCount content="504"><meta itemprop=keywords content="Golang,Web,"><meta property="og:title" content="从头构建 Go Web 框架（四）：第三方路由集成"><meta property="og:description" content="本系列文章写于 2014 年，相较于 golang 极短的发展历程，这已经是古董级别的一篇文章了，但 web 框架思想概念依然有效。希望通过翻译这个系列文章，能让大家都现有 Go Web 框架有更深的认识。
本文是 &ldquo;构建属于自己的 Web 框架&rdquo; 系列文章中的第四篇，将介绍如何在 Go 中使用三方路由。
第 1 部分：简介，Build Your Own Web Framework In Go 第 2 部分：Go 中间件：最佳实践和示例，Part 2: Middlewares in Go: Best practices and examples 第 3 部分：中间件数据共享，Part 3: Share Values Between Middlewares 第 4 部分：第三方路由，Part 4: Guide to 3rd Party Routers in Golang 第 5 部分：使用 MongoDB 实现 JSON-API，How to implement JSON-API standard in MongoDB and Go 基于 Go 标准库 net/http，已经足够写出一个 Web 应用。但不足的是，它提供的路由能力 http."><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2023-09-30-build-your-own-webframework-in-golang-part-4/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-09T13:35:05+08:00"><meta property="article:modified_time" content="2023-10-09T13:35:05+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="从头构建 Go Web 框架（四）：第三方路由集成"><meta name=twitter:description content="本系列文章写于 2014 年，相较于 golang 极短的发展历程，这已经是古董级别的一篇文章了，但 web 框架思想概念依然有效。希望通过翻译这个系列文章，能让大家都现有 Go Web 框架有更深的认识。
本文是 &ldquo;构建属于自己的 Web 框架&rdquo; 系列文章中的第四篇，将介绍如何在 Go 中使用三方路由。
第 1 部分：简介，Build Your Own Web Framework In Go 第 2 部分：Go 中间件：最佳实践和示例，Part 2: Middlewares in Go: Best practices and examples 第 3 部分：中间件数据共享，Part 3: Share Values Between Middlewares 第 4 部分：第三方路由，Part 4: Guide to 3rd Party Routers in Golang 第 5 部分：使用 MongoDB 实现 JSON-API，How to implement JSON-API standard in MongoDB and Go 基于 Go 标准库 net/http，已经足够写出一个 Web 应用。但不足的是，它提供的路由能力 http."><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script>
<script>MathJax={tex:{displayMath:[["[","]"],["$$","$$"]],inlineMath:[["(",")"],["$","$"]]}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.png alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/posts/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>文章列表</a></li><li><a href=/tags>分类标签</a></li><li><a href=/about/about>关于我</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>09</span>
<span class=rest>Oct 2023</span></div></div><div class=matter><h1 class=title>从头构建 Go Web 框架（四）：第三方路由集成</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#gorillamux>gorilla/mux</a></li><li><a href=#httprouter>httprouter</a></li><li><a href=#pat>Pat</a></li><li><a href=#如何选择>如何选择？</a></li><li><a href=#集成-httprouter>集成 httprouter</a></li><li><a href=#总结>总结</a></li></ol></nav></aside><blockquote><p>本系列文章写于 2014 年，相较于 golang 极短的发展历程，这已经是古董级别的一篇文章了，但 web 框架思想概念依然有效。希望通过翻译这个系列文章，能让大家都现有 Go Web 框架有更深的认识。</p></blockquote><p>本文是 &ldquo;构建属于自己的 Web 框架&rdquo; 系列文章中的第四篇，将介绍如何在 Go 中使用三方路由。</p><ul><li><a href=https://www.poloxue.com/posts/2021-10-23-build-your-own-webframework-in-golang>第 1 部分：简介</a>，<a href=https://www.nicolasmerouze.com/build-web-framework-golang>Build Your Own Web Framework In Go</a></li><li><a href=https://www.poloxue.com/posts/2021-10-28-build-your-own-webframework-in-golang-part-2>第 2 部分：Go 中间件：最佳实践和示例</a>，<a href=https://nicolasmerouze.notion.site/Part-2-Middlewares-in-Go-Best-practices-and-examples-32f41ae0e21b435c86cf9dd38bf0ff65>Part 2: Middlewares in Go: Best practices and examples</a></li><li><a href=https://www.poloxue.com/posts/2023-09-30-build-your-own-webframework-in-golang-part-3>第 3 部分：中间件数据共享</a>，<a href=https://nicolasmerouze.notion.site/Part-3-Share-Values-Between-Middlewares-dca6f9448a0c4be68b0da30137c38875>Part 3: Share Values Between Middlewares</a></li><li><a href=https://www.poloxue.com/posts/2023-10-09-build-your-own-webframework-in-golang-part-4>第 4 部分：第三方路由</a>，<a href=https://nicolasmerouze.notion.site/Part-4-Guide-to-3rd-Party-Routers-in-Go-8ddcca5c360b4539a601ae383c9d7e5d>Part 4: Guide to 3rd Party Routers in Golang</a></li><li><a href>第 5 部分：使用 MongoDB 实现 JSON-API</a>，<a href=https://nicolasmerouze.notion.site/Part-5-How-to-implement-JSON-API-standard-in-MongoDB-and-Go-a3daeead140846e4a6ae1e3c01b47f52>How to implement JSON-API standard in MongoDB and Go</a></li></ul><p>基于 Go 标准库 <code>net/http</code>，已经足够写出一个 Web 应用。但不足的是，它提供的路由能力 <code>http.Handle(pattern, handler)</code> 还是过于单一，只能实现一些静态路由。</p><p>这就是为什么我们需要一个优秀的三方路由。</p><p>然如此多的第三方路由，都有各自的特点，究竟该如何选择？</p><p>当接触一门新的编程语言，如果有 10 个不同库实现相同能力，将很难了解什么是最佳实践。我们希望有一种速度快、内存高效且易于使用的 router。</p><p>如下是我认为 Go 中最常用的 router，将从执行速度、内存消耗等维度对比。</p><h2 id=gorillamux>gorilla/mux</h2><p><a href=https://github.com/gorilla/mux>gorilla/mux</a> 是一款成熟的 router，同时也是 Go 中最流行的三方路由。它有着丰富的功能，缺点是速度慢且内存消耗验证。</p><p>且，gorilla/mux 支持正则 URL 参数约束，如下所示：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>NewRouter</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/teas/{category}/&#34;</span>, <span style=color:#a6e22e>TeasCategoryHandler</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/teas/{category}/{id:[0-9]+}&#34;</span>, <span style=color:#a6e22e>TeaHandler</span>)
</span></span></code></pre></td></tr></table></div></div><p>HTTP 方法配置路由，如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Methods</span>(<span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;HEAD&#34;</span>).<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/teas/{category}/&#34;</span>, <span style=color:#a6e22e>TeasCategoryHandler</span>)
</span></span></code></pre></td></tr></table></div></div><p>和其他路由的不同，gorilla/mux 有丰富的内置匹配规则，支持如 host（如子域名）、前缀、协议（http、https 等）、HTTP 头、查询参数。如果这些还不能满足你，通过自定义方式，如下方式：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Proto      string // &#34;HTTP/1.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ProtoMajor int    // 1
</span></span></span><span style=display:flex><span><span style=color:#75715e>// ProtoMinor int    // 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>MatcherFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>rm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RouteMatch</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ProtoMajor</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><p>在 Handler 函数中，通过 <code>mux.Vars(request)</code> 可获取 URL 参数，它和上文介绍的 gorilla/context 类似。</p><p>代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>myHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>vars</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>Vars</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>category</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>vars</span>[<span style=color:#e6db74>&#34;category&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这个方案的优势是，它与 <code>http.Handler</code> 接口兼容。这点其实非常重要，因为我们的应用越多，共享 handler 和 middleware 的可能越大，就更加需要遵循一定的规则。</p><p>优势：功能强大，轻松创建复杂的路由规则，且与 <code>http.Handler</code> 兼容。
劣势：速度慢且内存消耗严重，如果看中速度的话，它不适合你。</p><h2 id=httprouter>httprouter</h2><p>httprouter, 号称 &ldquo;最快的 router&rdquo;。httprouter 的作者对不同的 router 做了基准测试，具体查看 <a href=https://github.com/julienschmidt/go-http-routing-benchmark>go-http-routing-benchmark</a>。</p><p>httprouter 比 gorilla/mux 简单，但它不支持约束和正则，对于 REST API 而言，这个缺点的影响不大，但如果希望创建复杂的路由，这个简化设计就会大大限制它的适用范围。</p><p>还有，它与 <code>http.Handler</code> 不兼容，它定义了一个新的 interface，拥有三个参数，其中第三个参数用于访问 URL 参数。</p><p>示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Index</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>_</span> <span style=color:#a6e22e>httprouter</span>.<span style=color:#a6e22e>Params</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Welcome!\n&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Hello</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>ps</span> <span style=color:#a6e22e>httprouter</span>.<span style=color:#a6e22e>Params</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;hello, %s!\n&#34;</span>, <span style=color:#a6e22e>ps</span>.<span style=color:#a6e22e>ByName</span>(<span style=color:#e6db74>&#34;name&#34;</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>router</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httprouter</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>Index</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/hello/:name&#34;</span>, <span style=color:#a6e22e>Hello</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>但这个问题也容易解决，将 URL 参数注入 context 中，实现在标准 interface <code>http.Handler</code> 和 httprouter 接口间的转换。这种方式会损失一些性能，但依然是一个 faster router。</p><p>如何实现？后续具体实现时介绍。</p><p>优点：快。</p><p>缺点：与 http.Handler 不兼容。</p><h2 id=pat>Pat</h2><p><a href=https://github.com/bmizerany/pat>Pat</a> 也是一个流行且简单的 router。它与 <code>http.Handler</code> 完全兼容。但它不是用 context 存储 URL 参数，而是将参数保存在 request 中，通过 <code>r.URL.Query()</code> 获取。</p><p>示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Hello</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;hello, %s!\n&#34;</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>Query</span>().<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;:name&#34;</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pat</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;/hello/:name&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span>(<span style=color:#a6e22e>Hello</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>缺点是 <code>r.URL.Query()</code> 每次都是从原始 querystring 中解析参数，这是对性能不友好的行为，如果包含经过多个中间件，这对性能的影响将更大。速度方面，pat 相较于 httprouter 要慢十倍。</p><p>优势: 与 <code>http.Handle</code> 兼容.</p><p>劣势: 有点慢.</p><h2 id=如何选择>如何选择？</h2><p>如果是传统 Web 应用，服务端进行页面渲染，因为需要复杂的路由，gorilla/mux 是最好的选择。如果是 REST API，httprouter 更加适用，因而，我们将基于 httprouter 完善我们的程序。</p><h2 id=集成-httprouter>集成 httprouter</h2><p>由于 httprouter 与 http.Handler 不兼容，要进行一些调整。实现方案，将中间件栈（http.Handler）包裹，从而实现 httprouter.Handler 接口。</p><p>代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>wrapHandler</span>(<span style=color:#a6e22e>h</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span>) <span style=color:#a6e22e>httprouter</span>.<span style=color:#a6e22e>Handle</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>ps</span> <span style=color:#a6e22e>httprouter</span>.<span style=color:#a6e22e>Params</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>r</span>, <span style=color:#e6db74>&#34;params&#34;</span>, <span style=color:#a6e22e>ps</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>db</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;postgres&#34;</span>, <span style=color:#e6db74>&#34;...&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>appC</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>appContext</span>{<span style=color:#a6e22e>db</span>}
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>commonHandlers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alice</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>ClearHandler</span>, <span style=color:#a6e22e>loggingHandler</span>, <span style=color:#a6e22e>recoverHandler</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>router</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httprouter</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/admin&#34;</span>, <span style=color:#a6e22e>wrapHandler</span>(<span style=color:#a6e22e>commonHandlers</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>appC</span>.<span style=color:#a6e22e>authHandler</span>).<span style=color:#a6e22e>ThenFunc</span>(<span style=color:#a6e22e>appC</span>.<span style=color:#a6e22e>adminHandler</span>)))
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/about&#34;</span>, <span style=color:#a6e22e>wrapHandler</span>(<span style=color:#a6e22e>commonHandlers</span>.<span style=color:#a6e22e>ThenFunc</span>(<span style=color:#a6e22e>aboutHandler</span>)))
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>wrapHandler</span>(<span style=color:#a6e22e>commonHandlers</span>.<span style=color:#a6e22e>ThenFunc</span>(<span style=color:#a6e22e>indexHandler</span>)))
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>, <span style=color:#a6e22e>router</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>通过 <code>wrapHandler</code> 实现将中间件 <code>http.Handler</code> 和 <code>httprouter.Hande</code> 间的转化，从而实现拥有 httprouter 的良好性能的同时，也能与http.Handler的兼容。</p><p>接下来，演示如何在 handler 使用 URL 参数。</p><p>创建路由：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/teas/:id&#34;</span>, <span style=color:#a6e22e>wrapHandler</span>(<span style=color:#a6e22e>commonHandlers</span>.<span style=color:#a6e22e>ThenFunc</span>(<span style=color:#a6e22e>appC</span>.<span style=color:#a6e22e>teaHandler</span>)))
</span></span></code></pre></td></tr></table></div></div><p>如下代码，创建 <code>teaHandler</code>，其中将通过 <code>id</code> 从数据库中查询数据。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>appContext</span>) <span style=color:#a6e22e>teaHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>r</span>, <span style=color:#e6db74>&#34;params&#34;</span>).(<span style=color:#a6e22e>httprouter</span>.<span style=color:#a6e22e>Params</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tea</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getTea</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>ByName</span>(<span style=color:#e6db74>&#34;id&#34;</span>))
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>tea</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结</h2><p>Go 中的不同 router 的性能差异很大，功能也有差异。最快的路由器并不一定适合你的项目。httprouter 非常适合于 REST API 这样的简单路由，gorilla/mux 更适合具传统的 web 应用。</p><p>对于不兼容与 <code>http.Handler</code> 的路由实现，可通过类似 <code>wrapHandler</code> 实现兼容。</p><p>最后，不同 router 方案存储 URL 参数的方式不同，常见的两种方式： <code>r.URL.Query()</code> 和 context。在实际使用时，要注意规范一致。</p><p>我的博文：<a href=https://www.poloxue.com/posts/2023-09-30-build-your-own-webframework-in-golang-part-4/>从头构建 Go Web 框架（四）：第三方路由集成</a>
，原文地址: <a href=https://www.poloxue.com/posts/2023-09-30-build-your-own-webframework-in-golang-part-4/>Part 4: Guide to 3rd Party Routers in Go</a></p><div>本文来源于 <a href=https://www.poloxue.com>POLOXUE's BLOG</a>，地址： <a href=https://www.poloxue.com/posts/2023-09-30-build-your-own-webframework-in-golang-part-4/>从头构建 Go Web 框架（四）：第三方路由集成</a></div></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#gorillamux>gorilla/mux</a></li><li><a href=#httprouter>httprouter</a></li><li><a href=#pat>Pat</a></li><li><a href=#如何选择>如何选择？</a></li><li><a href=#集成-httprouter>集成 httprouter</a></li><li><a href=#总结>总结</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags><ul class=flat><li class=tag-li><a href=/tags/golang>Golang</a></li><li class=tag-li><a href=/tags/web>Web</a></li></ul></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><img style=width:85% src=https://cdn.jsdelivr.net/gh/poloxue/images@main/wechat.png><div class=utterances></div><script src=https://utteranc.es/client.js repo=poloxue/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2023 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>
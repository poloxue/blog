<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>我用 Python 为 iTerm2 开发一个类似 tmuxifier 的工具 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="我用 Python 为 iTerm2 开发一个类似 tmuxifier 的工具"><meta itemprop=description content="我在思考如何提高终端工作效率时，想到了在 iTerm2 中实现一个类似于 tmuxifier 布局管理工具。如果你不了解 tmuxifier，简单来说，它是 tmux 的布局管理工具。"><meta itemprop=datePublished content="2024-02-25T08:00:00+08:00"><meta itemprop=dateModified content="2024-02-25T08:00:00+08:00"><meta itemprop=wordCount content="327"><meta itemprop=keywords content><meta property="og:title" content="我用 Python 为 iTerm2 开发一个类似 tmuxifier 的工具"><meta property="og:description" content="我在思考如何提高终端工作效率时，想到了在 iTerm2 中实现一个类似于 tmuxifier 布局管理工具。如果你不了解 tmuxifier，简单来说，它是 tmux 的布局管理工具。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2024-02-25-build-an-itermifier/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-25T08:00:00+08:00"><meta property="article:modified_time" content="2024-02-25T08:00:00+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="我用 Python 为 iTerm2 开发一个类似 tmuxifier 的工具"><meta name=twitter:description content="我在思考如何提高终端工作效率时，想到了在 iTerm2 中实现一个类似于 tmuxifier 布局管理工具。如果你不了解 tmuxifier，简单来说，它是 tmux 的布局管理工具。"><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.png alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/posts/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>文章列表</a></li><li><a href=/tags>分类标签</a></li><li><a href=/about/about>关于我</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>25</span>
<span class=rest>Feb 2024</span></div></div><div class=matter><h1 class=title>我用 Python 为 iTerm2 开发一个类似 tmuxifier 的工具</h1></div></div><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-02/2024-02-26-build-an-itermifier-01.png alt></p><p>我在思考如何提高终端工作效率时，想到了是否能给予 iTerm2 实现一个类似于 tmuxifier 布局管理工具。如果你不了解 tmuxifier，简单来说，它是 tmux 的布局管理工具。</p><p>它的作用如下所示：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-02/2024-02-26-build-an-itermifier-02-v1.gif alt></p><p>想到不如做到！</p><p>这篇文章记录了我从零开始，一步步构建这个工具的过程。</p><h2 id=设计阶段>设计阶段</h2><p>正式开发这个工具前，先调研下可行性还是很重要的。</p><h3 id=iterm2-支持-python-api>iTerm2 支持 Python API</h3><p>首先，我了解到 iTerm2 支持通过 Python 脚本控制终端，这为我开发这样一个工具提供了可能性。</p><p>它提供大量的 API，如更换背景、创建窗格，切换 Tab 等都是支持的。具体可查看文档：<a href=https://iterm2.com/python-api/>Python-API</a>。</p><h3 id=设置开发环境>设置开发环境</h3><p>为了顺利开始，首先确保我的 iTerm2 （3.4.23）支持 Python API，还有我的机器上配置了 Python 环境。</p><p>接着，我安装了 iTerm2 的 Python API 所需的库。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pip install iterm2
</span></span></code></pre></td></tr></table></div></div><h3 id=配置文件的设计>配置文件的设计</h3><p>我选择用 YAML 作为配置文件的格式，因为它的可读性好，格式简洁，有现成的解析库。我要做的就是通过 YAML 文件要定义布局，包括窗口、窗格和命令。</p><p>这是 tmuxifier 的配置文件。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 设置窗口名称和根目录</span>
</span></span><span style=display:flex><span>session_root <span style=color:#e6db74>&#34;~/Projects/my-project&#34;</span>
</span></span><span style=display:flex><span>window_name <span style=color:#e6db74>&#34;my-project&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建一个新窗口，并分割成两个窗格</span>
</span></span><span style=display:flex><span>new_window <span style=color:#e6db74>&#34;my-project&#34;</span>
</span></span><span style=display:flex><span>split_h <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第一个窗格运行 vim</span>
</span></span><span style=display:flex><span>run_cmd <span style=color:#e6db74>&#34;vim&#34;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 第二个窗格运行 go run main.go</span>
</span></span><span style=display:flex><span>run_cmd <span style=color:#e6db74>&#34;go run main.go&#34;</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 设置主窗格</span>
</span></span><span style=display:flex><span>select_pane <span style=color:#ae81ff>0</span>
</span></span></code></pre></td></tr></table></div></div><p>我将其映射成 YAML 配置文件，如下所示：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>layout</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>window_root</span>: <span style=color:#e6db74>&#34;~/Projects/my-project&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>window_name</span>: <span style=color:#e6db74>&#34;my-project&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>panes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>percentage</span>: <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;vim&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>type</span>: <span style=color:#e6db74>&#34;split_h&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;git status&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>main_pane</span>: <span style=color:#ae81ff>0</span>
</span></span></code></pre></td></tr></table></div></div><p>这个配置旨在创建一个布局，其中包含两个窗格，一个运行 <code>vim</code>，另一个显示 <code>go run main.go</code>，而鼠标聚焦在 <code>vim</code> 窗格下。</p><p>配置 <code>yaml</code> 文件的解析，我使用 Python 的 <code>yaml</code> 库来解析配置文件，</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 解析 YAML 配置</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;layout.yaml&#39;</span>, <span style=color:#e6db74>&#39;r&#39;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    config <span style=color:#f92672>=</span> yaml<span style=color:#f92672>.</span>safe_load(f)
</span></span><span style=display:flex><span>layout <span style=color:#f92672>=</span> config[<span style=color:#e6db74>&#34;layout&#34;</span>]
</span></span></code></pre></td></tr></table></div></div><p>这样我就能得到一个 <code>layout</code> 字典，其中包含了所有的布局信息。</p><p>接下来，主要就是将这个配置转换为 iTerm2 的操作，也就是根据配置指示，创建窗口和窗格，以及在窗格中执行特定命令。</p><h2 id=实现布局管理工具>实现布局管理工具</h2><p>首先，创建一个 Python 脚本，假设就叫 itermifier 吧。这个脚本根据我的 YAML 配置创建窗格并执行命令。</p><h3 id=准备部分>准备部分</h3><p>在开始构建我的 iTerm2 布局管理工具前，还需要准备一些基本的变量，这些变量将在创建布局的过程中被频繁使用。</p><p>首先，基于 iTerm2 API 创建主程序入口和获取 iTerm2 应用实例，如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>create_layout</span>(connection):
</span></span><span style=display:flex><span>  app <span style=color:#f92672>=</span> iterm2<span style=color:#f92672>.</span>async_get_app(connection)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>iterm2<span style=color:#f92672>.</span>run_until_complete(create_layout)
</span></span></code></pre></td></tr></table></div></div><p>代码中，定义了一个名为 <code>create_layout</code> 的异步函数，它是整个工具的核心。<code>connection</code> 参数是与 iTerm2 应用程序的连接，它是执行所有 iTerm2 API 调用的必要条件。iTerm2 的应用实例 <code>app</code> 就是从它获取而来的。</p><p>这是后续所有操作的起点。</p><h3 id=窗口和标签页>窗口和标签页</h3><p>接着，获取到当前活跃的窗口和标签页：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>window <span style=color:#f92672>=</span> app<span style=color:#f92672>.</span>current_terminal_window
</span></span><span style=display:flex><span>tab <span style=color:#f92672>=</span> window<span style=color:#f92672>.</span>current_tab
</span></span></code></pre></td></tr></table></div></div><p>这些步骤确保了我能在正确的上下文中操作 iTerm2，无论是分割窗格还是运行命令。</p><p>接下是创建了一个名为 <code>sessions</code> 的列表，用于存储标签页中的会话。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 预先创建的会话列表</span>
</span></span><span style=display:flex><span>sessions <span style=color:#f92672>=</span> [tab<span style=color:#f92672>.</span>current_session] 
</span></span></code></pre></td></tr></table></div></div><p>这个列表用于存储当前这个标签页的所有会话，初始内容中的是当前标签页会话，通过 <code>tab.current_session</code> 获取。</p><h3 id=分割窗格>分割窗格</h3><p>接下来，就是按配置分割窗格。通过 <code>for</code> 循环窗格配置。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> index, pane <span style=color:#f92672>in</span> enumerate(layout[<span style=color:#e6db74>&#34;panes&#34;</span>]):
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>pass</span>
</span></span></code></pre></td></tr></table></div></div><p>以下是分割窗格的实现代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>vertical <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span> <span style=color:#66d9ef>if</span> pane[<span style=color:#e6db74>&#34;type&#34;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;split_h&#34;</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>session <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> tab<span style=color:#f92672>.</span>current_session<span style=color:#f92672>.</span>async_split_pane(vertical<span style=color:#f92672>=</span>vertical)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>session <span style=color:#f92672>=</span> sessions<span style=color:#f92672>.</span>append(session)
</span></span></code></pre></td></tr></table></div></div><p>对于每个窗格配置，我调用 iTerm2 API 的 <code>async_split_pane</code> 方法，根据需要进行水平或垂直分割。</p><h3 id=执行预设命令>执行预设命令</h3><p>每个窗格创建后，通过 <code>async_send_text</code> 方法执行各个 pane 的预设命令。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> cmd <span style=color:#f92672>in</span> pane<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;commands&#34;</span>, []):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> session<span style=color:#f92672>.</span>async_send_text(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>cmd<span style=color:#e6db74>}</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)  <span style=color:#75715e># pyright: ignore</span>
</span></span></code></pre></td></tr></table></div></div><p>到这里，基本上已经实现了我想要的所有能力了。</p><h3 id=回到主窗格>回到主窗格</h3><p>最后，我实现了将焦点移回主窗格的功能。</p><p>前面通过维护一个 session 列表，保存了所有创建的窗格会话，这样，我可以在所有操作完成后，按 <code>main_pane</code> 获取最终聚焦的窗口。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>main_pane_index <span style=color:#f92672>=</span> layout[<span style=color:#e6db74>&#34;main_pane&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#66d9ef>await</span> sessions[main_pane_index]<span style=color:#f92672>.</span>async_activate()
</span></span></code></pre></td></tr></table></div></div><p>到此，基本全部完成了。</p><p>效果如下：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-02/2024-02-26-build-an-itermifier-03.gif alt></p><p>这里面，我省略一些代码，完成代码查看这个地址：<a href=https://gist.github.com/poloxue/c2b1a4c839750f1c5c0cba65c74a223b>itermifier</a>。</p><h3 id=结语>结语</h3><p>通过这个过程，我成功实现了一个在 iTerm2 中自动管理布局的工具。虽然过程中遇到了一些挑战，但最终能够通过编程方式定义和启动我的工作环境，还是很爽的。</p><p>要说遗憾的话，就是不支持大小比例的调整，可惜了。</p><div>本文来源于 <a href=https://www.poloxue.com>POLOXUE's BLOG</a>，地址： <a href=https://www.poloxue.com/posts/2024-02-25-build-an-itermifier/>我用 Python 为 iTerm2 开发一个类似 tmuxifier 的工具</a><hr class=footer-separator><div class=tags></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post>欢迎关注我的公众号：<img style=width:85% src=https://cdn.jsdelivr.net/gh/poloxue/images@main/wechat.png><div class=utterances></div><script src=https://utteranc.es/client.js repo=poloxue/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script></body></html>
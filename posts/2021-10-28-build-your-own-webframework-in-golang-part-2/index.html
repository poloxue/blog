<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>从头构建 Go Web 框架（二）：中间件 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="从头构建 Go Web 框架（二）：中间件"><meta itemprop=description content="本文是构建 Go Web 框架的第二篇，目标是介绍中间件的最佳实践，访问原文。
译文如下：
在编写 Go Web 应用时，代码重复是大多数开发者将会遇到的第一个问题。
为什么呢？
原因在于，在处理 request 时，诸如记录请求、将应用程序错误转换为 HTTP 500 错误、验证用户等一些操作，这是每个处理程序都要执行的动作。
本文是 &ldquo;构建属于自己的 Web 框架&rdquo; 系列文章中的第二篇：
第 1 部分：简介 第 2 部分：Go 中间件：最佳实践和示例 第 3 部分：中间件数据共享 第 4 部分：第三方路由 第 5 部分：使用 MongoDB 实现 JSON-API 附加福利：上传文件到 s3 基础入门 首先，使用 net/http 包创建一个简单版本的 HTTP Server 应用。
代码如下：
1 2 3 4 5 6 7 8 9 10 11 12 13 import ( &#34;net/http&#34; &#34;fmt&#34; ) func handler(w http."><meta itemprop=datePublished content="2021-10-28T13:35:05+08:00"><meta itemprop=dateModified content="2021-10-28T13:35:05+08:00"><meta itemprop=wordCount content="625"><meta itemprop=keywords content="Golang,"><meta property="og:title" content="从头构建 Go Web 框架（二）：中间件"><meta property="og:description" content="本文是构建 Go Web 框架的第二篇，目标是介绍中间件的最佳实践，访问原文。
译文如下：
在编写 Go Web 应用时，代码重复是大多数开发者将会遇到的第一个问题。
为什么呢？
原因在于，在处理 request 时，诸如记录请求、将应用程序错误转换为 HTTP 500 错误、验证用户等一些操作，这是每个处理程序都要执行的动作。
本文是 &ldquo;构建属于自己的 Web 框架&rdquo; 系列文章中的第二篇：
第 1 部分：简介 第 2 部分：Go 中间件：最佳实践和示例 第 3 部分：中间件数据共享 第 4 部分：第三方路由 第 5 部分：使用 MongoDB 实现 JSON-API 附加福利：上传文件到 s3 基础入门 首先，使用 net/http 包创建一个简单版本的 HTTP Server 应用。
代码如下：
1 2 3 4 5 6 7 8 9 10 11 12 13 import ( &#34;net/http&#34; &#34;fmt&#34; ) func handler(w http."><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2021-10-28-build-your-own-webframework-in-golang-part-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-28T13:35:05+08:00"><meta property="article:modified_time" content="2021-10-28T13:35:05+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="从头构建 Go Web 框架（二）：中间件"><meta name=twitter:description content="本文是构建 Go Web 框架的第二篇，目标是介绍中间件的最佳实践，访问原文。
译文如下：
在编写 Go Web 应用时，代码重复是大多数开发者将会遇到的第一个问题。
为什么呢？
原因在于，在处理 request 时，诸如记录请求、将应用程序错误转换为 HTTP 500 错误、验证用户等一些操作，这是每个处理程序都要执行的动作。
本文是 &ldquo;构建属于自己的 Web 框架&rdquo; 系列文章中的第二篇：
第 1 部分：简介 第 2 部分：Go 中间件：最佳实践和示例 第 3 部分：中间件数据共享 第 4 部分：第三方路由 第 5 部分：使用 MongoDB 实现 JSON-API 附加福利：上传文件到 s3 基础入门 首先，使用 net/http 包创建一个简单版本的 HTTP Server 应用。
代码如下：
1 2 3 4 5 6 7 8 9 10 11 12 13 import ( &#34;net/http&#34; &#34;fmt&#34; ) func handler(w http."><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.webp alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/index.xml title=RSS><i data-feather=rss></i></a></li></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>HOME</a></li><li><a href=/posts>POSTS</a></li><li><a href=/tags>TAGS</a></li><li><a href=/about/>ABOUT</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>28</span>
<span class=rest>Oct 2021</span></div></div><div class=matter><h1 class=title>从头构建 Go Web 框架（二）：中间件</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#添加日志>添加日志</a></li></ol></nav></aside><p>本文是构建 Go Web 框架的第二篇，目标是介绍中间件的最佳实践，<a href=https://www.nicolasmerouze.com/middlewares-golang-best-practices-examples>访问原文</a>。</p><p>译文如下：</p><p>在编写 Go Web 应用时，代码重复是大多数开发者将会遇到的第一个问题。</p><p>为什么呢？</p><p>原因在于，在处理 request 时，诸如记录请求、将应用程序错误转换为 HTTP 500 错误、验证用户等一些操作，这是每个处理程序都要执行的动作。</p><p>本文是 &ldquo;构建属于自己的 Web 框架&rdquo; 系列文章中的第二篇：</p><ul><li><a href=https://www.nicolasmerouze.com/build-web-framework-golang>第 1 部分：简介</a></li><li><a href=https://www.nicolasmerouze.com/middlewares-golang-best-practices-examples>第 2 部分：Go 中间件：最佳实践和示例</a></li><li><a href=https://www.nicolasmerouze.com/share-values-between-middlewares-context-golang>第 3 部分：中间件数据共享</a></li><li><a href=https://www.nicolasmerouze.com/guide-routers-golang>第 4 部分：第三方路由</a></li><li><a href=https://www.nicolasmerouze.com/how-to-render-json-api-golang-mongodb>第 5 部分：使用 MongoDB 实现 JSON-API</a></li><li><a href=https://www.nicolasmerouze.com/file-upload-web-service-golang-s3-aws>附加福利：上传文件到 s3</a></li></ul><h1 id=基础入门>基础入门</h1><p>首先，使用 net/http 包创建一个简单版本的 HTTP Server 应用。</p><p>代码如下：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#d14>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#d14>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>handler</span>(w http.ResponseWriter, r <span style=color:#000;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>    fmt.<span style=color:#900;font-weight:700>Fprintf</span>(w, <span style=color:#d14>&#34;Welcome!&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>HandleFunc</span>(<span style=color:#d14>&#34;/&#34;</span>, handler)
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>ListenAndServe</span>(<span style=color:#d14>&#34;:8080&#34;</span>, <span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>阅读以上代码，我们看出 <code>http.HandleFunc</code> 通过接受参数 <code>location pattern</code> 和 <code>handler</code>，实现特定路径与处理程序的匹配映射。<code>handler</code> 有 2 个参数，分别是 response writer 和 request，分别用于请求响应写入和请求信息读取。</p><p>除了通过 <code>http.HandleFunc</code> 指定处理函数的方式，实现 <code>http.Handler</code> 接口也可以帮助我们达成同样目的。</p><p>接口定义如下：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>type</span> Handler <span style=color:#000;font-weight:700>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#900;font-weight:700>ServeHTTP</span>(ResponseWriter, <span style=color:#000;font-weight:700>*</span>Request)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>示例代码如下：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>type</span> handler <span style=color:#000;font-weight:700>struct</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> (h handler) <span style=color:#900;font-weight:700>ServeHTTP</span>(w http.ResponseWriter, r <span style=color:#000;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>    fmt.<span style=color:#900;font-weight:700>Fprintf</span>(w, <span style=color:#d14>&#34;Welcome!&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>Handle</span>(<span style=color:#d14>&#34;/&#34;</span>, handler)
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>ListenAndServe</span>(<span style=color:#d14>&#34;:8080&#34;</span>, <span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>一旦实现了 <code>http.Handler</code> 的 <code>ServeHTTP(http.ResponseWriter, *http.Request)</code> 方法， 就能被 Go muxer (http.Handle(pattern, handler) function) 使用。</p><h2 id=添加日志>添加日志</h2><p>现在，我们希望通过增加一个简单的日志，记录处理每个请求所花费的时间。</p><p>代码如下：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>indexHandler</span>(w http.ResponseWriter, r <span style=color:#000;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>    t1 <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>    fmt.<span style=color:#900;font-weight:700>Fprintf</span>(w, <span style=color:#d14>&#34;Welcome!&#34;</span>)
</span></span><span style=display:flex><span>    t2 <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>    log.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;[%s] %q %v\n&#34;</span>, r.Method, r.URL.<span style=color:#900;font-weight:700>String</span>(), t2.<span style=color:#900;font-weight:700>Sub</span>(t1))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>HandleFunc</span>(<span style=color:#d14>&#34;/&#34;</span>, indexHandler)
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>ListenAndServe</span>(<span style=color:#d14>&#34;:8080&#34;</span>, <span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>输出内容如下：</p><pre tabindex=0><code class=language-log data-lang=log>[GET] / 1.43ms
[GET] /about 1.98ms
</code></pre><p>继续，我们增加第二个 handler。毕竟，只有一个路由的应用程序并不多。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>aboutHandler</span>(w http.ResponseWriter, r <span style=color:#000;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>    t1 <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>    fmt.<span style=color:#900;font-weight:700>Fprintf</span>(w, <span style=color:#d14>&#34;You are on the about page.&#34;</span>)
</span></span><span style=display:flex><span>    t2 <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>    log.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;[%s] %q %v\n&#34;</span>, r.Method, r.URL.<span style=color:#900;font-weight:700>String</span>(), t2.<span style=color:#900;font-weight:700>Sub</span>(t1))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>indexHandler</span>(w http.ResponseWriter, r <span style=color:#000;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>    t1 <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>    fmt.<span style=color:#900;font-weight:700>Fprintf</span>(w, <span style=color:#d14>&#34;Welcome!&#34;</span>)
</span></span><span style=display:flex><span>    t2 <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>    log.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;[%s] %q %v\n&#34;</span>, r.Method, r.URL.<span style=color:#900;font-weight:700>String</span>(), t2.<span style=color:#900;font-weight:700>Sub</span>(t1))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>HandleFunc</span>(<span style=color:#d14>&#34;/about&#34;</span>, aboutHandler)
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>HandleFunc</span>(<span style=color:#d14>&#34;/&#34;</span>, indexHandler)
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>ListenAndServe</span>(<span style=color:#d14>&#34;:8080&#34;</span>, <span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>代码重复！ 该如何解决呢？</p><p>我们可以创建一个带有闭包的函数。但是，当我们有多个这样的函数时，它就会变得像 Javascript 中的回调一样糟糕，我们并不想如此。</p><h1 id=链接处理>链接处理</h1><p>我们希望有一种类似 Rack、Ring、Connect.js 等的中间件系统的解决方案，链接多个处理程序。标准库中已经有这种实现的示例：</p><ul><li><code>http.StripPrefix(prefix, handler)</code>；</li><li><code>http.TimeoutHandler(handler, duration, message)</code>。</li></ul><p>它们将 <code>handler</code> 作为参数传递，返回一个新的 <code>handler</code>。如下所示：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#900;font-weight:700>loggingHandler</span>(<span style=color:#900;font-weight:700>recoverHandler</span>(indexHandler))
</span></span></code></pre></td></tr></table></div></div><p>中间件类似于 <code>func (http.Handler) http.Handler</code>，我们传递一个 <code>handler</code> 并返回一个 <code>handler</code>。我们就可以用 http.Handle(pattern, handler) 得到目标的处理程序。</p><p>实现代码如下：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>Handle</span>(<span style=color:#d14>&#34;/&#34;</span>, <span style=color:#900;font-weight:700>loggingHandler</span>(<span style=color:#900;font-weight:700>recoverHandler</span>(indexHandler)))
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>ListenAndServe</span>(<span style=color:#d14>&#34;:8080&#34;</span>, <span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>但如此还是很麻烦，一遍又一遍地重复堆栈。 有没有什么更优雅的方式实现呢？</p><h1 id=通用包-alice>通用包 alice</h1><p><a href=https://github.com/justinas/alice>alice</a> 是一个非常短小精悍的包，它优雅地实现了 <code>handler</code> 的链接调用。通过它，我们可以创建一个通用的 <code>handler</code> 列表，便于我们重复使用。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>    commonHandlers <span style=color:#000;font-weight:700>:=</span> alice.<span style=color:#900;font-weight:700>New</span>(loggingHandler, recoverHandler)
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>Handle</span>(<span style=color:#d14>&#34;/about&#34;</span>, commonHandlers.<span style=color:#900;font-weight:700>ThenFunc</span>(aboutHandler))
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>Handle</span>(<span style=color:#d14>&#34;/&#34;</span>, alice.<span style=color:#900;font-weight:700>New</span>(commonHandlers, bodyParserHandler).<span style=color:#900;font-weight:700>ThenFunc</span>(indexHandler))
</span></span><span style=display:flex><span>    http.<span style=color:#900;font-weight:700>ListenAndServe</span>(<span style=color:#d14>&#34;:8080&#34;</span>, <span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>问题解决！</p><p>我们已经有了一个使用标准接口的中间件系统，alice 有 50 行代码，一个非常小的依赖。如果想了解 alice 的实现细节，可自行阅读 <a href=https://github.com/justinas/alice>alice 源码</a>。</p><h1 id=多个参数的-handler>多个参数的 Handler</h1><p>alice 这样的中间件系统中，我们仍然不能使用类似 <code>http.StripPrefix(prefix, handler)</code> 具有多个参数的 <code>handler</code>。因为，它不是 <code>func (http.Handler) http.Handler</code> 类型函数。</p><p>怎么办？</p><p>我们可以通过定义新的 <code>handler</code> 实现兼容效果，保证满足 <code>func (http.Handler) http.Handler</code>。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>myStripPrefix</span>(h http.Handler) http.Handler {
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>return</span> http.<span style=color:#900;font-weight:700>StripPrefix</span>(<span style=color:#d14>&#34;/old&#34;</span>, h)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>现在，新的 handler 我们在 alice 中间件系统可以开始使用了。</p><h1 id=再谈-logging-middleware>再谈 logging middleware</h1><p>通过 alice，我们有了更加优雅的方式实现代码重复的删除。我们无需重新定义的一个新的 http.Handler 接口，标准接口即可满足要求，这意味学习成本非常低，依赖更少。</p><p>实现代码如下：</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>loggingHandler</span>(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>  fn <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>func</span>(w http.ResponseWriter, r <span style=color:#000;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>    t1 <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>    next.<span style=color:#900;font-weight:700>ServeHTTP</span>(w, r)
</span></span><span style=display:flex><span>    t2 <span style=color:#000;font-weight:700>:=</span> time.<span style=color:#900;font-weight:700>Now</span>()
</span></span><span style=display:flex><span>    log.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;[%s] %q %v\n&#34;</span>, r.Method, r.URL.<span style=color:#900;font-weight:700>String</span>(), t2.<span style=color:#900;font-weight:700>Sub</span>(t1))
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>return</span> http.<span style=color:#900;font-weight:700>HandlerFunc</span>(fn)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>最后，我们使用 alice 将 loggingHandler 与其他 <code>handler</code> 链接起来。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>aboutHandler</span>(w http.ResponseWriter, r <span style=color:#000;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>  fmt.<span style=color:#900;font-weight:700>Fprintf</span>(w, <span style=color:#d14>&#34;You are on the about page.&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>indexHandler</span>(w http.ResponseWriter, r <span style=color:#000;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>  fmt.<span style=color:#900;font-weight:700>Fprintf</span>(w, <span style=color:#d14>&#34;Welcome!&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>  commonHandlers <span style=color:#000;font-weight:700>:=</span> alice.<span style=color:#900;font-weight:700>New</span>(loggingHandler)
</span></span><span style=display:flex><span>  http.<span style=color:#900;font-weight:700>Handle</span>(<span style=color:#d14>&#34;/about&#34;</span>, commonHandlers.<span style=color:#900;font-weight:700>ThenFunc</span>(aboutHandler))
</span></span><span style=display:flex><span>  http.<span style=color:#900;font-weight:700>Handle</span>(<span style=color:#d14>&#34;/&#34;</span>, commonHandlers.<span style=color:#900;font-weight:700>ThenFunc</span>(indexHandler))
</span></span><span style=display:flex><span>  http.<span style=color:#900;font-weight:700>ListenAndServe</span>(<span style=color:#d14>&#34;:8080&#34;</span>, <span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>大功告成！</p><h1 id=新中间件panic-recovery>新中间件：panic recovery</h1><p>另一个真正必要的功能：<code>panic recovery</code>。</p><p>当生产环境出现 <code>panic</code>，应用程序会被关闭。即使，我们有一个监控负责应用程序检测重启，也会不可避免的停机一小段时间。我们必须捕捉和记录 panic，并保持应用程序运行。</p><p>使用 Go 和中间件系统，这会变得非常容易。 只需要我们创建一个 <code>defer</code> 函数恢复 <code>panic</code>，响应 HTTP 500 错误并记录 panic 即可。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>recoverHandler</span>(next http.Handler) http.Handler {
</span></span><span style=display:flex><span>  fn <span style=color:#000;font-weight:700>:=</span> <span style=color:#000;font-weight:700>func</span>(w http.ResponseWriter, r <span style=color:#000;font-weight:700>*</span>http.Request) {
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>defer</span> <span style=color:#000;font-weight:700>func</span>() {
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>recover</span>(); err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
</span></span><span style=display:flex><span>        log.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;panic: %+v&#34;</span>, err)
</span></span><span style=display:flex><span>        http.<span style=color:#900;font-weight:700>Error</span>(w, http.<span style=color:#900;font-weight:700>StatusText</span>(<span style=color:#099>500</span>), <span style=color:#099>500</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    next.<span style=color:#900;font-weight:700>ServeHTTP</span>(w, r)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>return</span> http.<span style=color:#900;font-weight:700>HandlerFunc</span>(fn)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>现在，将它追加到我们的中间件 stack 中。</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span>  commonHandlers <span style=color:#000;font-weight:700>:=</span> alice.<span style=color:#900;font-weight:700>New</span>(loggingHandler, recoverHandler)
</span></span><span style=display:flex><span>  http.<span style=color:#900;font-weight:700>Handle</span>(<span style=color:#d14>&#34;/about&#34;</span>, commonHandlers.<span style=color:#900;font-weight:700>ThenFunc</span>(aboutHandler))
</span></span><span style=display:flex><span>  http.<span style=color:#900;font-weight:700>Handle</span>(<span style=color:#d14>&#34;/&#34;</span>, commonHandlers.<span style=color:#900;font-weight:700>ThenFunc</span>(indexHandler))
</span></span><span style=display:flex><span>  http.<span style=color:#900;font-weight:700>ListenAndServe</span>(<span style=color:#d14>&#34;:8080&#34;</span>, <span style=color:#000;font-weight:700>nil</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h1 id=总结>总结</h1><p>我们已经了解，<code>func (http.Handler) http.Handler</code> 是一种非常简单的中间件定义方法，它提供了一切所需，<code>http.Handler</code> 是一个标准接口。</p><p>而通过链接方式实现中间件系统，已经是非常流行的方案，比如 Gorilla 和标准库本身。 我认为这是最惯用的方式。</p><p>我们已经编写了两个中间件：logging 和 panice recovery。</p><p>几乎每个框架中都在重写它们，尽管它们的功能几乎一样。大多数框架都有自己特定的 <code>handler</code> 定义，很难与其他中间件协同使用。接下来的一部分，我们将会了解到，在中间件之间共享值时，我们可能要更改一些内容。但它其实没有那么大的变化，我们没有理由重写已有的中间件。</p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#添加日志>添加日志</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags><ul class=flat><li class=tag-li><a href=/tags/golang>Golang</a></li></ul></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div></div><div class="footer wrapper"><nav class=nav><div>2021 2023 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>
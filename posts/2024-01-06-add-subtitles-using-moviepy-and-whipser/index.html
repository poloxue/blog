<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>使用 Whisper 和 MoviePy 实现视频自动加字幕 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="使用 Whisper 和 MoviePy 实现视频自动加字幕"><meta itemprop=description content="本博文将就此主题展开，介绍如何基于 openai-whisper 和 moviepy 实现通过 Python 快速给视频添加字幕。"><meta itemprop=datePublished content="2024-01-05T21:39:29+08:00"><meta itemprop=dateModified content="2024-01-05T21:39:29+08:00"><meta itemprop=wordCount content="467"><meta itemprop=keywords content><meta property="og:title" content="使用 Whisper 和 MoviePy 实现视频自动加字幕"><meta property="og:description" content="本博文将就此主题展开，介绍如何基于 openai-whisper 和 moviepy 实现通过 Python 快速给视频添加字幕。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2024-01-06-add-subtitles-using-moviepy-and-whipser/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-05T21:39:29+08:00"><meta property="article:modified_time" content="2024-01-05T21:39:29+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Whisper 和 MoviePy 实现视频自动加字幕"><meta name=twitter:description content="本博文将就此主题展开，介绍如何基于 openai-whisper 和 moviepy 实现通过 Python 快速给视频添加字幕。"><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.png alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/posts/index.xml title=RSS><i data-feather=rss></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts>文章列表</a></li><li><a href=/tags>分类标签</a></li><li><a href=/about/>关于我</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>05</span>
<span class=rest>Jan 2024</span></div></div><div class=matter><h1 class=title>使用 Whisper 和 MoviePy 实现视频自动加字幕</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#前言概述>前言概述</a></li><li><a href=#步骤介绍>步骤介绍</a></li><li><a href=#语音识别>语音识别</a></li><li><a href=#字幕片段>字幕片段</a></li><li><a href=#合成视频>合成视频</a></li><li><a href=#字幕位置>字幕位置</a></li><li><a href=#字幕样式>字幕样式</a></li><li><a href=#总结>总结</a></li></ol></nav></aside><p>对于视频编辑而言，给视频添加字幕是一个常见的需求。而利用 python 的三方库 moviepy 和 openai-whisper，就可以轻松实现为视频添加字幕。</p><p>本博文将就此主题展开，介绍如何通过 Python 快速添加视频字幕。</p><h2 id=前言概述>前言概述</h2><p>编辑视频时，为视频添加字幕不仅仅可以让内容易于理解性，而且可以增加视频的吸引力。</p><p>Python 提供了 MoviePy 库，同时近期开源的 openai-whisper 模块使得为视频添加字幕变得十分简单。</p><p>whisper 的安装直接通过如下命令即可完成。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>pip install openai<span style=color:#f92672>-</span>whisper 
</span></span></code></pre></td></tr></table></div></div><p>而 moviepy 的安装可参考我之前的文章：<a href=https://www.poloxue.com/posts/2024-01-03-moviepy-basic-usage/>Python 视频剪辑库 - MoviePy 基础使用</a>。</p><h2 id=步骤介绍>步骤介绍</h2><p>添加字幕的核心步骤主要三步，如下所示：</p><ul><li>利用 openai-whisper 从视频中将语音识别为文本；</li><li>基于识别结果生成 moviepy 字幕片段 SubtitlesClip；</li><li>将字幕片段 SubtitlesClip 和视频片段 VideoFileClip 合成最终文件；</li></ul><p>让我们进入开始具体的操作。</p><h2 id=语音识别>语音识别</h2><p>我们现在在当前目录有一个视频，名为 input_video2.mp4。可直接利用 whisper 的 transcribe 识别视频文件中的语音文本。</p><p>实现代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> whisper
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>model <span style=color:#f92672>=</span> whisper<span style=color:#f92672>.</span>load(<span style=color:#e6db74>&#34;medium&#34;</span>)
</span></span><span style=display:flex><span>result <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>transcribe(<span style=color:#e6db74>&#34;input_video2.mp4&#34;</span>)
</span></span><span style=display:flex><span>print(json<span style=color:#f92672>.</span>dumps(result))
</span></span></code></pre></td></tr></table></div></div><p>输出 result，如下所示</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;text&#34;</span>: <span style=color:#e6db74>&#34; In an era dominated by short-form videos, numerous user-friendly editing software options exist. However, for specialized video formats like e-book presentations or comic readings, streamlining the video creation process through automation stands as a crucial enhancement for efficiency.&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;segments&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;id&#34;</span>: 0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;seek&#34;</span>: 0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start&#34;</span>: 0.0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end&#34;</span>: 6.7,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;text&#34;</span>: <span style=color:#e6db74>&#34; In an era dominated by short-form videos, numerous user-friendly editing software options exist.&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;tokens&#34;</span>: <span style=color:#f92672>[]</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;temperature&#34;</span>: 0.0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;avg_logprob&#34;</span>: -0.170647520768015,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;compression_ratio&#34;</span>: 1.4947916666666667,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;no_speech_prob&#34;</span>: 0.007638249080628157
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;id&#34;</span>: 1,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;seek&#34;</span>: 0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start&#34;</span>: 6.7,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end&#34;</span>: 12.0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;text&#34;</span>: <span style=color:#e6db74>&#34; However, for specialized video formats like e-book presentations or comic readings,&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;tokens&#34;</span>: <span style=color:#f92672>[]</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;temperature&#34;</span>: 0.0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;avg_logprob&#34;</span>: -0.170647520768015,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;compression_ratio&#34;</span>: 1.4947916666666667,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;no_speech_prob&#34;</span>: 0.007638249080628157
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;id&#34;</span>: 2,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;seek&#34;</span>: 0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;start&#34;</span>: 12.0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;end&#34;</span>: 19.0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;text&#34;</span>: <span style=color:#e6db74>&#34; streamlining the video creation process through automation stands as a crucial enhancement for efficiency.&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;tokens&#34;</span>: <span style=color:#f92672>[]</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;temperature&#34;</span>: 0.0,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;avg_logprob&#34;</span>: -0.170647520768015,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;compression_ratio&#34;</span>: 1.4947916666666667,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;no_speech_prob&#34;</span>: 0.007638249080628157
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;language&#34;</span>: <span style=color:#e6db74>&#34;en&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，result 中包含一个 segments 的数组，start 表示开始时间，end 表示结束时间，而 text 就是字幕文本。</p><p>好了，现在我们就有了制作字幕所需的所有信息。</p><h2 id=字幕片段>字幕片段</h2><p>接下来，让我们利用 whisper 的 result 生成字幕所需的文本片段 TextClip。</p><p>制作字幕片段一般方法是，循环遍历 segments 制作 clips 数组，使用 set_start 和 set_end 设置 TextClip 的开始结束时间。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>subtitle_clips <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> segment <span style=color:#f92672>in</span> segments:
</span></span><span style=display:flex><span>  subtitle_clip <span style=color:#f92672>=</span> TextClip(segment[<span style=color:#e6db74>&#39;text&#39;</span>])<span style=color:#f92672>.</span>set_start(segment[<span style=color:#e6db74>&#39;start&#39;</span>])<span style=color:#f92672>.</span>set_end(segment[<span style=color:#e6db74>&#39;end&#39;</span>])
</span></span><span style=display:flex><span>  subtitle_clips<span style=color:#f92672>.</span>append(subtitle_clip)
</span></span></code></pre></td></tr></table></div></div><p>moviepy 提供一个 moviepy.video.tools.subtitles.SubtitlesClip 的类。</p><p>我们只需将 segments 转为 <code>[((start, end), text)]</code> 的数组，传递给 SubtitlesClip，即可创建出 SubtitlesClip。</p><p>代码如下所示：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> moviepy.video.tools.subtitles <span style=color:#f92672>import</span> SubtitlesClip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>subtitles <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> segment <span style=color:#f92672>in</span> segments:
</span></span><span style=display:flex><span>  subtitle <span style=color:#f92672>=</span> (segment[<span style=color:#e6db74>&#39;start&#39;</span>], segment[<span style=color:#e6db74>&#39;end&#39;</span>]), segment[<span style=color:#e6db74>&#39;text&#39;</span>]
</span></span><span style=display:flex><span>  subtitles<span style=color:#f92672>.</span>append(subtitle)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>subtitles_clip <span style=color:#f92672>=</span> SubtitlesClip(subtitles)
</span></span></code></pre></td></tr></table></div></div><p>OK，现在我们已经成功创建了字幕 clip 文件。</p><h2 id=合成视频>合成视频</h2><p>有了字幕片段 Clip，让我们将其与原视频合成，生成一个包含字幕的文件。</p><p>代码如下所示：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>video <span style=color:#f92672>=</span> VideoFileClip(<span style=color:#e6db74>&#34;input_video2.mp4&#34;</span>)
</span></span><span style=display:flex><span>video <span style=color:#f92672>=</span> CompositeVideoClip([video, subtitles_clip])
</span></span><span style=display:flex><span>video<span style=color:#f92672>.</span>write_videofile(<span style=color:#e6db74>&#34;output_with_subtitles.mp4&#34;</span>, audio_codec<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;aac&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>执行完代码，就可以生成带有字幕的视频文件。</p><p>效果如下所示：</p><image src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-01/2024-01-06-add-subtitles-using-moviepy-and-whipser-01.png><p>仔细观察左上角，可以看到字幕已经添加到视频上。</p><h2 id=字幕位置>字幕位置</h2><p>如果检查生成的视频文件，我们会发现生成字幕位于视频的左上角。如果想修改字幕如何做。</p><p>正常的字幕应该是位于视频下方居中的。我们可以通过 <code>SubtitlesClip</code> 的方法 <code>set_pos</code> 调整字幕位置。</p><p>我们的目标是基于原视频，将字母调整到位于视频底部上下 0.2 的位置，即坐标向下 0.8 的位置。</p><p>实现代码如下所示：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>width, height <span style=color:#f92672>=</span> video<span style=color:#f92672>.</span>size
</span></span><span style=display:flex><span>pos <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#34;center&#34;</span>, height <span style=color:#ae81ff>0.8</span>)
</span></span><span style=display:flex><span>subtitles_clip <span style=color:#f92672>=</span> subtitles_clip<span style=color:#f92672>.</span>set_position(pos)
</span></span></code></pre></td></tr></table></div></div><p>效果如下所示：</p><image src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-01/2024-01-06-add-subtitles-using-moviepy-and-whipser-02.png><p>字幕在视频底部。</p><h2 id=字幕样式>字幕样式</h2><p>如果发现字体太小或者想修改字体或颜色，我们可以覆盖创建的 <code>SubtitlesClip</code> 的第三个三个参数 <code>make_textclip</code>。</p><p>假设将默认字体大小改为 48，字体改为font 为 Arial，字体颜色改为 orange。</p><p>实现代码如下所示：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_textclip</span>(txt):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> TextClip(txt, fontsize<span style=color:#f92672>=</span><span style=color:#ae81ff>48</span>, font<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Arial&#34;</span>, color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;orange&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>subtitles_clip <span style=color:#f92672>=</span> SubtitlesClip(subtitles, make_textclip)
</span></span></code></pre></td></tr></table></div></div><p>如果发现生成字幕超出了原视频范围，可设置 <code>TextClip</code> 的参数 size 限制字幕宽度，设置参数 <code>method</code> 为 caption 实现自动换行。</p><p>实现代码，如下所示，</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>make_textclip</span>(txt):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> TextClip(txt, fontsize<span style=color:#f92672>=</span><span style=color:#ae81ff>48</span>, font<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Arial&#34;</span>, color<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;orange&#34;</span>, size<span style=color:#f92672>=</span>(width <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.8</span>, <span style=color:#66d9ef>None</span>), method<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;caption&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>字幕宽度为原始视频宽度的 0.8 倍，如果大于设置宽度则自动换成。</p><p>效果如下：</p><image src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-01/2024-01-06-add-subtitles-using-moviepy-and-whipser-03.png><p>到此，我们通过 openai-whisper 和 moviepy 制作自动化制作视频字幕的教程就完成了。</p><h2 id=总结>总结</h2><p>本博文主要介绍如何基于 openai-whisper 和 moviepy 实现自动化制作视频字幕。如果想了解字幕的更多样式，可查看 TextClip 还支持哪些参数。</p><p>还有，有了这个能力。如想继续扩展，我们还可以通过调用三方翻译软件，实现给视频自动加载翻译字幕。</p><p>感谢阅读，可持续关注我的博客。</p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#前言概述>前言概述</a></li><li><a href=#步骤介绍>步骤介绍</a></li><li><a href=#语音识别>语音识别</a></li><li><a href=#字幕片段>字幕片段</a></li><li><a href=#合成视频>合成视频</a></li><li><a href=#字幕位置>字幕位置</a></li><li><a href=#字幕样式>字幕样式</a></li><li><a href=#总结>总结</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div></div><div class="footer wrapper"><nav class=nav><div>2024 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>
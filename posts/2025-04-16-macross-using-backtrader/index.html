<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>掌握 backtrader 策略回测：均线交叉交易系统 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="掌握 backtrader 策略回测：均线交叉交易系统"><meta itemprop=description content="我花了一个星期通读了 backtrader 的官方文档，順便还通过 AI 整理出了它的中文文档，我不想写 backtrader 的基础入门教程，还不如直接用 backtrader 逐步展开回测这一个策略，或许更加容易掌握它的使用。
相较于其他回测框架，backtrader 的功能强大，除了支持单品种，还可以实现组合策略，扩展能力非常强大，如果说缺点，一是这个项目基本不维护了，不过不影响它的使用，还有就是因为它很强大，扩展性强，比其他的回测框架更不易于掌握。
本文介绍如何使用 backtrader 回测双均线交易策略，将包含基本的进出场、风险控制，参数优化等，还有如何加载分钟数据尽可能模拟真实场景。我暂时先用双均线策略上手 backtrader，后续还会使用 backtrader 回测更多的策略。
策略定义 选择品种
暂定 BTC 作为回测品种，虽然这个策略在它上面的表现不算很好。 技术指标
EMA，即指数移动均线，均线指标种类繁多，如 SMA、WMA 等； ATR，真实波动幅度，用于控制止损； 策略参数
short_period：短均线周期； long_period：长均线的周期 atr_period： 真实波动振幅的计算周期，一般固定为 14 即可。 入场条件
做多：短均线上穿长均线。 做空：短均线下穿长均线。 出场条件
平多：短均线下穿长均线。 平空：短均线上穿长均线。 风险控制
为了防止出现过于大的止损金额，设置固定的止损位置并通过止损位置推算最大亏损金额。
止损位置：当前价格 - n 倍 ATR； 最大亏损：每笔交易的最大亏损金额不超过账户的 2%，按次目标推算实际下单金额。 这是个非常简单的策略，只是相对于最简单版本的均线交叉策略，加上了风险控制。
依赖库 安装依赖的 Python 库。
1 pip install backtrader yfinance 主流程 通过 backtrader 回测策略，在主函数要提前做一些设置，如设置费率、滑点、账户金额。此外还有加载数据源和策略。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import backtrader as bt import yfinance as yf # 策略逻辑，暂空 class MACrossStrategy(bt."><meta itemprop=datePublished content="2025-04-15T17:59:11+08:00"><meta itemprop=dateModified content="2025-04-15T17:59:11+08:00"><meta itemprop=wordCount content="977"><meta itemprop=keywords content><meta property="og:title" content="掌握 backtrader 策略回测：均线交叉交易系统"><meta property="og:description" content="我花了一个星期通读了 backtrader 的官方文档，順便还通过 AI 整理出了它的中文文档，我不想写 backtrader 的基础入门教程，还不如直接用 backtrader 逐步展开回测这一个策略，或许更加容易掌握它的使用。
相较于其他回测框架，backtrader 的功能强大，除了支持单品种，还可以实现组合策略，扩展能力非常强大，如果说缺点，一是这个项目基本不维护了，不过不影响它的使用，还有就是因为它很强大，扩展性强，比其他的回测框架更不易于掌握。
本文介绍如何使用 backtrader 回测双均线交易策略，将包含基本的进出场、风险控制，参数优化等，还有如何加载分钟数据尽可能模拟真实场景。我暂时先用双均线策略上手 backtrader，后续还会使用 backtrader 回测更多的策略。
策略定义 选择品种
暂定 BTC 作为回测品种，虽然这个策略在它上面的表现不算很好。 技术指标
EMA，即指数移动均线，均线指标种类繁多，如 SMA、WMA 等； ATR，真实波动幅度，用于控制止损； 策略参数
short_period：短均线周期； long_period：长均线的周期 atr_period： 真实波动振幅的计算周期，一般固定为 14 即可。 入场条件
做多：短均线上穿长均线。 做空：短均线下穿长均线。 出场条件
平多：短均线下穿长均线。 平空：短均线上穿长均线。 风险控制
为了防止出现过于大的止损金额，设置固定的止损位置并通过止损位置推算最大亏损金额。
止损位置：当前价格 - n 倍 ATR； 最大亏损：每笔交易的最大亏损金额不超过账户的 2%，按次目标推算实际下单金额。 这是个非常简单的策略，只是相对于最简单版本的均线交叉策略，加上了风险控制。
依赖库 安装依赖的 Python 库。
1 pip install backtrader yfinance 主流程 通过 backtrader 回测策略，在主函数要提前做一些设置，如设置费率、滑点、账户金额。此外还有加载数据源和策略。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import backtrader as bt import yfinance as yf # 策略逻辑，暂空 class MACrossStrategy(bt."><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2025-04-16-macross-using-backtrader/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-15T17:59:11+08:00"><meta property="article:modified_time" content="2025-04-15T17:59:11+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="掌握 backtrader 策略回测：均线交叉交易系统"><meta name=twitter:description content="我花了一个星期通读了 backtrader 的官方文档，順便还通过 AI 整理出了它的中文文档，我不想写 backtrader 的基础入门教程，还不如直接用 backtrader 逐步展开回测这一个策略，或许更加容易掌握它的使用。
相较于其他回测框架，backtrader 的功能强大，除了支持单品种，还可以实现组合策略，扩展能力非常强大，如果说缺点，一是这个项目基本不维护了，不过不影响它的使用，还有就是因为它很强大，扩展性强，比其他的回测框架更不易于掌握。
本文介绍如何使用 backtrader 回测双均线交易策略，将包含基本的进出场、风险控制，参数优化等，还有如何加载分钟数据尽可能模拟真实场景。我暂时先用双均线策略上手 backtrader，后续还会使用 backtrader 回测更多的策略。
策略定义 选择品种
暂定 BTC 作为回测品种，虽然这个策略在它上面的表现不算很好。 技术指标
EMA，即指数移动均线，均线指标种类繁多，如 SMA、WMA 等； ATR，真实波动幅度，用于控制止损； 策略参数
short_period：短均线周期； long_period：长均线的周期 atr_period： 真实波动振幅的计算周期，一般固定为 14 即可。 入场条件
做多：短均线上穿长均线。 做空：短均线下穿长均线。 出场条件
平多：短均线下穿长均线。 平空：短均线上穿长均线。 风险控制
为了防止出现过于大的止损金额，设置固定的止损位置并通过止损位置推算最大亏损金额。
止损位置：当前价格 - n 倍 ATR； 最大亏损：每笔交易的最大亏损金额不超过账户的 2%，按次目标推算实际下单金额。 这是个非常简单的策略，只是相对于最简单版本的均线交叉策略，加上了风险控制。
依赖库 安装依赖的 Python 库。
1 pip install backtrader yfinance 主流程 通过 backtrader 回测策略，在主函数要提前做一些设置，如设置费率、滑点、账户金额。此外还有加载数据源和策略。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import backtrader as bt import yfinance as yf # 策略逻辑，暂空 class MACrossStrategy(bt."><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script>
<script>MathJax={tex:{displayMath:[["[","]"],["$$","$$"]],inlineMath:[["(",")"],["$","$"]]}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.png alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/posts/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>文章列表</a></li><li><a href=/tags>分类标签</a></li><li><a href=/about/about>关于我</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>15</span>
<span class=rest>Apr 2025</span></div></div><div class=matter><h1 class=title>掌握 backtrader 策略回测：均线交叉交易系统</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#策略定义>策略定义</a></li><li><a href=#依赖库>依赖库</a></li><li><a href=#主流程>主流程</a></li><li><a href=#策略实现>策略实现</a><ol><li><a href=#计算指标>计算指标</a></li><li><a href=#开仓平仓>开仓平仓</a></li></ol></li><li><a href=#绘图>绘图</a></li><li><a href=#评价指标>评价指标</a></li><li><a href=#策略优化>策略优化</a></li><li><a href=#风险控制>风险控制</a></li><li><a href=#重放分钟行情>重放分钟行情</a></li><li><a href=#总结>总结</a></li></ol></nav></aside><p>我花了一个星期通读了 backtrader 的官方文档，順便还通过 AI 整理出了它的中文文档，我不想写 backtrader 的基础入门教程，还不如直接用 backtrader 逐步展开回测这一个策略，或许更加容易掌握它的使用。</p><p>相较于其他回测框架，backtrader 的功能强大，除了支持单品种，还可以实现组合策略，扩展能力非常强大，如果说缺点，一是这个项目基本不维护了，不过不影响它的使用，还有就是因为它很强大，扩展性强，比其他的回测框架更不易于掌握。</p><p>本文介绍如何使用 backtrader 回测双均线交易策略，将包含基本的进出场、风险控制，参数优化等，还有如何加载分钟数据尽可能模拟真实场景。我暂时先用双均线策略上手 backtrader，后续还会使用 backtrader 回测更多的策略。</p><h2 id=策略定义>策略定义</h2><p><strong>选择品种</strong></p><ul><li>暂定 BTC 作为回测品种，虽然这个策略在它上面的表现不算很好。</li></ul><p><strong>技术指标</strong></p><ul><li>EMA，即指数移动均线，均线指标种类繁多，如 SMA、WMA 等；</li><li>ATR，真实波动幅度，用于控制止损；</li></ul><p><strong>策略参数</strong></p><ul><li>short_period：短均线周期；</li><li>long_period：长均线的周期</li><li>atr_period： 真实波动振幅的计算周期，一般固定为 14 即可。</li></ul><p><strong>入场条件</strong></p><ul><li>做多：短均线上穿长均线。</li><li>做空：短均线下穿长均线。</li></ul><p><strong>出场条件</strong></p><ul><li>平多：短均线下穿长均线。</li><li>平空：短均线上穿长均线。</li></ul><p><strong>风险控制</strong></p><p>为了防止出现过于大的止损金额，设置固定的止损位置并通过止损位置推算最大亏损金额。</p><ul><li>止损位置：当前价格 - n 倍 ATR；</li><li>最大亏损：每笔交易的最大亏损金额不超过账户的 2%，按次目标推算实际下单金额。</li></ul><p>这是个非常简单的策略，只是相对于最简单版本的均线交叉策略，加上了风险控制。</p><h2 id=依赖库>依赖库</h2><p>安装依赖的 Python 库。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install backtrader yfinance
</span></span></code></pre></td></tr></table></div></div><h2 id=主流程>主流程</h2><p>通过 backtrader 回测策略，在主函数要提前做一些设置，如设置费率、滑点、账户金额。此外还有加载数据源和策略。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> backtrader <span style=color:#66d9ef>as</span> bt
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> yfinance <span style=color:#66d9ef>as</span> yf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 策略逻辑，暂空</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MACrossStrategy</span>(bt<span style=color:#f92672>.</span>Strategy):
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>  cerebro <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>Cerebro()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 数字货币交易 taker 的手续费一般是这个数字。</span>
</span></span><span style=display:flex><span>  cerebro<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>setcommission(<span style=color:#ae81ff>0.0005</span>) 
</span></span><span style=display:flex><span>  cerebro<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>set_slippage_perc(<span style=color:#ae81ff>0.0001</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># 初始资金为 1百万个货币单位</span>
</span></span><span style=display:flex><span>  cerebro<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>setcash(<span style=color:#ae81ff>1e6</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  data <span style=color:#f92672>=</span> yf<span style=color:#f92672>.</span>download(tickers<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;BTC-USD&#39;</span>,
</span></span><span style=display:flex><span>                     start<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2020-01-01&#39;</span>,
</span></span><span style=display:flex><span>                     end<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2025-04-16&#39;</span>,
</span></span><span style=display:flex><span>                     interval<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;1d&#39;</span>,
</span></span><span style=display:flex><span>                     multi_level_index<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>  cerebro<span style=color:#f92672>.</span>adddata(bt<span style=color:#f92672>.</span>feeds<span style=color:#f92672>.</span>PandasData(dataname<span style=color:#f92672>=</span>data))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cerebro<span style=color:#f92672>.</span>addstrategy(MACrossStrategy)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  print(<span style=color:#e6db74>&#34;初始净值：&#34;</span>, cerebro<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>getvalue())
</span></span><span style=display:flex><span>  cerebro<span style=color:#f92672>.</span>run()
</span></span><span style=display:flex><span>  print(<span style=color:#e6db74>&#34;最终净值：&#34;</span>, cerebro<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>getvalue())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  cerebro<span style=color:#f92672>.</span>plot()
</span></span></code></pre></td></tr></table></div></div><p>backtrader 中的 <code>Cerebro</code> 类型是核心大脑，其他的组件都是围绕着它进行配置。</p><p>这段代码的核心内容包括：</p><ul><li>设置费率为万五，滑点为万1，初始资金为 1e6，即 1百万货币单位。</li><li>开始回测前，添加标的数据，通过 <code>yfinance</code> 下载数据，如加载 <code>BTC-USD</code> 的历史行情。</li><li>接着加载要回测的策略 <code>MACrossStrategy</code>，继承自 <code>bt.Strategy</code>。</li><li>最后运行回测并输出策略前后的账户净值数据并绘制图。</li></ul><p>策略还没有实现任何的交易逻辑，如果运行回测，你会看到前后的账户资产没有变化。</p><h2 id=策略实现>策略实现</h2><p>实现一个策略有两个步骤，分别是计算指标和策略逻辑两个部分，分别对应于 <code>MACrossStrategy</code> 的 <code>__init__</code> 和 <code>next</code> 函数。</p><h3 id=计算指标>计算指标</h3><p>计算这个策略用到的三个指标，分别是 <code>short_ma</code>、<code>long_ma</code> 和 <code>atr</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MACrossStrategy</span>(bt<span style=color:#f92672>.</span>Strategy):
</span></span><span style=display:flex><span>  params <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>      (<span style=color:#e6db74>&#34;short_period&#34;</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>      (<span style=color:#e6db74>&#34;long_period&#34;</span>, <span style=color:#ae81ff>20</span>),
</span></span><span style=display:flex><span>      (<span style=color:#e6db74>&#34;atr_period&#34;</span>, <span style=color:#ae81ff>14</span>),
</span></span><span style=display:flex><span>  )
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>short_ma <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>EMA(period<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>short_period)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>long_ma <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>EMA(period<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>long_period)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>atr <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>ATR(period<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>atr_period)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># 短均线上穿长均线</span>
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>crossover <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>CrossUp(self<span style=color:#f92672>.</span>short_ma, self<span style=color:#f92672>.</span>long_ma)
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>crossunder <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>ind<span style=color:#f92672>.</span>CrossDown(self<span style=color:#f92672>.</span>short_ma, self<span style=color:#f92672>.</span>long_ma)
</span></span></code></pre></td></tr></table></div></div><p>这里将计算指标要用到的周期参数化，以便于后续优化。而且为了便于后续交易逻辑判断，通过 backtrader 的 <code>crossover</code> 和 <code>crossunder</code> 辅助函数判断均线的金叉死叉。</p><p>backtrader 支持的指标繁多，可通过几行代码拿到支持的常见指标：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>indicators <span style=color:#f92672>=</span> [attr <span style=color:#66d9ef>for</span> attr <span style=color:#f92672>in</span> dir(bt<span style=color:#f92672>.</span>ind) <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> attr<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#39;_&#39;</span>)]
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;Backtrader支持的内置指标:&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> idx, indicator <span style=color:#f92672>in</span> enumerate(sorted(indicators), <span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>idx<span style=color:#e6db74>}</span><span style=color:#e6db74>. </span><span style=color:#e6db74>{</span>indicator<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Backtrader支持的内置指标:
</span></span><span style=display:flex><span>1. ADX
</span></span><span style=display:flex><span>2. ADXR
</span></span><span style=display:flex><span>3. AO
</span></span><span style=display:flex><span>4. APO
</span></span><span style=display:flex><span>5. ATR
</span></span><span style=display:flex><span>...
</span></span></code></pre></td></tr></table></div></div><p>如果熟悉 talib，也可以通过使用它。backtrader 内置支持了 talib。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>short_ma <span style=color:#f92672>=</span> bt.talib.EMA<span style=color:#f92672>(</span>timeperiod<span style=color:#f92672>=</span>self.p.short_period<span style=color:#f92672>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=开仓平仓>开仓平仓</h3><p>交易逻辑部分可分为开仓平仓和风险控制两部分。简单的开仓平仓实现起来较为简单，先介绍这部分的实现。而风险控制要依赖条件单实现，backtrader 是支持条件单的。</p><p>开仓平仓逻辑的代码如下所示：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MACrossStrategy</span>(bt<span style=color:#f92672>.</span>Strategy):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>next</span>(self):
</span></span><span style=display:flex><span>    long_entry <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>crossup[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    short_entry <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>crossdown[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    long_exit <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>crossdown[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    short_exit <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>crossup[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> long_entry:
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>order_target_percent(target<span style=color:#f92672>=</span><span style=color:#ae81ff>0.99</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> short_entry:
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>order_target_percent(target<span style=color:#f92672>=-</span><span style=color:#ae81ff>0.99</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> long_exit:
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elif</span> short_exit:
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>close()
</span></span></code></pre></td></tr></table></div></div><p>按设定规则开平仓，如果短线上穿长线开多，短线下穿长线开空，平仓的条件反之。</p><p>下单方式没有使用 <code>buy</code> 和 <code>sell</code> 方法，直接用了 backtrader 提供的目标订单方法，省掉了下单数量的计算。如果想拿到直接下单大小，<code>order_target_percent</code> 返回了订单 <code>Order</code>，有订单大小 <code>size</code> 属性，这个后面设置止损条件是要用到的。</p><p>backtrader 有个非常重要的 Line 的概念，相对是比较复杂的，这里不展开说了。记住的是，如果要访问当前数据，下标都是 0 开始的，往前看就是 -1、-2，以此类推。所以，<code>self.crossup[0]</code> 就是检查当前短均线是否上穿长均线。</p><p>暂时这里还没有加入风险控制，直接 0.99 的仓位，基本就是全仓了。</p><p>现在可以运行下这个回测。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python main.py
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>初始净值： 1000000.0
</span></span><span style=display:flex><span>最终净值： 3280739.0840676297
</span></span></code></pre></td></tr></table></div></div><p>五年多的时间赚了 3 倍收益，和直接持有 BTC 的这五年收益相比，简直是浪费时间。</p><blockquote><p>完整代码请访问：<a href=https://github.com/poloxue/backtest_strategies/blob/main/movingaverage/backtest/basic.py>双均线策略基础版本</a>。</p></blockquote><h2 id=绘图>绘图</h2><p>回测结束除了可以拿到最终净值，运行 <code>cerebro.plot()</code> 还输出一张图，如下所示：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-04/2025-04-16-macross-using-backtrader-01.png alt></p><p>这个图中有几个部分，分别是净值曲线、交易盈亏点、价格蜡烛图（包括买卖点标注）和技术指标。</p><p>这个图的收益部分显示效果不是很清晰，如果想只看收益曲线，可通过配置 <code>analyzers</code> 拿到收益序列。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>cerebro<span style=color:#f92672>.</span>addanalyzer(bt<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>TimeReturn, _name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;timereturn&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>strat <span style=color:#f92672>=</span> cerebro<span style=color:#f92672>.</span>run()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>returns <span style=color:#f92672>=</span> strat[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>getbyname(<span style=color:#e6db74>&#39;timereturn&#39;</span>)<span style=color:#f92672>.</span>get_analysis()
</span></span><span style=display:flex><span>returns_series <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>Series(returns)
</span></span><span style=display:flex><span>net_value <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> returns_series)<span style=color:#f92672>.</span>cumprod()
</span></span><span style=display:flex><span>ax <span style=color:#f92672>=</span> net_value<span style=color:#f92672>.</span>plot(title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Returns&#34;</span>, figsize<span style=color:#f92672>=</span>(<span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>5</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>end_value <span style=color:#f92672>=</span> net_value<span style=color:#f92672>.</span>iloc[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>end_index <span style=color:#f92672>=</span> net_value<span style=color:#f92672>.</span>index[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ax<span style=color:#f92672>.</span>text(
</span></span><span style=display:flex><span>    end_index,
</span></span><span style=display:flex><span>    end_value,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;End: </span><span style=color:#e6db74>{</span>end_value<span style=color:#e6db74>:</span><span style=color:#e6db74>.2f</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>    ha<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;right&#34;</span>,
</span></span><span style=display:flex><span>    va<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;top&#34;</span>,
</span></span><span style=display:flex><span>    bbox<span style=color:#f92672>=</span>dict(facecolor<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;white&#34;</span>, alpha<span style=color:#f92672>=</span><span style=color:#ae81ff>0.8</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>show()
</span></span></code></pre></td></tr></table></div></div><p>净值曲线如下所示：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-04/2025-04-16-macross-using-backtrader-02-v1.png alt></p><p>其他数据，如行情、指标、交易记录等，然也可以拿出来单独绘图。</p><blockquote><p>完整代码请访问：<a href=https://github.com/poloxue/backtest_strategies/blob/main/movingaverage/backtest/plot_timereturns.py>自定义收益曲线</a>。</p></blockquote><h2 id=评价指标>评价指标</h2><p>从上面的净值曲线图，这个策略的回撤非常大。如果想看最大回撤的具体大小，要添加分析器。夏普比率是同样的思路。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>cerebro<span style=color:#f92672>.</span>addanalyzer(bt<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>DrawDown, _name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;drawdown&#34;</span>)
</span></span><span style=display:flex><span>cerebro<span style=color:#f92672>.</span>addanalyzer(bt<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>DrawDown, _name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;shape_ratio&#34;</span>)
</span></span><span style=display:flex><span>strat <span style=color:#f92672>=</span> cerebro<span style=color:#f92672>.</span>run()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>drawdown <span style=color:#f92672>=</span> strat[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>getbyname(<span style=color:#e6db74>&#34;drawdown&#34;</span>)<span style=color:#f92672>.</span>get_analysis()
</span></span><span style=display:flex><span>sharpe_ratio <span style=color:#f92672>=</span> strat[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>getbyname(<span style=color:#e6db74>&#34;drawdown&#34;</span>)<span style=color:#f92672>.</span>get_analysis()
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;最大回撤&#34;</span>, drawdown[<span style=color:#e6db74>&#34;max&#34;</span>][<span style=color:#e6db74>&#34;drawdown&#34;</span>])
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;夏普比率&#34;</span>, shape_ratio[<span style=color:#e6db74>&#34;shape_raito&#34;</span>])
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>最大回撤 82.12757289556565
</span></span><span style=display:flex><span>夏普比率 0.5393603817365935
</span></span></code></pre></td></tr></table></div></div><p>其他常见的评价指标，基本都可通过配置分析器拿到，如 SQN 指标，这个常用来选择参数优化的最优策略。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>cerebro<span style=color:#f92672>.</span>addanalyzer(bt<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>SQN, _name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sqn&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=策略优化>策略优化</h2><p>暂时先不加入风险控制，尝试优化下双均线策略。</p><p>backtrader 内置网格搜索优化的函数。将前面的 <code>addstrategy</code> 换成 <code>optstrategy</code>，指定参数搜索的范围。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>cerebro<span style=color:#f92672>.</span>optstrategy(
</span></span><span style=display:flex><span>  MACrossStrategy,
</span></span><span style=display:flex><span>  short_period<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>  long_period<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>200</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>为防止不满足条件的参数出现，如 short_period >= long_period，修改下策略实现：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MACrossStrategy</span>(bt<span style=color:#f92672>.</span>Strategy):
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>p<span style=color:#f92672>.</span>short_period <span style=color:#f92672>&gt;=</span> self<span style=color:#f92672>.</span>long_period:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>raise</span> bt<span style=color:#f92672>.</span>StrategySkipError()
</span></span></code></pre></td></tr></table></div></div><p>这样也能提升优化的效率。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>opt_returns <span style=color:#f92672>=</span> cerebro<span style=color:#f92672>.</span>run(optreturn<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span></code></pre></td></tr></table></div></div><p>运行后，将得到一个可遍历列表 <code>opt_returns</code>，它的元素是每个参数组合的数据。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>for</span> opt_return <span style=color:#f92672>in</span> opt_returns:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> len(ret):
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;参数：&#34;</span>, ret[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>params<span style=color:#f92672>.</span>short_period, ret[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>params<span style=color:#f92672>.</span>long_period)
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;净值：&#34;</span>, ret[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>getvalue())
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;夏普：&#34;</span>, ret[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>sharpe<span style=color:#f92672>.</span>get_analysis())
</span></span></code></pre></td></tr></table></div></div><p>现在通过 for 输出各个参数组合的回测结果。</p><p>上面之所以要设置 <code>optreturn=False</code> 是为了拿到策略的完整数据，否则如 <code>.broker.getvalue()</code> 是无法访问的。</p><p>Backtrader 的优化功能和 backtesting.py 不同，它的内置优化功能（cerebro.optstrategy() 和 cerebro.run()）不会自动选择最优策略。它只会执行所有参数组合的回测，并返回每个组合的结果。我还需要分析这些结果并选择最佳参数。</p><p>如选择夏普比率最优的参数组合：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>opt_returns <span style=color:#f92672>=</span> cerebro<span style=color:#f92672>.</span>run(optreturn<span style=color:#f92672>=</span><span style=color:#66d9ef>False</span>)
</span></span><span style=display:flex><span>best_strategy <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ret <span style=color:#f92672>in</span> opt_returns:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(ret):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> best_strategy <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            best_strategy <span style=color:#f92672>=</span> ret[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            best_sharpe_ratio <span style=color:#f92672>=</span> best_strategy<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>sharpe<span style=color:#f92672>.</span>get_analysis()[
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;sharperatio&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>            sharpe_ratio <span style=color:#f92672>=</span> ret[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>sharpe<span style=color:#f92672>.</span>get_analysis()[<span style=color:#e6db74>&#34;sharperatio&#34;</span>]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> best_sharpe_ratio <span style=color:#f92672>&lt;</span> sharpe_ratio:
</span></span><span style=display:flex><span>                best_strategy <span style=color:#f92672>=</span> ret[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>short_period <span style=color:#f92672>=</span> best_strategy<span style=color:#f92672>.</span>params<span style=color:#f92672>.</span>short_period
</span></span><span style=display:flex><span>long_period <span style=color:#f92672>=</span> best_strategy<span style=color:#f92672>.</span>params<span style=color:#f92672>.</span>long_period
</span></span><span style=display:flex><span>sharpe_ratio <span style=color:#f92672>=</span> best_strategy<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>sharpe<span style=color:#f92672>.</span>get_analysis()[<span style=color:#e6db74>&#34;sharperatio&#34;</span>]
</span></span><span style=display:flex><span>max_drawdown <span style=color:#f92672>=</span> best_strategy<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>drawdown<span style=color:#f92672>.</span>get_analysis()[<span style=color:#e6db74>&#34;max&#34;</span>][<span style=color:#e6db74>&#34;drawdown&#34;</span>]
</span></span><span style=display:flex><span>final_value <span style=color:#f92672>=</span> best_strategy<span style=color:#f92672>.</span>broker<span style=color:#f92672>.</span>getvalue()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;参数组合：short </span><span style=color:#e6db74>{</span>short_period<span style=color:#e6db74>}</span><span style=color:#e6db74>, long </span><span style=color:#e6db74>{</span>long_period<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;夏普比率：</span><span style=color:#e6db74>{</span>sharpe_ratio<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;最大回撤：</span><span style=color:#e6db74>{</span>max_drawdown<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;最终净值：</span><span style=color:#e6db74>{</span>final_value<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>参数组合：short 10, long <span style=color:#ae81ff>90</span>
</span></span><span style=display:flex><span>夏普比率：0.9247734042607272
</span></span><span style=display:flex><span>最大回撤：57.21188766636116
</span></span><span style=display:flex><span>最终净值：12699593.957906708
</span></span></code></pre></td></tr></table></div></div><p>你可以设定任意的标准来定义什么是最佳参数组合，backtesting.py 框架默认采用选择 SQN 作为选择评价最优策略标准，backtrader 也可以实现，分析加入 SQN 即可。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>cerebro<span style=color:#f92672>.</span>addanalyzer(bt<span style=color:#f92672>.</span>analyzers<span style=color:#f92672>.</span>SQN, _name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;sqn&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>优化就展开这么多吧！</p><blockquote><p>完整代码请访问：<a href=https://github.com/poloxue/backtest_strategies/blob/main/movingaverage/backtest/optimize_parameters.py>参数优化</a>。</p></blockquote><h2 id=风险控制>风险控制</h2><p>到现在策略就是简单通过均线金叉死叉进行开平仓，完全按照这个标准交易，有可能出现损失过大。</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-04/2025-04-16-macross-using-backtrader-03.png alt></p><p>如上图所示，短线上穿长线开仓做多后，开始快速下跌，从开仓到死叉平仓的损失不可能控，有可能导致异常的损失。</p><p>我想通过设置止损价格解决这个问题，为防止被假止损，采用 n * ATR 计算止损位置。ATR 指标是个波动指标，如果波动太大可能导致不可控的损失。可基于最大损失百分比去反向推算下单金额，如每次最大损失不超过 2%。</p><p>假设 n = 3，在策略中实现这个逻辑，示例代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>target_percent <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.02</span> <span style=color:#f92672>/</span> (<span style=color:#ae81ff>3</span> <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>atr[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>/</span> self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>close[<span style=color:#ae81ff>0</span>])
</span></span></code></pre></td></tr></table></div></div><p>用这个值替代之前每次满仓的 0.99，实现每单的最大损失为总资产的 2%。</p><p>多仓的止损价格：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>stop_price <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>close[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>atr[<span style=color:#ae81ff>0</span>]
</span></span></code></pre></td></tr></table></div></div><p>止损单通过 backtrader 的 stop 类型订单实现。</p><p>基于开仓订单创建止损订单：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>order <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>order_target_percent(target<span style=color:#f92672>=</span>target_percent)
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>stop_sell_order <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sell(
</span></span><span style=display:flex><span>    size<span style=color:#f92672>=</span>order<span style=color:#f92672>.</span>size, exectype<span style=color:#f92672>=</span>bt<span style=color:#f92672>.</span>Order<span style=color:#f92672>.</span>Stop, price<span style=color:#f92672>=</span>stop_price
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>开空单同理：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>order <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>order_target_percent(target<span style=color:#f92672>=</span>target_percent)
</span></span><span style=display:flex><span>self<span style=color:#f92672>.</span>stop_buy_order <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>sell(
</span></span><span style=display:flex><span>    size<span style=color:#f92672>=</span>order<span style=color:#f92672>.</span>size, exectype<span style=color:#f92672>=</span>bt<span style=color:#f92672>.</span>Order<span style=color:#f92672>.</span>Stop, price<span style=color:#f92672>=</span>stop_price
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>这里有个问题，如果仓位平掉后，记得要取消这个止损单，可通过 backtrader 的 <code>notify_trade</code> 回测检查仓位，如发现仓位非做空仓位，取消 <code>stop_buy_order</code>。</p><p>现在，默认参数（short_period=10，long_period=20）运行回测，净值曲线如下：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-04/2025-04-16-macross-using-backtrader-04-v1.png alt></p><p>可以对比下最初的净值曲线：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-04/2025-04-16-macross-using-backtrader-02.png alt></p><p>这里只是增加了一个基本的风险控制，现在的净值曲线比之前稳定了不少。</p><blockquote><p>完整代码请访问：<a href=https://github.com/poloxue/backtest_strategies/blob/main/movingaverage/backtest/risk_control.py>风险控制</a>。</p></blockquote><p>但这还有明显的大涨大跌，如果已经设置了最大损失百分比，应该不至于出现还有这么可怕的波动。</p><p>初步估计这个原因可能是行情数据用的日线数据，价格跳动太大导致的滑点严重。而一旦回撤太大，后续想要翻身的难度也会增加。</p><p>接下来，尝试用 backtrader 加载分钟数据降低滑点。</p><h2 id=重放分钟行情>重放分钟行情</h2><p>backtrader 提供了数据重放 <code>replaydata</code> 加载数据，实现近乎模拟真实的场景。重放 <code>replaydata</code> 通过重放高频数据，事实生成某个周期的行情，如日线、4 小时等，即使这个周期还没闭合。</p><p>我提前下来了 BTCUSDT 的 1分钟数据，将其通过 <code>replaydata</code> 加载到 <code>cerebro</code> 中。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>data <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;btcusdt_1m&#34;</span>,
</span></span><span style=display:flex><span>  parse_dates<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;datetime&#39;</span>],
</span></span><span style=display:flex><span>  index_col<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;datetime&#39;</span>],
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>cerebro<span style=color:#f92672>.</span>replaydata(
</span></span><span style=display:flex><span>  data,
</span></span><span style=display:flex><span>  timeframe<span style=color:#f92672>=</span>bt<span style=color:#f92672>.</span>TimeFrame<span style=color:#f92672>.</span>Minutes,
</span></span><span style=display:flex><span>  compression<span style=color:#f92672>=</span><span style=color:#ae81ff>1440</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>这个地方有一个注意点，如果原始数据是分钟级别的数据，<code>replaydata</code> 的 timeframe 只能是 <code>Minutes</code>，通过 <code>compression</code> 指定合成日线所需的分钟数据量（一天等于 60 * 24 = 1440）。如果是其他周期，如 <code>bt.TimeFrame.Days</code>，重放是无法合成日线数据的。</p><p>策略逻辑的判断部分也有要修改的地方：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>long_entry <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>crossup[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>short_entry <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>crossdown[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>long_exit <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>crossdown[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>short_exit <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>crossup[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></td></tr></table></div></div><p>将原来的获取最新的指标修改为上个周期的指标，原因当然就是，当前的 bar 还没有闭合。</p><p>这个回测耗时相当长，最终得到的回测净值曲线：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-04/2025-04-16-macross-using-backtrader-05.png alt></p><p>从上图看出，通过分钟回测，得到的净值曲线更平缓，虽然从 2022 年以后这个策略不怎么赚钱了，但不至于那么过分的大涨大跌，产生过大的风险。</p><p>这里还有个小问题，如果看上图，偶尔有几个月空仓的情况，那是因为如果是止损单平仓，而非出现金叉死叉触发平仓，可能导致无法重新入场导致丢失掉大趋势。</p><p>重新修正下开仓的判断条件。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>crossup[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>direction <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;long&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>elif</span> self<span style=color:#f92672>.</span>crossdown[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>direction <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;short&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>long_entry <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>direction <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;long&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>close[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&gt;</span> self<span style=color:#f92672>.</span>short_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&gt;</span> self<span style=color:#f92672>.</span>long_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>short_entry <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>    self<span style=color:#f92672>.</span>direction <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;short&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>close[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> self<span style=color:#f92672>.</span>short_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> self<span style=color:#f92672>.</span>long_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>size <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>在出现金叉死叉时才切换下单方向。这个就不想过多解释了。</p><p>净值曲线如下：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-04/2025-04-16-macross-using-backtrader-06.png alt></p><blockquote><p>完整代码请访问：<a href=https://github.com/poloxue/backtest_strategies/blob/main/movingaverage/backtest/replaydata.py>重放模拟回测</a>。</p></blockquote><h2 id=总结>总结</h2><p>本文介绍了如何用 backtrader 回测双均线策略，一步步展开。虽然是一个简单的均线策略，但如果无法正确利用回测框架，可能产生的结果差异较大。</p><p>这个策略表现的并不算好，5 年时间在 BTC 上只有不到 4 倍的收益，有兴趣的话，可继续优化，如将日线切换为小时线，或许会有新的发现哦。</p><blockquote><p>最后特别说明：本文是我用 backtrader 回测双均线的记录，具体代码在文中都有提供，或许有错误，请仔细甄别。</p></blockquote><p>最后，希望本文对你学习 backtrader 策略回测有所帮助。</p><div>本文来源于 <a href=https://www.poloxue.com>POLOXUE's BLOG</a>，地址： <a href=https://www.poloxue.com/posts/2025-04-16-macross-using-backtrader/>掌握 backtrader 策略回测：均线交叉交易系统</a></div></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#策略定义>策略定义</a></li><li><a href=#依赖库>依赖库</a></li><li><a href=#主流程>主流程</a></li><li><a href=#策略实现>策略实现</a><ol><li><a href=#计算指标>计算指标</a></li><li><a href=#开仓平仓>开仓平仓</a></li></ol></li><li><a href=#绘图>绘图</a></li><li><a href=#评价指标>评价指标</a></li><li><a href=#策略优化>策略优化</a></li><li><a href=#风险控制>风险控制</a></li><li><a href=#重放分钟行情>重放分钟行情</a></li><li><a href=#总结>总结</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><img style=width:85% src=https://cdn.jsdelivr.net/gh/poloxue/images@main/wechat.png><div class=utterances></div><script src=https://utteranc.es/client.js repo=poloxue/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2025 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>
<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Go 中 struct tag 如何用？基于它实现字段级别的访问控制 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Go 中 struct tag 如何用？基于它实现字段级别的访问控制"><meta itemprop=description content="在Go 中，结构体主要是用于定义复杂数据类型。而 struct tag 则是附加在 struct 字段后的字符串，提供了一种方式来存储关于字段的元信息。然后，tag 在程序运行时不会直接影响程序逻辑。"><meta itemprop=datePublished content="2024-01-28T18:56:59+08:00"><meta itemprop=dateModified content="2024-01-28T18:56:59+08:00"><meta itemprop=wordCount content="530"><meta itemprop=keywords content><meta property="og:title" content="Go 中 struct tag 如何用？基于它实现字段级别的访问控制"><meta property="og:description" content="在Go 中，结构体主要是用于定义复杂数据类型。而 struct tag 则是附加在 struct 字段后的字符串，提供了一种方式来存储关于字段的元信息。然后，tag 在程序运行时不会直接影响程序逻辑。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2024-01-29-struct-tag-uses-in-golang/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-28T18:56:59+08:00"><meta property="article:modified_time" content="2024-01-28T18:56:59+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go 中 struct tag 如何用？基于它实现字段级别的访问控制"><meta name=twitter:description content="在Go 中，结构体主要是用于定义复杂数据类型。而 struct tag 则是附加在 struct 字段后的字符串，提供了一种方式来存储关于字段的元信息。然后，tag 在程序运行时不会直接影响程序逻辑。"><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.png alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/posts/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts>文章列表</a></li><li><a href=/tags>分类标签</a></li><li><a href=/about/>关于我</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>28</span>
<span class=rest>Jan 2024</span></div></div><div class=matter><h1 class=title>Go 中 struct tag 如何用？基于它实现字段级别的访问控制</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#struct-tag-是什么>struct tag 是什么？</a></li><li><a href=#具体有什么用呢>具体有什么用呢？</a></li><li><a href=#常见使用场景>常见使用场景</a><ol><li><a href=#jsonxml-序列反序列化>JSON/XML 序列反序列化</a></li><li><a href=#数据库操作>数据库操作</a></li><li><a href=#数据验证>数据验证</a></li></ol></li><li><a href=#tag-行为自定义>tag 行为自定义</a></li><li><a href=#案例结构体字段访问控制>案例：结构体字段访问控制</a><ol><li><a href=#定义结构体>定义结构体</a></li><li><a href=#实现权限控制>实现权限控制</a></li><li><a href=#使用演示>使用演示</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></aside><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-01/2024-01-26-struct-tag-uses-in-golang-01.png alt></p><blockquote><p>嗨，大家好！本文是系列文章 Go 小技巧第十篇，系列文章查看：<a href="https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&amp;album_id=3291066778475053060">Go 语言小技巧</a>。</p></blockquote><p>在 Go 中，结构体主要是用于定义复杂数据类型。而 struct tag 则是附加在 struct 字段后的字符串，提供了一种方式来存储关于字段的元信息。然后，tag 在程序运行时不会直接影响程序逻辑。</p><p>本文将会基于这个主题展开，讨论 Go 中的结构体 tag 究竟是什么？我们该如何利用它？另外，文末还提供了一个实际案例，帮助我们进一步提升对 struct tag 的理解。</p><h2 id=struct-tag-是什么>struct tag 是什么？</h2><p>如下是一个定义了 tag 的结构体 Person 类型。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Age</span>  <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`json:&#34;age&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>例子中，<code>json:"name"</code>和<code>json:"age"</code> 就是结构体 tag。结构体 tag 的使用非常直观。你只需要在定义结构体字段后，通过反引号 `` 包裹起来的键值对形式就可定义它们。</p><h2 id=具体有什么用呢>具体有什么用呢？</h2><p>这个 tag 究竟有什么用呢？为何要定义它们。</p><p>单从这个例子中来看，假设你是在 &ldquo;encoding/json&rdquo; 库中使用 <code>Person</code> 结构体，它是告诉 Go 在处理 JSON 序列化和反序列化时，字段名称的转化规则。</p><p>让我们通过它在 &ldquo;encoding/json&rdquo; 的使用说明它的效果吧。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Person</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;John&#34;</span>, <span style=color:#a6e22e>Age</span>: <span style=color:#ae81ff>30</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>jsonData</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>jsonData</span>)) 
</span></span></code></pre></td></tr></table></div></div><p>输出:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;John&#34;</span>,<span style=color:#f92672>&#34;age&#34;</span>:<span style=color:#ae81ff>30</span>}
</span></span></code></pre></td></tr></table></div></div><p>可以看到输出的 JSON 的 <code>key</code> 是 name 和 age，而非 Name 和 Age。</p><p>与其他语言对比的话，虽然 Go 的 struct tag 在某种程度上类似于 Java 的注解或 C# 的属性，但 Go 的 tag 更加简洁，并且主要通过反射机制在运行时被访问。</p><p>这种设计反映了Go语言的哲学：简单、直接而有效。但确实也是功能有限！</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-01/2024-01-26-struct-tag-uses-in-golang-02-v2.png alt></p><h2 id=常见使用场景>常见使用场景</h2><p>结构体 tag 在 Go 语言中常见用途，我平时最常见有如下这些。</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-01/2024-01-26-struct-tag-uses-in-golang-05.png alt></p><h3 id=jsonxml-序列反序列化>JSON/XML 序列反序列化</h3><p>如前面的介绍的案例中，通过 <code>encoding/json</code> 或者其他的库如 <code>encoding/xml</code> 库，tag 可以控制如何将结构体字段转换为 JSON 或 XML，或者如何从它们转换回来。</p><h3 id=数据库操作>数据库操作</h3><p>在ORM（对象关系映射）库中，tag 可以定义数据库表的列名、类型或其他特性。</p><p>如我们在使用 Gorm 时，会看到这样的定义：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>User</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gorm</span>.<span style=color:#a6e22e>Model</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>   <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`gorm:&#34;type:varchar(100);unique_index&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Age</span>    <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`gorm:&#34;index:age&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Active</span> <span style=color:#66d9ef>bool</span>   <span style=color:#e6db74>`gorm:&#34;default:true&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>结构体 tag 可用于定义数据库表的列名、类型或其他特性。</p><h3 id=数据验证>数据验证</h3><p>在一些库中，tag 用于验证数据，例如，确保一个字段是有效的电子邮件地址。</p><p>如下是 <a href=github.com/asaskevich/govalidator>govalidator</a> 使用结构体上 tag 实现定义数据验证规则的一个案例。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>User</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Email</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`valid:&#34;email&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Age</span>   <span style=color:#66d9ef>int</span>    <span style=color:#e6db74>`valid:&#34;range(18|99)&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在这个例子中，valid tag 定义了字段的验证规则，如 <code>email</code> 字段值是否是有效的 <code>email</code>，<code>age</code> 字段是否满足数值在 18 到 99 之间等。</p><p>我们只要将类型为 <code>User</code> 类型的变量交给 <code>govalidator</code>，它可以根据这些规则来验证数据，确保数据的正确性和有效性。</p><p>示例如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>valid</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>govalidator</span>.<span style=color:#a6e22e>ValidateStruct</span>(<span style=color:#a6e22e>User</span>{<span style=color:#a6e22e>Email</span>: <span style=color:#e6db74>&#34;test@example.com&#34;</span>, <span style=color:#a6e22e>Age</span>: <span style=color:#ae81ff>20</span>})
</span></span></code></pre></td></tr></table></div></div><p>返回的 <code>valid:</code> 为 <code>true</code> 或 <code>false</code>，如果发生错误，<code>err</code> 提供具体的错误原因。</p><h2 id=tag-行为自定义>tag 行为自定义</h2><p>前面展示的都是利用标准库或三方库提供的能力，如果想自定义 tag 该如何实现？毕竟有些情况下，如果默认提供的 tag 提供的能力不满足需求，我们还是希望可以自定义 tag 的行为。</p><p>这需要了解与理解 Go 的反射机制，它为数据处理和元信息管理提供了强大的灵活性。</p><p>如下的示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`mytag:&#34;MyName&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>TypeOf</span>(<span style=color:#a6e22e>Person</span>{})
</span></span><span style=display:flex><span><span style=color:#a6e22e>field</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>FieldByName</span>(<span style=color:#e6db74>&#34;Name&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Tag</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;mytag&#34;</span>)) <span style=color:#75715e>// 输出: MyName
</span></span></span></code></pre></td></tr></table></div></div><p>在这个例子中，我们的 <code>Person</code> 的字段 <code>Name</code> 有一个自定义的 tag - <code>mytag</code>，我们直接通过反射就可以访问它。</p><p>这只是简单的演示如何访问到 tag。如何使用它呢？</p><p>这就要基于实际的场景了，当然，这通常也离不开与反射配合。下面我们来通过一个实际的例子介绍。</p><h2 id=案例结构体字段访问控制>案例：结构体字段访问控制</h2><p>让我们考虑一个实际的场景：一个结构访问控制系统。</p><p>这个系统中，我们可以根据用户的角色（如 admin、user）或者请求的来源（admin、web）控制对结构体字段的访问。具体而言，假设我定义了一个包含敏感信息的结构体，我可以使用自定义 tag 来标记每个字段的访问权限。</p><p>是不是想到，这或许可用在 API 接口范围字段的控制上，防止泄露敏感数据给用户。</p><p>接下来，具体看看如何做吧？</p><h3 id=定义结构体>定义结构体</h3><p>我们首先定义一个<code>UserProfile</code>结构体，其中包含用户的各种信息。每个信息字段都有一个自定义的 <code>access</code> tag，用于标识字段访问权限（<code>admin</code>或<code>user</code>）。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>UserProfile</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Username</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`access:&#34;user&#34;`</span>  <span style=color:#75715e>// 所有用户可见
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Email</span>       <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`access:&#34;user&#34;`</span>  <span style=color:#75715e>// 所有用户可见
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>PhoneNumber</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`access:&#34;admin&#34;`</span> <span style=color:#75715e>// 仅管理员可见
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Address</span>     <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`access:&#34;admin&#34;`</span> <span style=color:#75715e>// 仅管理员可见
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></td></tr></table></div></div><p>其中，<code>PhoneNumber</code> 和 <code>Address</code> 是敏感字段，它只对 admin 角色可见。而 <code>UserName</code> 和 <code>Email</code> 则是所有用户可见。</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-01/2024-01-26-struct-tag-uses-in-golang-04-v1.png alt></p><p>到此，结构体 <code>UserProfile</code> 定义完成。</p><h3 id=实现权限控制>实现权限控制</h3><p>接下来就是要实现一个函数，实现根据 <code>UserProfile</code> 定义的 <code>access</code> tag 决定字段内容的可见性。</p><p>假设函数名称为 <code>FilterFieldsByRole</code>，它接受一个 <code>UserProfile</code> 类型变量和用户角色，返回内容一个过滤后的 <code>map</code>（由 fieldname 到 fieldvalue 组成的映射），其中只包含角色有权访问的字段。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>FilterFieldsByRole</span>(<span style=color:#a6e22e>profile</span> <span style=color:#a6e22e>UserProfile</span>, <span style=color:#a6e22e>role</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>reflect</span>.<span style=color:#a6e22e>ValueOf</span>(<span style=color:#a6e22e>profile</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>typ</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>Type</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>NumField</span>(); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>field</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>typ</span>.<span style=color:#a6e22e>Field</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>accessTag</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Tag</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;access&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>accessTag</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;user&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>accessTag</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>role</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取字段名称
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>fieldName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>ToLower</span>(<span style=color:#a6e22e>field</span>.<span style=color:#a6e22e>Name</span>) 
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 获取字段值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>fieldValue</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>Field</span>(<span style=color:#a6e22e>i</span>).<span style=color:#a6e22e>String</span>() 
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 组织返回结果 result
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>result</span>[<span style=color:#a6e22e>fieldName</span>] = <span style=color:#a6e22e>fieldValue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>权限控制的重点逻辑部分，就是 <code>if accessTag == "user" || accessTag == role</code> 这段判断条件。当满足条件之后，接下来要做的就是通过反射获取字段名称和值，并组织目标的 Map 类变量 <code>result</code>了。</p><h3 id=使用演示>使用演示</h3><p>让我们来使用下 <code>FilterFieldsByRole</code> 函数，检查下是否满足按角色访问特定的用户信息的功能。</p><p>示例代码如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>profile</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>UserProfile</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Username</span>:    <span style=color:#e6db74>&#34;johndoe&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Email</span>:       <span style=color:#e6db74>&#34;johndoe@example.com&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PhoneNumber</span>: <span style=color:#e6db74>&#34;123-456-7890&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Address</span>:     <span style=color:#e6db74>&#34;123 Elm St&#34;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 假设当前用户是普通用户
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>userInfo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>FilterFieldsByRole</span>(<span style=color:#a6e22e>profile</span>, <span style=color:#e6db74>&#34;user&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>userInfo</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 假设当前用户是管理员
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>adminInfo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>FilterFieldsByRole</span>(<span style=color:#a6e22e>profile</span>, <span style=color:#e6db74>&#34;admin&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>adminInfo</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>map<span style=color:#f92672>[</span>username:johndoe email:johndoe@example.com<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>map<span style=color:#f92672>[</span>username:johndoe email:johndoe@example.com phonenumber:123-456-7890 address:123 Elm St<span style=color:#f92672>]</span>
</span></span></code></pre></td></tr></table></div></div><p>这个场景，通过自定义结构体 tag，给予指定角色，很轻松地就实现了一个基于角色的权限控制。</p><p>毫无疑问，这个代码更加清晰和可维护，而且具有极大灵活性、扩展性。如果想扩展更多角色，也是更加容易。</p><p>不过还是要说明下，如果在 API 层面使用这样的能力，还是要考虑反射可能带来的性能影响。</p><h2 id=总结>总结</h2><p>这篇博文介绍了Go语言中结构体 tag 的基础知识，如是什么，如何使用。另外，还介绍了它们在不同场景下的应用。通过简单的例子和对比，我们看到了 Go 中结构体 tag 的作用。</p><p>文章的最后，通过一个实际案例，演示了如何使用 struct tag 使我们代码更加灵活强大。虽然 struct tag 的使用非常直观，但正确地利用这些 tag 可以极大提升我们程序的功能和效率。</p><p>博文地址：<a href=https://www.poloxue.com/posts/2024-01-26-struct-tag-uses-in-golang/>Go 中 struct tag 如何用？基于它实现字段级别的访问控制</a></p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#struct-tag-是什么>struct tag 是什么？</a></li><li><a href=#具体有什么用呢>具体有什么用呢？</a></li><li><a href=#常见使用场景>常见使用场景</a><ol><li><a href=#jsonxml-序列反序列化>JSON/XML 序列反序列化</a></li><li><a href=#数据库操作>数据库操作</a></li><li><a href=#数据验证>数据验证</a></li></ol></li><li><a href=#tag-行为自定义>tag 行为自定义</a></li><li><a href=#案例结构体字段访问控制>案例：结构体字段访问控制</a><ol><li><a href=#定义结构体>定义结构体</a></li><li><a href=#实现权限控制>实现权限控制</a></li><li><a href=#使用演示>使用演示</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><img style=width:85% src=https://cdn.jsdelivr.net/gh/poloxue/images@main/wechat.png><div class=utterances></div><script src=https://utteranc.es/client.js repo=poloxue/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>
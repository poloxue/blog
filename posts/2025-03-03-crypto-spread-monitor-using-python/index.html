<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>开发了一个加密货币跨市场价差监控工具 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="开发了一个加密货币跨市场价差监控工具"><meta itemprop=description content="我开发了一个加密货币跨交易所价差的监控工具。"><meta itemprop=datePublished content="2025-03-03T11:16:08+08:00"><meta itemprop=dateModified content="2025-03-03T11:16:08+08:00"><meta itemprop=wordCount content="299"><meta itemprop=keywords content><meta property="og:title" content="开发了一个加密货币跨市场价差监控工具"><meta property="og:description" content="我开发了一个加密货币跨交易所价差的监控工具。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2025-03-03-crypto-spread-monitor-using-python/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-03T11:16:08+08:00"><meta property="article:modified_time" content="2025-03-03T11:16:08+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="开发了一个加密货币跨市场价差监控工具"><meta name=twitter:description content="我开发了一个加密货币跨交易所价差的监控工具。"><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script>
<script>MathJax={tex:{displayMath:[["[","]"],["$$","$$"]],inlineMath:[["(",")"],["$","$"]]}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.png alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/posts/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>文章列表</a></li><li><a href=/tags>分类标签</a></li><li><a href=/about/about>关于我</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>03</span>
<span class=rest>Mar 2025</span></div></div><div class=matter><h1 class=title>开发了一个加密货币跨市场价差监控工具</h1></div></div><p>前两周发了一篇关于如何监控加密货币跨市场套利监控的文章，介绍了基础的实现思路和示例代码。有不少朋友对这个内容表现出了浓厚的兴趣，也有人想要这样一个监控工具。</p><p>上周我将示例代码重新整合，开发了一个终端监控工具，也修复了之前示例中的一些 bug，。如果还不是了解的，查看前文 <a href=https://www.poloxue.com/posts/2025-02-16-arbitrage-between-cryptocurrency-exchanges-using-ccxt/>实时监控加密货币跨交易所的套利机会</a>。</p><h2 id=使用示例>使用示例</h2><p>接下来，演示下在不同市场间的监控案例。提示：可使用 <code>Ctrl+q</code> 退出监控终端。</p><p>基于最新成交（Binance 现货和 OKX 正向永续合约的全量监控)：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python main.py --monitor-panel ticker <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --market-a binance.spot <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --market-b okx.swap.linear
</span></span></code></pre></td></tr></table></div></div><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-03/2025-03-03-cypto-spread-monitor-using-python-02.gif alt></p><p>如上所示，默认展示的 USDT 合约，如果要切换成 USDC，可通过选项 <code>--quote-currency USDT</code> 实现。</p><p>而排序规则上，固定按价差百分比从大到小排序。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python main.py --monitor-panel ticker <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --market-a binance.spot <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --market-b okx.swap.linear <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --quote-currency USDC
</span></span></code></pre></td></tr></table></div></div><p>如果是反向合约，如 <code>binance.swap.invese</code>，计价币种要切换成 USD，配置选项 <code>--quote-currency USD</code>。</p><p>当前版本的这个工具虽然是通过 asyncio 异步 IO 实现，但单进程的工具。全量监控时，计算速度慢，实时性影响较大。如上图所示，延迟在秒级别。建议加上 &ndash;symbols 来明确监控范围，如 <code>--symbols BTC-USDT,ETH-USDT,XRP-USDT,TRUMP-USDT</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python main.py --monitor-panel ticker <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --market-a binance.spot <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --market-b okx.swap.linear <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --symbols BTC-USDT,ETH-USDT
</span></span></code></pre></td></tr></table></div></div><p>除了 ticker 价差监控，这个工具还实现了订单簿的价差监控，如下所示：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python main.py --monitor-panel orderbook <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --market-a binance.spot <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --market-b okx.swap.linear <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>                 --symbols TRUMP-USDT,BTC-USDT,ETH-USDT,SOL-USDT,ADA-USDT,BNB-USDT,XRP-USDT
</span></span></code></pre></td></tr></table></div></div><p>通过 <code>--monitor-panel</code> 切换监控类型为通过 orderbook 订单薄计算价差。</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-03/2025-03-03-cypto-spread-monitor-using-python-01.gif alt></p><p>这个价差是基于挂单最佳买卖单计算而来。</p><p>挂单的消息数据量比 ticker 数据要高，如果全量监控的话，延迟能到 10秒以上的延迟。</p><h2 id=源码下载>源码下载</h2><p>我已经将这个工具的代码放在了 Github 上，通过 Git 即可下载代码仓库。</p><p>命令如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ git clone https://github.com/poloxue/seekopt
</span></span><span style=display:flex><span>$ cd seekopt
</span></span><span style=display:flex><span>$ pip install -r requirements.txt
</span></span></code></pre></td></tr></table></div></div><p>说实话，我没有测试过 <code>requirements.txt</code> 中的依赖是否完整，如果遇到问题，可以在仓库 issue 中说明，或者加我微信。</p><h2 id=web-服务>web 服务</h2><p>这个监控工具的界面用的是 textual 开发的，textual 是一个 Tui 终端应用开发库。我暂时还不想整 Web 开发，就先用它实现了。</p><p>如果有意将其通过 web 访问，textual 也有命令可将其作为 web 服务。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ textual serve <span style=color:#e6db74>&#34;python main.py \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                                --market-a binance.swap.linear \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                                --market-b bybit.swap.linear&#34;</span>
</span></span><span style=display:flex><span>___ ____ _  _ ___ _  _ ____ _       ____ ____ ____ _  _ ____
</span></span><span style=display:flex><span> |  |___  <span style=color:#ae81ff>\/</span>   |  |  | |__| |    __ <span style=color:#f92672>[</span>__  |___ |__/ |  | |___
</span></span><span style=display:flex><span> |  |___ _/<span style=color:#ae81ff>\_</span>  |  |__| |  | |___    ___<span style=color:#f92672>]</span> |___ |  <span style=color:#ae81ff>\ </span> <span style=color:#ae81ff>\/</span>  |___ v1.1.1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Serving <span style=color:#e6db74>&#39;python main.py --market-a binance.swap.linear --market-b bybit.swap.linear&#39;</span>
</span></span><span style=display:flex><span>on http://localhost:8000
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Press Ctrl+C to quit
</span></span></code></pre></td></tr></table></div></div><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-03/2025-03-03-cypto-spread-monitor-using-python-03.png alt></p><p>不过有个问题，这种方式提供的 web 服务，如果是多人使用，好像不是共享同一个监控脚本，这会导致资源的重复占用。</p><h2 id=适用市场>适用市场</h2><p>这个工具是基于 ccxt 实现，按理说 ccxt 支持的市场都是支持的，不过我测试的时候，也发现了一些不适配的情况。我当前只测试了 binance、okx 和 bybit 三个交易所。</p><p>参数 market 格式是 <code>exchange.type.subtype</code>，支持类型如下所示：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>exchange.spot -&gt; 现货
</span></span><span style=display:flex><span>exchange.spot.margin -&gt; 保证金杠杆
</span></span><span style=display:flex><span>exchange.swap.linear -&gt; 永续正向合约
</span></span><span style=display:flex><span>exchange.swap.inverse -&gt; 永续反向合约
</span></span><span style=display:flex><span>exchagne.future.linear -&gt; 交割正向合约 
</span></span><span style=display:flex><span>exchagne.future.inverse -&gt; 交割反向合约
</span></span></code></pre></td></tr></table></div></div><p>使用时，请把 exchange 替换为具体的交易所名称。</p><h2 id=实时性>实时性</h2><p>如果全量监控所有交易对，延迟会比较大，建议指定 symbols 限制监听的交易对数量。如果想提高实时性，最简单的方案多启动几个程序，按批次监听不同的交易列表。</p><p>我现在不确定这个工具是否确有需求，如果确有需求，我后续会考虑加入多进程和分布式能力，提升这个工具的实时性能。</p><h2 id=延迟计算>延迟计算</h2><p>关于这个监控工具上的实时性数值，是在计算价差时的时间减去消息上的时间戳得到。</p><p>这里有个问题，本地时钟和服务器时钟可能是不一样的。为了解决这个问题，程序会定时同步交易所的 servertime，计算与本地时间的偏差保持两边的同步，但获取服务器时间也有网络延迟，虽然说有粗略的方法计算这个延迟，但如果网络不好，有可能看到延迟时间是负数。</p><p>另外的方案，或许可以设置机器同步的 ntp server，保持和交易所时钟同步。这个或许可以尝试下。不过我没找到交易所用的是什么 ntp 服务器。</p><h2 id=总结>总结</h2><p>这个价差监控工具还只是个初版实现。如果使用时遇到的什么问题或时有什么想法，请提出来，我会继续优化改进。</p><p>最后，希望本文对你有用。</p><div>本文来源于 <a href=https://www.poloxue.com>POLOXUE's BLOG</a>，地址： <a href=https://www.poloxue.com/posts/2025-03-03-crypto-spread-monitor-using-python/>开发了一个加密货币跨市场价差监控工具</a><hr class=footer-separator><div class=tags></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post>欢迎关注我的公众号：<img style=width:85% src=https://cdn.jsdelivr.net/gh/poloxue/images@main/wechat.png><div class=utterances></div><script src=https://utteranc.es/client.js repo=poloxue/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2025 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script></body></html>
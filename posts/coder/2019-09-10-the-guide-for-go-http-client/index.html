<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Go 的 Http 请求系统指南 - POLOXUE's 博客频道</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Go 的 Http 请求系统指南"><meta itemprop=description content="前几天在 &ldquo;知乎想法&rdquo; 谈到了一个话题，如何模仿学习，举了通过 net/http client 模仿 Pyhton 的requests的例子。但并未实践，难道想法真的只能是想法吗？当然不是，于是我决定先暂停一周 GO 笔记，来实践下自己的想法。
有些新的知识，我们可以通过模仿学习
本文将通过 GO 实现 requests 的 quick start 文档中的所有例子，系统学习http client的使用。虽然标题是 quick start，但其实内容挺多的。
快速体验 首先，我们来发起一个 GET 请求，代码非常简单。如下：
func get() { r, err := http.Get(&#34;https://api.github.com/events&#34;) if err != nil { panic(err) } defer func() { _ = r.Body.Close() }() body, _ := ioutil.ReadAll(r.Body) fmt.Printf(&#34;%s&#34;, body) } 通过 http.Get 方法，获取到了一个 Response 和一个 error ，即 r 和 err。通过 r 我们能获取响应的信息，err 可以实现错误检查。
r.Body 被读取后需要关闭，可以defer来做这件事。内容的读取可通过 ioutil.ReadAll实现。"><meta itemprop=datePublished content="2019-09-10T16:37:17+08:00"><meta itemprop=dateModified content="2019-09-10T16:37:17+08:00"><meta itemprop=wordCount content="1296"><meta itemprop=keywords content="Golang,"><meta property="og:title" content="Go 的 Http 请求系统指南"><meta property="og:description" content="前几天在 &ldquo;知乎想法&rdquo; 谈到了一个话题，如何模仿学习，举了通过 net/http client 模仿 Pyhton 的requests的例子。但并未实践，难道想法真的只能是想法吗？当然不是，于是我决定先暂停一周 GO 笔记，来实践下自己的想法。
有些新的知识，我们可以通过模仿学习
本文将通过 GO 实现 requests 的 quick start 文档中的所有例子，系统学习http client的使用。虽然标题是 quick start，但其实内容挺多的。
快速体验 首先，我们来发起一个 GET 请求，代码非常简单。如下：
func get() { r, err := http.Get(&#34;https://api.github.com/events&#34;) if err != nil { panic(err) } defer func() { _ = r.Body.Close() }() body, _ := ioutil.ReadAll(r.Body) fmt.Printf(&#34;%s&#34;, body) } 通过 http.Get 方法，获取到了一个 Response 和一个 error ，即 r 和 err。通过 r 我们能获取响应的信息，err 可以实现错误检查。
r.Body 被读取后需要关闭，可以defer来做这件事。内容的读取可通过 ioutil.ReadAll实现。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/coder/2019-09-10-the-guide-for-go-http-client/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-10T16:37:17+08:00"><meta property="article:modified_time" content="2019-09-10T16:37:17+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go 的 Http 请求系统指南"><meta name=twitter:description content="前几天在 &ldquo;知乎想法&rdquo; 谈到了一个话题，如何模仿学习，举了通过 net/http client 模仿 Pyhton 的requests的例子。但并未实践，难道想法真的只能是想法吗？当然不是，于是我决定先暂停一周 GO 笔记，来实践下自己的想法。
有些新的知识，我们可以通过模仿学习
本文将通过 GO 实现 requests 的 quick start 文档中的所有例子，系统学习http client的使用。虽然标题是 quick start，但其实内容挺多的。
快速体验 首先，我们来发起一个 GET 请求，代码非常简单。如下：
func get() { r, err := http.Get(&#34;https://api.github.com/events&#34;) if err != nil { panic(err) } defer func() { _ = r.Body.Close() }() body, _ := ioutil.ReadAll(r.Body) fmt.Printf(&#34;%s&#34;, body) } 通过 http.Get 方法，获取到了一个 Response 和一个 error ，即 r 和 err。通过 r 我们能获取响应的信息，err 可以实现错误检查。
r.Body 被读取后需要关闭，可以defer来做这件事。内容的读取可通过 ioutil.ReadAll实现。"><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/main.js></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.webp alt="POLOXUE's 博客频道"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's 博客频道</a></h1><div class=site-description><nav class="nav social"><ul class=flat></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>首页</a></li><li><a href=/posts/coder>编程杂谈</a></li><li><a href=/posts/trader>交易人生</a></li><li><a href=/posts/translator>技术译文</a></li><li><a href=/posts/english>英语学习</a></li><li><a href=/about/>关于我</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>10</span>
<span class=rest>Sep 2019</span></div></div><div class=matter><h1 class=title>Go 的 Http 请求系统指南</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ul><li><a href=#body>Body</a></li><li><a href=#statuscode>StatusCode</a></li><li><a href=#header>Header</a></li><li><a href=#encoding>Encoding</a></li></ul><ul><li><a href=#表单提交>表单提交</a></li><li><a href=#提交文件>提交文件</a></li></ul><ul><li><a href=#client-上设置-cookie>Client 上设置 Cookie</a></li><li><a href=#请求上设置-cookie>请求上设置 Cookie</a></li></ul><ul><li><a href=#总超时>总超时</a></li><li><a href=#连接超时>连接超时</a></li><li><a href=#读取超时>读取超时</a></li></ul></nav></aside><p>前几天在 &ldquo;知乎想法&rdquo; 谈到了一个话题，如何模仿学习，举了通过 net/http client 模仿 Pyhton 的requests的例子。但并未实践，难道想法真的只能是想法吗？当然不是，于是我决定先暂停一周 GO 笔记，来实践下自己的想法。</p><p><a href=https://www.zhihu.com/pin/1112419189498933248>有些新的知识，我们可以通过模仿学习</a></p><p>本文将通过 GO 实现 requests 的 quick start 文档中的所有例子，系统学习http client的使用。虽然标题是 quick start，但其实内容挺多的。</p><h1 id=快速体验>快速体验</h1><p>首先，我们来发起一个 GET 请求，代码非常简单。如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>get</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;https://api.github.com/events&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>() }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%s&#34;</span>, <span style=color:#a6e22e>body</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>通过 http.Get 方法，获取到了一个 Response 和一个 error ，即 r 和 err。通过 r 我们能获取响应的信息，err 可以实现错误检查。</p><p>r.Body 被读取后需要关闭，可以defer来做这件事。内容的读取可通过 ioutil.ReadAll实现。</p><h1 id=请求方法>请求方法</h1><p>除了GET，HTTP还有其他一系列方法，包括POST、PUT、DELETE、HEAD、OPTIONS。快速体验中的GET是通过一种便捷的方式实现的，它隐藏了很多细节。这里暂时先不用它。</p><p>我们先来介绍通用的方法，以帮我们实现所有HTTP方法的请求。主要涉及两个重要的类型，Client 和 Request。</p><p>Client 即是发送 HTTP 请求的客户端，请求的执行都是由 Client 发起。它提供了一些便利的请求方法，比如我们要发起一个Get请求，可通过 client.Get(url) 实现。更通用的方式是通过 client.Do(req) 实现，req 属于 Request 类型。</p><p>Request 是用来描述请求信息的结构体，比如请求方法、地址、头部等信息，我们都可以通过它来设置。Request 的创建可以通过 http.NewRequest 实现。</p><p>接下来列举 HTTP 所有方法的实现代码。</p><p>GET</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodGet</span>, <span style=color:#e6db74>&#34;https://api.github.com/events&#34;</span>, <span style=color:#66d9ef>nil</span>))
</span></span></code></pre></div><p>POST</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>, <span style=color:#e6db74>&#34;http://httpbin.org/post&#34;</span>, <span style=color:#66d9ef>nil</span>))
</span></span></code></pre></div><p>PUT</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPut</span>, <span style=color:#e6db74>&#34;http://httpbin.org/put&#34;</span>, <span style=color:#66d9ef>nil</span>))
</span></span></code></pre></div><p>DELETE</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodDelete</span>, <span style=color:#e6db74>&#34;http://httpbin.org/delete&#34;</span>, <span style=color:#66d9ef>nil</span>))
</span></span></code></pre></div><p>HEAD</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodHead</span>, <span style=color:#e6db74>&#34;http://httpbin.org/get&#34;</span>, <span style=color:#66d9ef>nil</span>))
</span></span></code></pre></div><p>OPTIONS</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodOptions</span>, <span style=color:#e6db74>&#34;http://httpbin.org/get&#34;</span>, <span style=color:#66d9ef>nil</span>))
</span></span></code></pre></div><p>上面展示了HTTP所有方法的实现。这里还几点需要说明。</p><p>DefaultClient，它是 net/http 包提供了默认客户端，一般的请求我们无需创建新的 Client，使用默认即可。</p><p>GET、POST 和 HEAD 的请求，GO提供了更便捷的实现方式，Request 不用手动创建。</p><p>示例代码，每个 HTTP 请求方法都有两种实现。</p><p>GET</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;http://httpbin.org/get&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;http://httpbin.org/get&#34;</span>)
</span></span></code></pre></div><p>POST</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>bodyJson</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;key&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Post</span>(
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;http://httpbin.org/post&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;application/json&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(string(<span style=color:#a6e22e>bodyJson</span>)),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Post</span>(
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;http://httpbin.org/post&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;application/json&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(string(<span style=color:#a6e22e>bodyJson</span>)),
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>这里顺便演示了如何向 POST 接口提交 JSON 数据的方式，主要 content-type 的设置，一般JSON接口的 content-type 为 application/json。</p><p>HEAD</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Head</span>(<span style=color:#e6db74>&#34;http://httpbin.org/get&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Head</span>(<span style=color:#e6db74>&#34;http://httpbin.org/get&#34;</span>)
</span></span></code></pre></div><p>如果看了源码，你会发现，http.Get 中调用就是 http.DefaultClient.Get，是同一个意思，只是为了方便，提供这种调用方法。Head 和 Post 也是如此。</p><h1 id=url参数>URL参数</h1><p>通过将键/值对置于 URL 中，我们可以实现向特定地址传递数据。该键/值将跟在一个问号的后面，例如 <a href="http://httpbin.org/get?key=val">http://httpbin.org/get?key=val</a>。 手工构建 URL 会比较麻烦，我们可以通过 net/http 提供的方法来实现。</p><p>举个栗子，比如你想传递 key1=value1 和 key2=value2 到 <a href=http://httpbin.org/get>http://httpbin.org/get</a>。代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodGet</span>, <span style=color:#e6db74>&#34;http://httpbin.org/get&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> make(<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Values</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;key1&#34;</span>, <span style=color:#e6db74>&#34;value1&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;key2&#34;</span>, <span style=color:#e6db74>&#34;value2&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>RawQuery</span> = <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>Encode</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// URL 的具体情况 http://httpbin.org/get?key1=value1&amp;key2=value2
</span></span></span><span style=display:flex><span><span style=color:#75715e>// fmt.Println(req.URL.String())
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
</span></span></code></pre></div><p>url.Values 可以帮助组织 QueryString，查看源码发现 url.Values 其实是 map[string][]string。调用 Encode 方法，将组织的字符串传递给请求 req 的 RawQuery。通过 url.Values也可以设置一个数组参数，类似如下的形式：</p><p><a href="http://httpbin.org/get?key1=value1&amp;key2=value2&amp;key2=value3">http://httpbin.org/get?key1=value1&amp;key2=value2&amp;key2=value3</a></p><p>怎么做呢？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> make(<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Values</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;key1&#34;</span>, <span style=color:#e6db74>&#34;value1&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;key2&#34;</span>, <span style=color:#e6db74>&#34;value2&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;key2&#34;</span>, <span style=color:#e6db74>&#34;value3&#34;</span>)
</span></span></code></pre></div><p>观察最后一行代码。其实，只要在 key2 上再增加一个值就可以了。</p><h1 id=响应信息>响应信息</h1><p>执行请求成功，如何查看响应信息。要查看响应信息，可以大概了解下，响应通常哪些内容？常见的有主体内容（Body）、状态信息（Status）、响应头部（Header）、内容编码（Encoding）等。</p><h2 id=body>Body</h2><p>其实，在最开始的时候已经演示Body读取的过程。响应内容的读取可通过 ioutil 实现。</p><pre tabindex=0><code>body, err := ioutil.ReadAll(r.Body)
</code></pre><p>响应内容多样，如果是 json，可以直接使用 json.Unmarshal 进行解码，JSON知识不介绍了。</p><p>r.Body 实现了 io.ReadeCloser 接口，为减少资源浪费要及时释放，可以通过 defer 实现。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>() }()
</span></span></code></pre></div><h2 id=statuscode>StatusCode</h2><p>响应信息中，除了 Body 主体内容，还有其他信息，比如 status code 和 charset 等。</p><pre tabindex=0><code>r.StatusCode
r.Status
</code></pre><p>r.StatusCode 是 HTTP 返回码，Status 是返回状态描述。</p><h2 id=header>Header</h2><p>响应头信息通过 Response.Header 即可获取，要说明的一点是，响应头的 Key 是不区分大小写。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;content-type&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>)
</span></span></code></pre></div><p>你会发现 content-type 和 Content-Type 获取的内容是完全一样的。</p><h2 id=encoding>Encoding</h2><p>如何识别响应内容编码呢？我们需要借助 <a href=http://golang.org/x/net/html/charset>http://golang.org/x/net/html/charset</a> 包实现。先来定义一个函数，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>determineEncoding</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>Reader</span>) <span style=color:#a6e22e>encoding</span>.<span style=color:#a6e22e>Encoding</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bytes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Peek</span>(<span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;err %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>unicode</span>.<span style=color:#a6e22e>UTF8</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>charset</span>.<span style=color:#a6e22e>DetermineEncoding</span>(<span style=color:#a6e22e>bytes</span>, <span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>e</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>怎么调用它？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>bodyReader</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bufio</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>determineEncoding</span>(<span style=color:#a6e22e>bodyReader</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Encoding %v\n&#34;</span>, <span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>decodeReader</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>transform</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>bodyReader</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>NewDecoder</span>())
</span></span></code></pre></div><p>利用 bufio 生成新的 reader，然后利用 determineEncoding 检测内容编码，并通过 transform 进行编码转化。</p><h1 id=图片下载>图片下载</h1><p>如果访问内容是一张图片，我们如何把它下载下来呢？比如如下地址的图片。</p><p><a href=https://pic2.zhimg.com/v2-5e8b41cae579722bd6b8a612bf1660e6.jpg>https://pic2.zhimg.com/v2-5e8b41cae579722bd6b8a612bf1660e6.jpg</a></p><p>其实很简单，只需要创建新的文件并把响应内容保存进去即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#e6db74>&#34;as.jpg&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Close</span>() }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>r 即 Response，利用 os 创建了新的文件，然后再通过 io.Copy 将响应的内容保存进文件中。</p><h1 id=定制请求头>定制请求头</h1><p>如何为请求定制请求头呢？Request 其实已经提供了相应的方法，通过 req.Header.Add 即可完成。</p><p>举个例子，假设我们将要访问 <a href=http://httpbin.org/get>http://httpbin.org/get</a>，但这个地址针对 user-agent 设置了发爬策略。我们需要修改默认的 user-agent。</p><p>示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodGet</span>, <span style=color:#e6db74>&#34;http://httpbin.org/get&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;user-agent&#34;</span>, <span style=color:#e6db74>&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_0)&#34;</span>)
</span></span></code></pre></div><p>如上便可完成任务。</p><h1 id=复杂的post请求>复杂的POST请求</h1><p>前面已经展示过了向 POST 接口提交 JSON 数据的方式。接下来介绍下另外几种向 POST 接口提交数据的方式，即表单提交和文件提交。</p><h2 id=表单提交>表单提交</h2><p>表单提交是一个很常用的功能，故而在 net/http 中，除了提供标准的用法外，还给我们提供了简化的方法。</p><p>我们先来介绍个标准的实现方法。</p><p>举个例子，假设要向 <a href=http://httpbin.org/post>http://httpbin.org/post</a> 提交 name 为 poloxue 和 password 为 123456 的表单。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>payload</span> <span style=color:#f92672>:=</span> make(<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Values</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;poloxue&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;password&#34;</span>, <span style=color:#e6db74>&#34;123456&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodPost</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;http://httpbin.org/post&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Encode</span>()),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/x-www-form-urlencoded&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
</span></span></code></pre></div><p>POST 的 payload 是形如 name=poloxue&amp;password=123456 的字符串，故而我们可以通过 url.Values 进行组织。</p><p>提交给 NewRequest 的内容必须是实现 Reader 接口的类型，所以需要 strings.NewReader转化下。</p><p>Form 表单提交的 content-type 要是 application/x-www-form-urlencoded，也要设置下。</p><p>复杂的方式介绍完了。接着再介绍简化的方式，其实表单提交只需调用 http.PostForm 即可完成。示例代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>payload</span> <span style=color:#f92672>:=</span> make(<span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Values</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;poloxue&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#e6db74>&#34;password&#34;</span>, <span style=color:#e6db74>&#34;123456&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>PostForm</span>(<span style=color:#e6db74>&#34;http://httpbin.org/post&#34;</span>, <span style=color:#a6e22e>form</span>)
</span></span></code></pre></div><p>竟是如此的简单。</p><h2 id=提交文件>提交文件</h2><p>文件提交应该是 HTTP 请求中较为复杂的内容了。其实说难也不难，区别于其他的请求，我们要花些精力来读取文件，组织提交POST的数据。</p><p>举个例子，假设现在我有一个图片文件，名为 as.jpg，路径在 /Users/polo 目录下。现在要将这个图片提交给 <a href=http://httpbin.org/post>http://httpbin.org/post</a>。</p><p>我们要先组织 POST 提交的内容，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>filename</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;/Users/polo/as.jpg&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#a6e22e>filename</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() { <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Close</span>() }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>uploadBody</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>{}
</span></span><span style=display:flex><span><span style=color:#a6e22e>writer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>multipart</span>.<span style=color:#a6e22e>NewWriter</span>(<span style=color:#a6e22e>uploadBody</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fWriter</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>CreateFormFile</span>(<span style=color:#e6db74>&#34;uploadFile&#34;</span>, <span style=color:#a6e22e>filename</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;copy file writer %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Copy</span>(<span style=color:#a6e22e>fWriter</span>, <span style=color:#a6e22e>f</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fieldMap</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;filename&#34;</span>: <span style=color:#a6e22e>filename</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>fieldMap</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>WriteField</span>(<span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我认为，数据组织分为几步完成，如下：</p><ul><li>第一步，打开将要上传的文件，使用 defer f.Close() 做好资源释放的准备；</li><li>第二步，创建存储上传内容的 bytes.Buffer，变量名为 uploadBody；</li><li>第三步，通过 multipart.NewWriter 创建 writer，用于向 buffer中写入文件提供的内容；</li><li>第四步，通过writer.CreateFormFile 创建上传文件并通过 io.Copy 向其中写入内容；</li><li>最后，通过 writer.WriteField 添加其他的附加信息，注意最后要把 writer 关闭；</li></ul><p>至此，文件上传的数据就组织完成了。接下来，只需调用 http.Post 方法即可完成文件上传。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Post</span>(<span style=color:#e6db74>&#34;http://httpbin.org/post&#34;</span>, <span style=color:#a6e22e>writer</span>.<span style=color:#a6e22e>FormDataContentType</span>(), <span style=color:#a6e22e>uploadBody</span>)
</span></span></code></pre></div><p>有一点要注意，请求的content-type需要设置，而通过 writer.FormDataContentType() 即能获得上传文件的类型。</p><p>到此，文件提交也完成了，不知道有没有非常简单的感觉。</p><h1 id=cookie>Cookie</h1><p>主要涉及两部分内容，即读取响应的 cookie 与设置请求的 cookie。响应的 cookie 获取方式非常简单，直接调用 r.Cookies 即可。</p><p>重点来说说，如何设置请求 cookie。cookie设置有两种方式，一种设置在 Client 上，另一种是设置在 Request 上。</p><h2 id=client-上设置-cookie>Client 上设置 Cookie</h2><p>直接看示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>cookies</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Cookie</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cookies</span> = append(<span style=color:#a6e22e>cookies</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Cookie</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>:   <span style=color:#e6db74>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Value</span>:  <span style=color:#e6db74>&#34;poloxue&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Domain</span>: <span style=color:#e6db74>&#34;httpbin.org&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Path</span>:   <span style=color:#e6db74>&#34;/cookies&#34;</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#a6e22e>cookies</span> = append(<span style=color:#a6e22e>cookies</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Cookie</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>:   <span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Value</span>:  <span style=color:#e6db74>&#34;10000&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Domain</span>: <span style=color:#e6db74>&#34;httpbin.org&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Path</span>:   <span style=color:#e6db74>&#34;/elsewhere&#34;</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#e6db74>&#34;http://httpbin.org/cookies&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>jar</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cookiejar</span>.<span style=color:#a6e22e>New</span>(<span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>jar</span>.<span style=color:#a6e22e>SetCookies</span>(<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>cookies</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{<span style=color:#a6e22e>Jar</span>: <span style=color:#a6e22e>jar</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;http://httpbin.org/cookies&#34;</span>)
</span></span></code></pre></div><p>代码中，我们首先创建了 http.Cookie 切片，然后向其中添加了 2 个 Cookie 数据。这里通过 cookiejar，保存了 2 个新建的 cookie。</p><p>这次我们不能再使用默认的 DefaultClient 了，而是要创建新的 Client，并将保存 cookie 信息的 cookiejar 与 client 绑定。接下里，只需要使用新创建的 Client 发起请求即可。</p><h2 id=请求上设置-cookie>请求上设置 Cookie</h2><p>请求上的 cookie 设置，通过 req.AddCookie即可实现。示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequest</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>MethodGet</span>, <span style=color:#e6db74>&#34;http://httpbin.org/cookies&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>AddCookie</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Cookie</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Name</span>:   <span style=color:#e6db74>&#34;name&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Value</span>:  <span style=color:#e6db74>&#34;poloxue&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Domain</span>: <span style=color:#e6db74>&#34;httpbin.org&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Path</span>:   <span style=color:#e6db74>&#34;/cookies&#34;</span>,
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
</span></span></code></pre></div><p>挺简单的，没什么要介绍的。</p><p>cookie 设置 Client 和 设置在 Request 上有何区别？一个最易想到的区别就是，Request 的 cookie 只是当次请求失效，而 Client 上的 cookie 是随时有效的，只要你用的是这个新创建的 Client。</p><h1 id=重定向和请求历史>重定向和请求历史</h1><p>默认情况下，所有类型请求都会自动处理重定向。</p><p>Python 的 requests 包中 HEAD 请求是不重定向的，但测试结果显示 net/http 的 HEAD 是自动重定向的。</p><p>net/http 中的重定向控制可以通过 Client 中的一个名为 CheckRedirect 的成员控制，它是函数类型。定义如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Client</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CheckRedirect</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>via</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接下来，我们来看看怎么使用。</p><p>假设我们要实现的功能：为防止发生循环重定向，重定向次数定义不能超过 10 次，而且要记录历史 Response。</p><p>示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Response</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>history</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Response</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CheckRedirect</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>hrs</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>hrs</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>10</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;redirect to many times&#34;</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>history</span> = append(<span style=color:#a6e22e>history</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Response</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;http://github.com&#34;</span>)
</span></span></code></pre></div><p>首先创建了 http.Response 切片的变量，名称为 history。接着在 http.Client 中为 CheckRedirect 赋予一个匿名函数，用于控制重定向的行为。CheckRedirect 函数的第一个参数表示下次将要请求的 Request，第二个参数表示已经请求过的 Request。</p><p>当发生重定向时，当前的 Request 会保存上次请求的 Response，故而此处可以将 req.Response 追加到 history 变量中。</p><h1 id=超时设置>超时设置</h1><p>Request 发出后，如果服务端迟迟没有响应，那岂不是很尴尬。那么我们就会想，能否为请求设置超时规则呢？毫无疑问，当然可以。</p><p>超时可以分为连接超时和响应读取超时，这些都可以设置。但正常情况下，并不想有那么明确的区别，那么也可以设置个总超时。</p><h2 id=总超时>总超时</h2><p>总的超时时间的设置是绑定在 Client 的一个名为 Timeout 的成员之上，Timeout 是 time.Duration。</p><p>假设这是超时时间为 10 秒，示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Timeout</span>:   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=连接超时>连接超时</h2><p>连接超时可通过 Client 中的 Transport 实现。Transport 中有个名为 Dial 的成员函数，可用设置连接超时。Transport 是 HTTP 底层的数据运输者。</p><p>假设设置连接超时时间为 2 秒，示例代码：</p><pre tabindex=0><code>t := &amp;http.Transport{
	Dial: func(network, addr string) (net.Conn, error) {
		timeout := time.Duration(2 * time.Second)
		return net.DialTimeout(network, addr, timeout)
	},
}
</code></pre><p>在 Dial 的函数中，我们通过 net.DialTimeout 进行网络连接，实现了连接超时功能。</p><h2 id=读取超时>读取超时</h2><p>读取超时也要通过 Client 的 Transport 设置，比如设置响应的读取为 8 秒。</p><p>示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Transport</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ResponseHeaderTimeout</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>综合所有</span><span style=color:#960050;background-color:#1e0010>，</span><span style=color:#a6e22e>Client</span> <span style=color:#a6e22e>的创建代码如下</span><span style=color:#960050;background-color:#1e0010>：</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Transport</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Dial</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>network</span>, <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>timeout</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>DialTimeout</span>(<span style=color:#a6e22e>network</span>, <span style=color:#a6e22e>addr</span>, <span style=color:#a6e22e>timeout</span>)
</span></span><span style=display:flex><span>	},
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ResponseHeaderTimeout</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Transport</span>: <span style=color:#a6e22e>t</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Timeout</span>:   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>除了上面的几个超时设置，Transport 还有其他一些关于超时的设置，可以看下 Transport 的定义，还有发现三个与超时相关的定义：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// IdleConnTimeout is the maximum amount of time an idle
</span></span></span><span style=display:flex><span><span style=color:#75715e>// (keep-alive) connection will remain idle before closing
</span></span></span><span style=display:flex><span><span style=color:#75715e>// itself.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Zero means no limit.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>IdleConnTimeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ResponseHeaderTimeout, if non-zero, specifies the amount of
</span></span></span><span style=display:flex><span><span style=color:#75715e>// time to wait for a server&#39;s response headers after fully
</span></span></span><span style=display:flex><span><span style=color:#75715e>// writing the request (including its body, if any). This
</span></span></span><span style=display:flex><span><span style=color:#75715e>// time does not include the time to read the response body.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>ResponseHeaderTimeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ExpectContinueTimeout, if non-zero, specifies the amount of
</span></span></span><span style=display:flex><span><span style=color:#75715e>// time to wait for a server&#39;s first response headers after fully
</span></span></span><span style=display:flex><span><span style=color:#75715e>// writing the request headers if the request has an
</span></span></span><span style=display:flex><span><span style=color:#75715e>// &#34;Expect: 100-continue&#34; header. Zero means no timeout and
</span></span></span><span style=display:flex><span><span style=color:#75715e>// causes the body to be sent immediately, without
</span></span></span><span style=display:flex><span><span style=color:#75715e>// waiting for the server to approve.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// This time does not include the time to send the request header.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>ExpectContinueTimeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span></code></pre></div><p>分别是 IdleConnTimeout （连接空闲超时时间，keep-live 开启）、TLSHandshakeTimeout （TLS 握手时间）和 ExpectContinueTimeout（似乎已含在 ResponseHeaderTimeout 中了，看注释）。</p><p>到此，完成了超时的设置。相对于 Python requests 确实是复杂很多。</p><h1 id=请求代理>请求代理</h1><p>代理还是挺重要的，特别对于开发爬虫的同学。那 net/http 怎么设置代理？这个工作还是要依赖 Client 的成员 Transport 实现，这个 Transport 还是挺重要的。</p><p>Transport 有个名为 Proxy 的成员，具体看看怎么使用吧。假设我们要通过设置代理来请求谷歌的主页，代理地址为 http://127.0.0.1:8087。</p><p>示例代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>proxyUrl</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#e6db74>&#34;http://127.0.0.1:8087&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Transport</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Proxy</span>:           <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ProxyURL</span>(<span style=color:#a6e22e>proxyUrl</span>),
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>TLSClientConfig</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>Config</span>{<span style=color:#a6e22e>InsecureSkipVerify</span>: <span style=color:#66d9ef>true</span>},
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Transport</span>: <span style=color:#a6e22e>t</span>,
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Timeout</span>:   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;https://google.com&#34;</span>)
</span></span></code></pre></div><p>主要关注 http.Transport 创建的代码。两个参数，分时 Proxy 和 TLSClientConfig，分别用于设置代理和禁用 https 验证。我发现其实不设置 TLSClientConfig 也可以请求成功，具体原因没仔细研究。</p><h1 id=错误处理>错误处理</h1><p>错误处理其实都不用怎么介绍，GO中的一般错误主要是检查返回的error，HTTP 请求也是如此，它会视情况返回相应错误信息，比如超时、网络连接失败等。</p><p>示例代码中的错误都是通过 panic 抛出去的，真实的项目肯定不是这样的，我们需要记录相关日志，时刻做好错误恢复工作。</p><h1 id=总结>总结</h1><p>本文以 Python 的 requests 文档为指导方向，整理了 requests 快速入门文档中的案例在 GO 的是如何实现的。要说明的是， GO 其实也提供了对应于 requests 的克隆版本，<a href=https://github.com/levigross/grequests>github地址</a>。暂时我也还没有看，有兴趣的朋友可以去研究一下。</p></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ul><li><a href=#body>Body</a></li><li><a href=#statuscode>StatusCode</a></li><li><a href=#header>Header</a></li><li><a href=#encoding>Encoding</a></li></ul><ul><li><a href=#表单提交>表单提交</a></li><li><a href=#提交文件>提交文件</a></li></ul><ul><li><a href=#client-上设置-cookie>Client 上设置 Cookie</a></li><li><a href=#请求上设置-cookie>请求上设置 Cookie</a></li></ul><ul><li><a href=#总超时>总超时</a></li><li><a href=#连接超时>连接超时</a></li><li><a href=#读取超时>读取超时</a></li></ul></nav></nav></div><div class=post><hr class=footer-separator><div class=tags><ul class=flat><li class=tag-li><a href=/tags/golang>Golang</a></li></ul></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div></div><div class="footer wrapper"><nav class=nav><div>2019 2023 Polo Xue All rights reserved</div></nav></div><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>
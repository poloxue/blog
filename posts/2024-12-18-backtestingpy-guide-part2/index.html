<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Backtesting.py 参数优化入门 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Backtesting.py 参数优化入门"><meta itemprop=description content="本文介绍 Backtesting.py 的参数优化，快速上手 **Backtesting.py** 参数优化。"><meta itemprop=datePublished content="2024-12-24T12:15:18+08:00"><meta itemprop=dateModified content="2024-12-24T12:15:18+08:00"><meta itemprop=wordCount content="636"><meta itemprop=keywords content><meta property="og:title" content="Backtesting.py 参数优化入门"><meta property="og:description" content="本文介绍 Backtesting.py 的参数优化，快速上手 **Backtesting.py** 参数优化。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2024-12-18-backtestingpy-guide-part2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-24T12:15:18+08:00"><meta property="article:modified_time" content="2024-12-24T12:15:18+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Backtesting.py 参数优化入门"><meta name=twitter:description content="本文介绍 Backtesting.py 的参数优化，快速上手 **Backtesting.py** 参数优化。"><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script>
<script>MathJax={tex:{displayMath:[["[","]"],["$$","$$"]],inlineMath:[["(",")"],["$","$"]]}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.png alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/posts/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>文章列表</a></li><li><a href=/tags>分类标签</a></li><li><a href=https://crypto.poloxue.com/>每日币圈</a></li><li><a href=/about/about>关于我</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>24</span>
<span class=rest>Dec 2024</span></div></div><div class=matter><h1 class=title>Backtesting.py 参数优化入门</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#优化示例>优化示例</a></li><li><a href=#参数约束>参数约束</a></li><li><a href=#优化标准>优化标准</a></li><li><a href=#优化函数>优化函数</a></li><li><a href=#自定义优化指标>自定义优化指标</a></li><li><a href=#参数优化热力图>参数优化热力图</a><ol><li><a href=#生成基础热力图>生成基础热力图</a></li><li><a href=#多参数组合的热力图>多参数组合的热力图</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></aside><p>上篇文章介绍了如何使用 <strong>Backetsting.py</strong> 快速上手。今天继续介绍另一个策略回测时非常重要的点，参数优化。参数优化是提升策略表现的重要步骤，而 <strong>Backtesting.py</strong> 内置了参数优化功能，使用起来还是很方便的。</p><p>本文将用上篇的案例 <code>SMACrossStrategy</code> 策略演示 <strong>Backtesting.py</strong> 参数优化。</p><h2 id=优化示例>优化示例</h2><p><strong>Backtesting.py</strong> 默认优化方式是将是将所有的参数组合穷举遍历一遍，这种方式也被称为-<strong>网格搜索</strong>。</p><p>以下是优化 SMACross 策略的示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt <span style=color:#f92672>=</span> Backtest(GOOG, SMACrossStrategy, cash<span style=color:#f92672>=</span><span style=color:#ae81ff>10000</span>, commission<span style=color:#f92672>=</span><span style=color:#ae81ff>0.002</span>)
</span></span><span style=display:flex><span>stats <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>print(stats)
</span></span><span style=display:flex><span>bt<span style=color:#f92672>.</span>plot()
</span></span></code></pre></td></tr></table></div></div><p>通过 <code>range</code> 指定了 <code>fast_ma_window</code> 和 <code>slow_ma_window</code> 的参数范围，运行的结果就是表现最好的参数的结果。</p><p>通过 <code>stats._strategy</code> 拿到策略实例，然后打印策略实例参数。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(stats<span style=color:#f92672>.</span>_strategy)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;fast_ma_window&#34;</span>, stats<span style=color:#f92672>.</span>_strategy<span style=color:#f92672>.</span>fast_ma_window)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;slow_ma_window&#34;</span>, stats<span style=color:#f92672>.</span>_strategy<span style=color:#f92672>.</span>slow_ma_window)
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SMACrossStrategy<span style=color:#f92672>(</span>fast_ma_window<span style=color:#f92672>=</span>5,slow_ma_window<span style=color:#f92672>=</span>20<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>fast_ma_window <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>slow_ma_window <span style=color:#ae81ff>20</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>网格搜索</strong>适用于参数空间较小的情况，超参数的场景还要考虑其他优化方法。先暂时只介绍这个默认的优化方法。</p><h2 id=参数约束>参数约束</h2><p>上面的优化代码有个明显的不合理，可能出现 <code>fast_ma_window</code> 小于 <code>slow_ma_window</code> 的情况，如 <code>fast_ma_window=20</code>，但 <code>slow_ma_window=10</code> 的组合，这不仅会增加优化耗时，也不符合策略的逻辑，。<code>backtestingpy</code> 的优化器提供了参数约束能力，我们可以限制 <code>fast_ma_window</code> 必须小于 <code>slow_ma_window</code>。</p><p>示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>stats <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>通过 <code>constraint</code> 指定参数约束函数，限制 <code>fast_ma_window</code> 必须小于 <code>slow_ma_window</code>。这能极大提升回测优化速度。</p><h2 id=优化标准>优化标准</h2><p>优化器默认只返回了一个表现最好的那个参数组合，但这个最好是如何评价的呢？</p><p><code>Backtesting.py</code> 优化器的默认优化标准是 SQN，它的计算公式如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>SQN = (平均每笔交易收益 × √交易次数) / 每笔交易收益的标准差
</span></span></code></pre></td></tr></table></div></div><p>一句话表述它的含义就是，SQN 通过平均收益（高更好）、收益波动性（低更好）和交易次数（多更好）衡量策略稳健性，值越高越优质。</p><p>我想修改这个标准可以吗？当然可以。</p><p><code>optimize</code> 提供了一个名为 <code>maximize</code>参数来修改优化标准。我可以将最大回撤或夏普比率作为优化标准。</p><p>将优化标准改为最大回撤：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window,
</span></span><span style=display:flex><span>    maximize<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Max. Drawdown [%]&#39;</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>将优化标准改为夏普比率：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window,
</span></span><span style=display:flex><span>    maximize<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Sharpe Ratio&#34;</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=优化函数>优化函数</h2><p>这个优化标准默认是选设置的优化指标的最大值，如果想越小越好，可将传递优化指标名改为函数，自定义标准。</p><p>如选择年化波动率最小的参数组合，示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window,
</span></span><span style=display:flex><span>    maximize<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> r: <span style=color:#f92672>-</span>r[<span style=color:#e6db74>&#34;Volatility (Ann.) [%]&#34;</span>],
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>通过匿名函数 <code>maximize=lambda r: -r["Volatility (Ann.) [%]"]</code> 选择年化波动波动率最小的组合。</p><p>不过，从我平时的使用体验来看，还是默认的 SQN 的优化结果比较合理，它的评价维度更加全面。</p><h2 id=自定义优化指标>自定义优化指标</h2><p>除了那些内置的优化指标，我还可以自定义标准。举个例子，我现在想寻找 &ldquo;在市场中持仓时间最短收益最大” 的参数组合。</p><p>定义优化目标函数：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>equity_per_exposure</span>(r):
</span></span><span style=display:flex><span>    final_equity <span style=color:#f92672>=</span> r[<span style=color:#e6db74>&#39;Equity Final [$]&#39;</span>] <span style=color:#75715e># 最终净值</span>
</span></span><span style=display:flex><span>    exposure_time <span style=color:#f92672>=</span> r[<span style=color:#e6db74>&#39;Exposure Time [%]&#39;</span>] <span style=color:#75715e># 持仓时间</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> final_equity <span style=color:#f92672>/</span> exposure_time
</span></span></code></pre></td></tr></table></div></div><p>目标函数是通过最终净值除以仓位持有时间计算得到，将其传递给 <code>bt.optimize</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>stats <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>    maximize<span style=color:#f92672>=</span>equity_per_exposure,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>如果用这个指标优化策略，可能拿到的时候交易次数很少的参数组合，因为这样持有时间最短，而且可能某段时间的收益非常高。</p><p>如何解决这个问题？</p><p>还可以在优化函数中添加条件约束，确保得到参数组合是的合性。在函数中加上如果交易次数小于 50 次，返回 -1，保证它们不会被优化结果选中。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>equity_per_exposure</span>(series):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> series[<span style=color:#e6db74>&#39;# Trades&#39;</span>] <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>50</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>  <span style=color:#75715e># 返回负值以避免选择</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    final_equity <span style=color:#f92672>=</span> series[<span style=color:#e6db74>&#39;Equity Final [$]&#39;</span>]
</span></span><span style=display:flex><span>    exposure_time <span style=color:#f92672>=</span> series[<span style=color:#e6db74>&#39;Exposure Time [%]&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> final_equity <span style=color:#f92672>/</span> exposure_time
</span></span></code></pre></td></tr></table></div></div><p>好像通过交易次数约束不太合理，那还可以基于单位时间交易次数过滤，如交易频率 100 天要至少交易 1 次。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>equity_per_exposure</span>(series):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> r[<span style=color:#e6db74>&#34;# Trades&#34;</span>] <span style=color:#f92672>/</span> r[<span style=color:#e6db74>&#34;Duration&#34;</span>]<span style=color:#f92672>.</span>days <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0.01</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    final_equity <span style=color:#f92672>=</span> series[<span style=color:#e6db74>&#39;Equity Final [$]&#39;</span>]
</span></span><span style=display:flex><span>    exposure_time <span style=color:#f92672>=</span> series[<span style=color:#e6db74>&#39;Exposure Time [%]&#39;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> final_equity <span style=color:#f92672>/</span> exposure_time
</span></span></code></pre></td></tr></table></div></div><p>通过自定义优化指标，可以更灵活地定义你的目标，发现满足你需求的最佳参数组合。</p><h2 id=参数优化热力图>参数优化热力图</h2><p>参数优化热力图是一种直观的方式来比较不同参数组合对策略表现的影响。通过可视化参数范围内的结果，可以快速识别最佳参数区域。</p><p><strong>Backtesting.py</strong> 中支持生成热力图的方法。</p><h3 id=生成基础热力图>生成基础热力图</h3><p>在优化函数 <code>optimize</code> 中要启用热力图选项 <code>return_heatmap</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>stats, hm <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>50</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window,
</span></span><span style=display:flex><span>    return_heatmap<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>优化函数 <code>bt.optimize</code> 返回了两个对象，其中的第二个对象是 <code>hm</code> 就是绘制热力图的数据，包含了所有参数组合的优化结果。</p><p>打印下 <code>hm</code> 变量。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>print(hm)
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>fast_ma_window  slow_ma_window
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>               <span style=color:#ae81ff>10</span>                <span style=color:#ae81ff>1.792704</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>20</span>                <span style=color:#ae81ff>2.703298</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>30</span>                <span style=color:#ae81ff>2.392251</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>40</span>                <span style=color:#ae81ff>2.257054</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>50</span>                <span style=color:#ae81ff>1.794700</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>10</span>              <span style=color:#ae81ff>20</span>                <span style=color:#ae81ff>2.643361</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>30</span>                <span style=color:#ae81ff>1.938471</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>40</span>                <span style=color:#ae81ff>2.427356</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>50</span>                <span style=color:#ae81ff>1.603184</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>15</span>              <span style=color:#ae81ff>20</span>                <span style=color:#ae81ff>1.832693</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>30</span>                <span style=color:#ae81ff>1.720452</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>40</span>                <span style=color:#ae81ff>1.762611</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>50</span>                <span style=color:#ae81ff>1.365671</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>20</span>              <span style=color:#ae81ff>30</span>                <span style=color:#ae81ff>1.316673</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>40</span>                <span style=color:#ae81ff>2.230364</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>50</span>                <span style=color:#ae81ff>1.389500</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>25</span>              <span style=color:#ae81ff>30</span>                <span style=color:#ae81ff>1.178816</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>40</span>                <span style=color:#ae81ff>2.128967</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>50</span>                <span style=color:#ae81ff>0.915063</span>
</span></span><span style=display:flex><span>Name: SQN, dtype: float64
</span></span></code></pre></td></tr></table></div></div><p>参数组合对应的值就是优化指标的值，因为我的 <code>optimize</code> 没有指定 <code>maximize</code>，默认值就是 <code>SQN</code>。</p><p>有了数据后，可以用 Seaborn 绘制热力图：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> backtesting.lib <span style=color:#f92672>import</span> plot_heatmaps
</span></span></code></pre></td></tr></table></div></div><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-12/2024-12-18-backtestingpy-guide-part2-01.png alt></p><p>粗略查看，表现最好区域在黄色区域，大概是 <code>fast_ma_window</code> 位于 <code>[5, 10]</code>, <code>slow_ma_window</code> 位于 <code>[20, 30, 40]</code> 区域；</p><h3 id=多参数组合的热力图>多参数组合的热力图</h3><p>现在的 <code>SMACrossStrategy</code> 策略只有两个参数，如果是三个或更多参数，<code>plot_heatmaps</code> 会将参数两两组合绘制每个组合的热力图。</p><p>简单修改下 <code>SMACrossStrategy</code> 的逻辑，加上 <code>ATR</code> 止损，通过一个 <code>atr_factor</code> 控制止损的乘数，如下所示：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SMACrossStrategy</span>(Strategy):
</span></span><span style=display:flex><span>    <span style=color:#75715e># 参数</span>
</span></span><span style=display:flex><span>    fast_ma_window <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    slow_ma_window <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>    atr_factor <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>init</span>(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>fast_ma <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>I(
</span></span><span style=display:flex><span>            talib<span style=color:#f92672>.</span>SMA, self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>Close, timeperiod<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>fast_ma_window
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>slow_ma <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>I(
</span></span><span style=display:flex><span>            talib<span style=color:#f92672>.</span>SMA, self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>Close, timeperiod<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>slow_ma_window
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>atr <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>I(
</span></span><span style=display:flex><span>            talib<span style=color:#f92672>.</span>ATR, self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>High, self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>Low, self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>Close, timeperiod<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>next</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>fast_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&gt;</span> self<span style=color:#f92672>.</span>slow_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> <span style=color:#f92672>not</span> self<span style=color:#f92672>.</span>position:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>buy(sl<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>data<span style=color:#f92672>.</span>Close[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>-</span> self<span style=color:#f92672>.</span>atr_factor <span style=color:#f92672>*</span> self<span style=color:#f92672>.</span>atr[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elif</span> self<span style=color:#f92672>.</span>fast_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>&lt;</span> self<span style=color:#f92672>.</span>slow_ma[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>and</span> self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>is_long:
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>position<span style=color:#f92672>.</span>close()
</span></span></code></pre></td></tr></table></div></div><p>同时参数优化加上 <code>atr_factor</code>：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>stats, hm <span style=color:#f92672>=</span> bt<span style=color:#f92672>.</span>optimize(
</span></span><span style=display:flex><span>    fast_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>30</span>, <span style=color:#ae81ff>5</span>),
</span></span><span style=display:flex><span>    slow_ma_window<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>60</span>, <span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>    atr_factor<span style=color:#f92672>=</span>range(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>4</span>),
</span></span><span style=display:flex><span>    constraint<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> p: p<span style=color:#f92672>.</span>fast_ma_window <span style=color:#f92672>&lt;</span> p<span style=color:#f92672>.</span>slow_ma_window,
</span></span><span style=display:flex><span>    return_heatmap<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><p>将新得到的 <code>hm</code> 交给 <code>plot_heatmaps</code> 绘制。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>plot_heatmaps(hm, agg<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;mean&#39;</span>)
</span></span></code></pre></td></tr></table></div></div><p>其中有个 <code>agg</code> 参数，它指定了分组聚合方式，默认为 <code>max</code>，这里修改为 <code>mean</code>，即采用平均值聚合。</p><p>新生成的热力图：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2024-12/2024-12-18-backtestingpy-guide-part2-02-v1.png alt></p><p>如果参数数量太多，默认生成的两两参数会很庞大，而且很多组合不符合现实需求，如将 <code>atr_factor</code> 和 <code>fast_ma_window</code> 放在一起分析，并没有太大的价值，可以通过 <code>pandas</code> 分组聚合想分析的参数组合。</p><p>示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>hm <span style=color:#f92672>=</span> hm<span style=color:#f92672>.</span>groupby(by<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;fast_ma_window&#34;</span>, <span style=color:#e6db74>&#34;slow_ma_window&#34;</span>])<span style=color:#f92672>.</span>mean()
</span></span><span style=display:flex><span>plot_heatmaps(hm)
</span></span></code></pre></td></tr></table></div></div><p><strong>注意点</strong></p><ul><li>热力图适用于分析两个参数间的关系，如果参数过多，图表数量会急剧增加。</li><li>使用合理的参数范围和步长可以减少计算量并提高可读性。</li><li>更灵活的使用方法，可分组聚合关心的参数组合进行分析。</li></ul><p>通过查看参数优化热力图，可以高效地探索参数空间，不仅能找到表现最佳的策略组合，还能减少选出过拟合参数组合的可能性。</p><h2 id=总结>总结</h2><p>本文介绍了如何在 <strong>Backtesting.py</strong> 中进行参数优化，包括基础的网格搜索、参数约束、自定义优化指标以及通过热力图可视化优化结果等内容。通过这些方法，可以有效提升策略的表现，同时避免无意义的参数组合。热力图为分析参数间的关系提供了直观工具，是优化策略的重要辅助。掌握这些技巧，可以更高效地开发和改进交易策略。</p><p>希望本文对你所有帮助。</p><div>本文来源于 <a href=https://www.poloxue.com>POLOXUE's BLOG</a>，地址： <a href=https://www.poloxue.com/posts/2024-12-18-backtestingpy-guide-part2/>Backtesting.py 参数优化入门</a></div></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#优化示例>优化示例</a></li><li><a href=#参数约束>参数约束</a></li><li><a href=#优化标准>优化标准</a></li><li><a href=#优化函数>优化函数</a></li><li><a href=#自定义优化指标>自定义优化指标</a></li><li><a href=#参数优化热力图>参数优化热力图</a><ol><li><a href=#生成基础热力图>生成基础热力图</a></li><li><a href=#多参数组合的热力图>多参数组合的热力图</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><img style=width:85% src=https://cdn.jsdelivr.net/gh/poloxue/images@main/wechat.png><div class=utterances></div><script src=https://utteranc.es/client.js repo=poloxue/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2024 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>
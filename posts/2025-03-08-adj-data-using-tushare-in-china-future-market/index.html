<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>期货回测大坑-基于 tushare 下载和计算期货的复权数据 - POLOXUE's BLOG</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="期货回测大坑-基于 tushare 下载和计算期货的复权数据"><meta itemprop=description content="本文介绍如何计算期货的复权数据，以 Tushare 作为数据源。"><meta itemprop=datePublished content="2025-03-08T17:16:49+08:00"><meta itemprop=dateModified content="2025-03-08T17:16:49+08:00"><meta itemprop=wordCount content="811"><meta itemprop=keywords content><meta property="og:title" content="期货回测大坑-基于 tushare 下载和计算期货的复权数据"><meta property="og:description" content="本文介绍如何计算期货的复权数据，以 Tushare 作为数据源。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.poloxue.com/posts/2025-03-08-adj-data-using-tushare-in-china-future-market/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-08T17:16:49+08:00"><meta property="article:modified_time" content="2025-03-08T17:16:49+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="期货回测大坑-基于 tushare 下载和计算期货的复权数据"><meta name=twitter:description content="本文介绍如何计算期货的复权数据，以 Tushare 作为数据源。"><script data-goatcounter=https://poloxue.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/main.css><link rel=stylesheet type=text/css media=screen href=https://www.poloxue.com/css/extra.css><link id=dark-scheme rel=stylesheet type=text/css href=https://www.poloxue.com/css/dark.css><script src=https://www.poloxue.com/js/feather.min.js></script>
<script src=https://www.poloxue.com/js/main.js></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script>
<script>MathJax={tex:{displayMath:[["[","]"],["$$","$$"]],inlineMath:[["(",")"],["$","$"]]}}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7019080091542951" crossorigin=anonymous></script></head><body><div class="container-wide wrapper"><div class=header><div class=avatar><a href=https://www.poloxue.com/><img src=/avatar.png alt="POLOXUE's BLOG"></a></div><h1 class=site-title><a href=https://www.poloxue.com/>POLOXUE's BLOG</a></h1><div class=site-description><nav class="nav social"><ul class=flat><li><a href=https://github.com/poloxue/ title=Github><i data-feather=github></i></a></li><li><a href=/posts/index.xml title=RSS><i data-feather=rss></i></a></li><li><a href=/ title=Wechat><i data-feather=message-circle></i></a></li><span class=scheme-toggle><a href=# id=scheme-toggle></a></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>文章列表</a></li><li><a href=/tags>分类标签</a></li><li><a href=/about/about>关于我</a></li></ul></nav></div><div class=article-nav id=article-nav-id><div class=post><div class=post-header><div class=meta><div class=date><span class=day>08</span>
<span class=rest>Mar 2025</span></div></div><div class=matter><h1 class=title>期货回测大坑-基于 tushare 下载和计算期货的复权数据</h1></div></div><aside class="show-on-mobile toc" id=static-toc><header><h3>Contents</h3></header><nav id=TableOfContents><ol><li><a href=#背景概述>背景概述</a></li><li><a href=#期货复权数据下载工具>期货复权数据下载工具</a></li><li><a href=#准备工作>准备工作</a></li><li><a href=#映射数据>映射数据</a><ol><li><a href=#标准映射数据>标准映射数据</a></li><li><a href=#自定义换仓规则>自定义换仓规则</a></li><li><a href=#查询换仓详情>查询换仓详情</a></li></ol></li><li><a href=#计算复权数据>计算复权数据</a><ol><li><a href=#复权方法>复权方法</a></li><li><a href=#openpre_close>open/pre_close</a></li><li><a href=#pre_closepre_close-和-pre_settlepre_settle>pre_close/pre_close 和 pre_settle/pre_settle</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></aside><p>本周写点国内期货的内容，介绍如何通过 Python 计算期货主连合约的复权数据。为什么要处理这个数据？因为它会直接影响策略（如 CTA 策略）的回测结果，</p><h2 id=背景概述>背景概述</h2><p>最近希望合理分配资金、对冲风险，就计划测试些适用于国内市场的策略，如套利、CTA 策略，但 A 股不支持做空机制，于是转而选择了期货市场。</p><p>但问题是，期货不同于股票，不是一个品种一个可交易标的，而是由连续的交割合约组成，即每个合约都有到期日，而同一品种的不同月合约都是有价差的。</p><p>如下是玻璃2505和2509的合约的价格曲线：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-03/2025-03-08-adj-data-using-tushare-in-china-future-market-02.png alt></p><p>查看交易软件上的主合约价格图表，如下图所示是生猪的主力合约的价格图：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-03/2025-03-08-adj-data-using-tushare-in-china-future-market-03.png alt></p><p>你会发现，这其中存在一些明显的跳空。这些跳空基本就是主连合约切换合约时产生的。</p><p>如果是短线交易或者跨期套利，这个问题或许不是那么重要。但我还计划测试期货的 CTA 策略。如果用这个数据回测策略，和实盘将有会很大差异，因为那些跳空是不同合约的价差，是实际交易无法拿到的收益。</p><p>如何解决？</p><p>答案就是计算复权数据，通过复权计算买入持有的收益曲线，将换仓时的价差尽可能的考虑在内。</p><p>熟悉股票交易的人都知道，交易软件或数据平台会提供股票的复权价格（如分红、拆股后的调整数据），以消除公司行为导致的历史价格断裂，确保长期收益计算的准确性。</p><p>但期货不同，交易软件和数据平台通常不会提供这个数据。</p><p>为什么呢？</p><p>所谓的主连合约是基于某个规则拼接而成，复权并非强制需求。根据策略目标不同，可自行选择换月规则，如固定日期、持仓量切换等。</p><p>散户能接触到的数据源通常只提供主连合约的原始价格数据。听过付费平台（如 Wind）好像有定制的主连合约，也提供了相应的复权因子。</p><p>那我这个小散该怎么办？</p><p>当然是自己计算了。走独立自主的发展道路，还可以根据策略目标制定不同的换仓时间和复权计算的方法。</p><h2 id=期货复权数据下载工具>期货复权数据下载工具</h2><p>我开发了一个基于 tushare 下载期货复权数据的小工具，它支持了常见的主连合约的复权方法，先给大家效果，直观看看考虑复权和不复权价格数据的差异。</p><p>以生猪为例：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python main.py --ts-code LH.DCE --method pre_close/pre_close --plot
</span></span></code></pre></td></tr></table></div></div><p>后复权价格图如下：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-03/2025-03-08-adj-data-using-tushare-in-china-future-market-04-v1.png alt></p><p>如果你想做期货的量化策略，特别是 CTA 策略，用主连价格回测，与实盘交易差异将会很大。</p><p>希望这能助新手避坑。</p><p>这个脚本还会直接将复权数据下载到本地，便于后续回测使用。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls
</span></span><span style=display:flex><span>LH.DCE_backward_pre_close-pre_close.csv
</span></span></code></pre></td></tr></table></div></div><p>如果不想看完整文章，直接看文件代码地址：<a href=https://gist.github.com/poloxue/74fc77c6069a2293c6b776f0ea40a5bf>download_future_adj_data.py</a>。这个代码是完整版，文章重点是介绍实现逻辑。</p><p>如下是这个命令的帮助信息：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Usage: main.py <span style=color:#f92672>[</span>OPTIONS<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Options:
</span></span><span style=display:flex><span>  --ts-code TEXT    期货合约代码（例如：LH.DCE 表示生猪期货）  <span style=color:#f92672>[</span>必填<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  --start-date TEXT 起始日期（格式：YYYYMMDD，默认为20220101）
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --adjust          复权方式（默认：forward）: 
</span></span><span style=display:flex><span>                    forward: 前复权（以当前价格为基准调整历史数据）
</span></span><span style=display:flex><span>                    backward: 后复权（保持历史价格不变调整未来数据）
</span></span><span style=display:flex><span>  --method          换月调整方法（默认：pre_close/pre_close）:
</span></span><span style=display:flex><span>                    pre_close/pre_close: 使用前收盘价复权
</span></span><span style=display:flex><span>                    open/pre_close: 使用开盘价/前收盘价复权
</span></span><span style=display:flex><span>                    pre_settle/pre_settle: 使用前结算价复权
</span></span><span style=display:flex><span>                    open/pre_settle: 使用开盘价复权
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  --plot            是否显示价格曲线图（默认不显示）
</span></span><span style=display:flex><span>  --help            Show this message and exit.
</span></span></code></pre></td></tr></table></div></div><p>前复权也支持。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>python main<span style=color:#f92672>.</span>py <span style=color:#f92672>--</span>ts<span style=color:#f92672>-</span>code LH<span style=color:#f92672>.</span>DCE <span style=color:#f92672>--</span>adjust forward <span style=color:#f92672>--</span>method open<span style=color:#f92672>/</span>pre_close <span style=color:#f92672>--</span>plot 
</span></span></code></pre></td></tr></table></div></div><p>价格图如下：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-03/2025-03-08-adj-data-using-tushare-in-china-future-market-06.png alt></p><p>如果没有 Tushare 数据，文中也提供了关于如何自定义切换规则的一些思路和代码。或者联系我拿 Tushare 权限，有 20% 的折扣。如果是临时需要，我可以免费提供一个品种的复权数据。</p><hr><p>正式进入主题，本文我将介绍如何基于 tushare 计算主连合约的复权数据。</p><p>核心有两部分：</p><ul><li>一是拿到主连合约与实际合约的映射；</li><li>二是计算复权因子；</li></ul><h2 id=准备工作>准备工作</h2><p>下载安装将用到的几个 Python 库。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install tushare pandas matplotlib click tqdm
</span></span></code></pre></td></tr></table></div></div><p>这里用到了一个不常用的库 - tqdm，它是用来展示数据下载进度的，特别当下载数量非常大时，这个小技巧能提升你的体验甚至效率。</p><p>简单示例：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> tqdm <span style=color:#f92672>import</span> tqdm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> tqdm(range(<span style=color:#ae81ff>100</span>)):
</span></span><span style=display:flex><span>    time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.1</span>)
</span></span></code></pre></td></tr></table></div></div><p>效果如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>100%|██████████████████████████| 100/100 <span style=color:#f92672>[</span>00:01&lt;00:00, 86.14it/s<span style=color:#f92672>]</span>
</span></span></code></pre></td></tr></table></div></div><p>导入所有库，配置认证 tushare 的 token。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> tushare <span style=color:#66d9ef>as</span> ts
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> tqdm <span style=color:#f92672>import</span> tqdm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ts<span style=color:#f92672>.</span>set_token(<span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>pro <span style=color:#f92672>=</span> ts<span style=color:#f92672>.</span>pro_api(<span style=color:#e6db74>&#34;Your Tushare Pro Token&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=映射数据>映射数据</h2><p>映射数据从哪里拿？</p><p>我可以直接从数据提供商那里获取。如果能明确换仓规则，也可自己计算，即我知道如主连合约的底层合约何时从一个换到另一个。</p><h3 id=标准映射数据>标准映射数据</h3><p>先说下如何拿到标准主连的映射关系，也就是如同花顺等交易软件上一样的主连合约规则，通过 tushare 的 <code>fut_mapping</code> 能直接拿到。我能接触到的数据源中，只在 tushare 看到了这个标准规则的映射关系。</p><p>如获取生猪的主连合约从2022年1月1日到现在与底层合约的映射，示例代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>mapping_data <span style=color:#f92672>=</span> pro<span style=color:#f92672>.</span>fut_mapping(
</span></span><span style=display:flex><span>  ts_code<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;LH.DCE&#34;</span>,
</span></span><span style=display:flex><span>  start_date<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;20220101&#34;</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>mapping_data<span style=color:#f92672>.</span>sort_values(
</span></span><span style=display:flex><span>  by<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;trade_date&#34;</span>,
</span></span><span style=display:flex><span>  inplace<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>  ignore_index<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>,
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>print(mapping_data)
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    ts_code trade_date mapping_ts_code
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>    LH.DCE   <span style=color:#ae81ff>20220104</span>      LH2203.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>    LH.DCE   <span style=color:#ae81ff>20220105</span>      LH2203.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>    LH.DCE   <span style=color:#ae81ff>20220106</span>      LH2203.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>    LH.DCE   <span style=color:#ae81ff>20220107</span>      LH2203.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>    LH.DCE   <span style=color:#ae81ff>20220110</span>      LH2203.DCE
</span></span><span style=display:flex><span>..      ...        ...             ...
</span></span><span style=display:flex><span><span style=color:#ae81ff>762</span>  LH.DCE   <span style=color:#ae81ff>20250303</span>      LH2505.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>763</span>  LH.DCE   <span style=color:#ae81ff>20250304</span>      LH2505.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>764</span>  LH.DCE   <span style=color:#ae81ff>20250305</span>      LH2505.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>765</span>  LH.DCE   <span style=color:#ae81ff>20250306</span>      LH2505.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>766</span>  LH.DCE   <span style=color:#ae81ff>20250307</span>      LH2505.DCE
</span></span></code></pre></td></tr></table></div></div><p>如上的 <code>mappint_ts_code</code> 主连合约当前的底层合约。</p><p>我没有去深究这个规则，最常见的连续合约就是主力连续，主力合约似乎是以持仓为判断标准编织，还有其他的连续合约，如按固定日期切换，复权，最小价差等。</p><p>假设，Tushare 还提供了一个生猪连续合约的映射关系，在 <code>LH</code> 后加上 <code>L</code>，即 <code>LHL</code>，它的代码规则是 <code>主力合约代码+L</code>。如果想要所有的合约信息，可通过 tushare 的 <code>fut_basic</code> 接口拿到合约的基础信息。</p><h3 id=自定义换仓规则>自定义换仓规则</h3><p>如果无法拿到这个标准的映射数据，可自定义一个尽量接近于标准的换仓规则。</p><p>我定义了一个固定日期换仓规则：</p><p>每月 28 号换仓到下一个合约，要求交割日期不少于 40 天。我将其封装成了一个函数，其中用到了 tushare 的 <code>fut_basic</code> 合约列表接口、<code>trade_cal</code> 交易日历接口。</p><p>函数定义：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>fut_mapping</span>(fut_code, exchange)
</span></span></code></pre></td></tr></table></div></div><p>这是个简单例子，但在文章中介绍还是有点繁琐，就不展开了。请查看 <a href=https://gist.github.com/poloxue/c3394991fa6dfb27bc2bce060378eef5>custom_fut_mapping.py</a>。</p><p>调用示例：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>mapping_data <span style=color:#f92672>=</span> fut_mapping(<span style=color:#e6db74>&#34;LH&#34;</span>, exchange<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;DCE&#34;</span>)
</span></span><span style=display:flex><span>print(mapping_map)
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>      trade_date ts_code mapping_ts_code
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>       <span style=color:#ae81ff>20210108</span>     LHC      LH2109.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>       <span style=color:#ae81ff>20210111</span>     LHC      LH2109.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>       <span style=color:#ae81ff>20210112</span>     LHC      LH2109.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>       <span style=color:#ae81ff>20210113</span>     LHC      LH2109.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>       <span style=color:#ae81ff>20210114</span>     LHC      LH2109.DCE
</span></span><span style=display:flex><span>...          ...     ...             ...
</span></span><span style=display:flex><span><span style=color:#ae81ff>1001</span>    <span style=color:#ae81ff>20250303</span>     LHC      LH2507.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>1002</span>    <span style=color:#ae81ff>20250304</span>     LHC      LH2507.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>1003</span>    <span style=color:#ae81ff>20250305</span>     LHC      LH2507.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>1004</span>    <span style=color:#ae81ff>20250306</span>     LHC      LH2507.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>1005</span>    <span style=color:#ae81ff>20250307</span>     LHC      LH2507.DCE
</span></span></code></pre></td></tr></table></div></div><p>其中的 <code>LHC</code> 是我随意定义的表示这个规则的生猪合约代码。</p><p>不知道这个代码有没有参考价值。</p><p>如果你没有途径拿到标准的主连合约的映射关系，这个或许可参考，将 tushare 替换为你的数据源即可。你可以修改规则，如按最大持仓，价差最小等等，计算这些规则所需的数据基本都是公开可获取的。</p><h3 id=查询换仓详情>查询换仓详情</h3><p>如现在我想查看换仓详情，只要记录上个交易日的 <code>mapping_ts_code</code>，比较前后 <code>mapping_ts_code</code> 是否相同。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 之前的合约</span>
</span></span><span style=display:flex><span>mapping_data[<span style=color:#e6db74>&#34;pre_mapping_ts_code&#34;</span>] <span style=color:#f92672>=</span> mapping_data[<span style=color:#e6db74>&#34;mapping_ts_code&#34;</span>]<span style=color:#f92672>.</span>shift(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#75715e># 当前合约和之前合约不同且之前合约不为空</span>
</span></span><span style=display:flex><span>mapping_data[<span style=color:#e6db74>&#34;rollover&#34;</span>] <span style=color:#f92672>=</span> (
</span></span><span style=display:flex><span>  (mapping_data[<span style=color:#e6db74>&#34;mapping_ts_code&#34;</span>] <span style=color:#f92672>!=</span> mapping_data[<span style=color:#e6db74>&#34;pre_mapping_ts_code&#34;</span>]) <span style=color:#f92672>&amp;</span>
</span></span><span style=display:flex><span>  mapping_data[<span style=color:#e6db74>&#34;pre_mapping_ts_code&#34;</span>]<span style=color:#f92672>.</span>notna()
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>print(mapping_data[mapping_data[<span style=color:#e6db74>&#34;rollover&#34;</span>]][
</span></span><span style=display:flex><span>  [<span style=color:#e6db74>&#34;ts_code&#34;</span>, <span style=color:#e6db74>&#34;trade_date&#34;</span>, <span style=color:#e6db74>&#34;mapping_ts_code&#34;</span>, <span style=color:#e6db74>&#34;pre_mapping_ts_code]</span>
</span></span><span style=display:flex><span>])
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    ts_code trade_date mapping_ts_code pre_mapping_ts_code
</span></span><span style=display:flex><span><span style=color:#ae81ff>20</span>   LH.DCE   <span style=color:#ae81ff>20220208</span>      LH2205.DCE           LH2203.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>68</span>   LH.DCE   <span style=color:#ae81ff>20220419</span>      LH2209.DCE           LH2205.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>143</span>  LH.DCE   <span style=color:#ae81ff>20220808</span>      LH2301.DCE           LH2209.DCE
</span></span><span style=display:flex><span>..      ...        ...             ...
</span></span><span style=display:flex><span><span style=color:#ae81ff>667</span>  LH.DCE   <span style=color:#ae81ff>20241010</span>      LH2501.DCE           LH2411.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>714</span>  LH.DCE   <span style=color:#ae81ff>20241216</span>      LH2503.DCE           LH2501.DCE
</span></span><span style=display:flex><span><span style=color:#ae81ff>747</span>  LH.DCE   <span style=color:#ae81ff>20250210</span>      LH2505.DCE           LH2503.DCE
</span></span></code></pre></td></tr></table></div></div><p>从上面就能看出来，合约是哪天（<code>trade_date</code>）从哪个合约（<code>pre_mapping_ts_code</code>）切换到当前的合约（<code>mapping_ts_code</code>）。</p><h2 id=计算复权数据>计算复权数据</h2><p>到此，已经拿到了最难获取的主连合约映射关系，开始计算复权数据。</p><p>这块的核心是计算复权因子。有了复权因子，接着只要将复权因子作用到原始价格上即可拿到复权价格数据。</p><h3 id=复权方法>复权方法</h3><p>常见的复权因子公式有哪些？</p><ul><li>open/pre_close，即当前合约的开盘价与上个合约收盘价的比值</li><li>pre_close/pre_close，即当前合约和上个合约收盘价的比值；</li><li>pre_settle/pre_settle，即当前合约与上个合约结算价的比值；</li><li>open/open，即当前合约和上个合约的开盘价的比值；</li></ul><p>如上统一采用的是比值计算方法，只是计算所用的价格不同。这篇文章会介绍前三种方法的实现，第四种 open/open 在脚本也实现了，就不再文章里展开了。</p><p>接下来具体介绍这四个复权因子的计算方法。</p><h3 id=openpre_close>open/pre_close</h3><p>open/pre_close 是最简单的复权因子计算方法，因为在矩阵计算中，这最容易实现，不少文章就写了这种实现。对应到实际操作，即在合约切换收盘日平仓，次日在新合约重新开仓即可。</p><p>计算复权因子，要先拿到价格数据。</p><p>如果你用的 tushare 作为数据源，直接调用 <code>fut_daily</code> 就能拿到主连的日线数据，通过 <code>open/pre_close</code> 即可。不过为了与接下来其他计算方式的统一，我还是通过调取实际合约的价格，将它们与主连合约重新拼接得到主连的价格。</p><p>为了拿到实际合约的价格，我要知道每个合约在主连合约上出现的开始和结束时间。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>extract_date_range</span>(group):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> group[<span style=color:#e6db74>&#34;trade_date&#34;</span>]<span style=color:#f92672>.</span>min(), group[<span style=color:#e6db74>&#34;trade_date&#34;</span>]<span style=color:#f92672>.</span>max()
</span></span><span style=display:flex><span>date_ranges <span style=color:#f92672>=</span> mapping_data<span style=color:#f92672>.</span>groupby(<span style=color:#e6db74>&#34;mapping_ts_code&#34;</span>)<span style=color:#f92672>.</span>apply(extract_date_range)
</span></span><span style=display:flex><span>print(date_ranges)
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mapping_ts_code
</span></span><span style=display:flex><span>LH2109.DCE    <span style=color:#f92672>(</span>20210108, 20210818<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LH2201.DCE    <span style=color:#f92672>(</span>20210819, 20211210<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LH2203.DCE    <span style=color:#f92672>(</span>20211213, 20220207<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>...           ...
</span></span><span style=display:flex><span>LH2501.DCE    <span style=color:#f92672>(</span>20241010, 20241213<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LH2503.DCE    <span style=color:#f92672>(</span>20241216, 20250207<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>LH2505.DCE    <span style=color:#f92672>(</span>20250210, 20250307<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>dtype: object
</span></span></code></pre></td></tr></table></div></div><p>现在基于 <code>ts_code</code> 和 <code>date_range</code> 从 <code>fut_daily</code> 获取接口数据。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>all_ohlcvs <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ts_code, (start_date, end_date) <span style=color:#f92672>in</span> tqdm(date_ranges<span style=color:#f92672>.</span>items()):
</span></span><span style=display:flex><span>    ohlcvs <span style=color:#f92672>=</span> pro<span style=color:#f92672>.</span>fut_daily(ts_code<span style=color:#f92672>=</span>ts_code, start_date<span style=color:#f92672>=</span>start_date, end_date<span style=color:#f92672>=</span>end_date)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> ohlcvs<span style=color:#f92672>.</span>empty:
</span></span><span style=display:flex><span>        all_ohlcvs<span style=color:#f92672>.</span>append(ohlcvs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ohlcv_data <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>concat(all_ohlcvs, ignore_index<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span></code></pre></td></tr></table></div></div><p>将 <code>ohlcv_data</code> <code>mapping_data</code> 合并就能得到主连合约完整的数据了。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>data <span style=color:#f92672>=</span> mapping_data<span style=color:#f92672>.</span>merge(
</span></span><span style=display:flex><span>    ohlcv_data,
</span></span><span style=display:flex><span>    left_on<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;mapping_ts_code&#34;</span>, <span style=color:#e6db74>&#34;trade_date&#34;</span>],
</span></span><span style=display:flex><span>    right_on<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;ts_code&#34;</span>, <span style=color:#e6db74>&#34;trade_date&#34;</span>],
</span></span><span style=display:flex><span>    how<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;left&#34;</span>,
</span></span><span style=display:flex><span>    suffixes<span style=color:#f92672>=</span>(<span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#e6db74>&#34;_1&#34;</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>data<span style=color:#f92672>.</span>drop(columns<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;ts_code_1&#34;</span>], inplace<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>print(data[[<span style=color:#e6db74>&#34;ts_code&#34;</span>, <span style=color:#e6db74>&#34;trade_date&#34;</span>, <span style=color:#e6db74>&#34;open&#34;</span>, <span style=color:#e6db74>&#34;pre_close_before&#34;</span>]])
</span></span></code></pre></td></tr></table></div></div><p>输出：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    ts_code trade_date     open  pre_close
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span>    LH.DCE   <span style=color:#ae81ff>20220104</span>  14320.0    14450.0
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>    LH.DCE   <span style=color:#ae81ff>20220105</span>  14165.0    14165.0
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>    LH.DCE   <span style=color:#ae81ff>20220106</span>  14250.0    14245.0
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>    LH.DCE   <span style=color:#ae81ff>20220107</span>  14150.0    14075.0
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>    LH.DCE   <span style=color:#ae81ff>20220110</span>  13670.0    13915.0
</span></span><span style=display:flex><span>..      ...        ...      ...        ...
</span></span><span style=display:flex><span><span style=color:#ae81ff>762</span>  LH.DCE   <span style=color:#ae81ff>20250303</span>  12950.0    12935.0
</span></span><span style=display:flex><span><span style=color:#ae81ff>763</span>  LH.DCE   <span style=color:#ae81ff>20250304</span>  13100.0    13125.0
</span></span><span style=display:flex><span><span style=color:#ae81ff>764</span>  LH.DCE   <span style=color:#ae81ff>20250305</span>  13160.0    13195.0
</span></span><span style=display:flex><span><span style=color:#ae81ff>765</span>  LH.DCE   <span style=color:#ae81ff>20250306</span>  13055.0    13070.0
</span></span><span style=display:flex><span><span style=color:#ae81ff>766</span>  LH.DCE   <span style=color:#ae81ff>20250307</span>  13100.0    13090.0
</span></span></code></pre></td></tr></table></div></div><p>复权因子的计算是将 open/pre_close 即可，但这里还有有个小问题，默认的 <code>pre_close</code> 是当前映射合约上个交易日的收盘价，不是上个映射合约的上个交易日的收盘价。</p><p>一行代码解决：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>data[<span style=color:#e6db74>&#34;pre_close_before&#34;</span>] <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#34;close&#34;</span>]<span style=color:#f92672>.</span>shift(<span style=color:#ae81ff>1</span>)
</span></span></code></pre></td></tr></table></div></div><p>计算复权因子，我以后复权为例。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 换仓时的数据</span>
</span></span><span style=display:flex><span>rollover_data <span style=color:#f92672>=</span> data[data[<span style=color:#e6db74>&#34;rollover&#34;</span>]]
</span></span><span style=display:flex><span><span style=color:#75715e># 计算复权因子</span>
</span></span><span style=display:flex><span>data[<span style=color:#e6db74>&#34;rollover_factor&#34;</span>] <span style=color:#f92672>=</span> rollover_data[<span style=color:#e6db74>&#34;open&#34;</span>] <span style=color:#f92672>/</span> rollover_data[<span style=color:#e6db74>&#34;pre_close_before&#34;</span>]
</span></span><span style=display:flex><span>data[<span style=color:#e6db74>&#34;adj_factor&#34;</span>] <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span><span style=color:#f92672>/</span>data[<span style=color:#e6db74>&#34;rollover_factor&#34;</span>])<span style=color:#f92672>.</span>fillna(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>cumprod()
</span></span></code></pre></td></tr></table></div></div><p>计算复权价格并绘制收盘价：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>data[<span style=color:#e6db74>&#34;adj_close&#34;</span>] <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#34;close&#34;</span>] <span style=color:#f92672>*</span> data[<span style=color:#e6db74>&#34;adj_factor&#34;</span>]
</span></span><span style=display:flex><span>data[[<span style=color:#e6db74>&#34;adj_close&#34;</span>, <span style=color:#e6db74>&#34;close&#34;</span>]]<span style=color:#f92672>.</span>plot()
</span></span></code></pre></td></tr></table></div></div><p>绘制价格图表：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>data[<span style=color:#e6db74>&#39;trade_date&#39;</span>] <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>datetime(data[<span style=color:#e6db74>&#39;trade_date&#39;</span>])
</span></span><span style=display:flex><span>data<span style=color:#f92672>.</span>set_index(<span style=color:#e6db74>&#34;trade_date&#34;</span>, inplace<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>data<span style=color:#f92672>.</span>index<span style=color:#f92672>.</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;date&#34;</span>
</span></span><span style=display:flex><span>plt<span style=color:#f92672>.</span>show()
</span></span></code></pre></td></tr></table></div></div><p>绘图如下：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-03/2025-03-08-adj-data-using-tushare-in-china-future-market-01-v1.png alt></p><p>复权价格和实际的价格差异还是很大。</p><h3 id=pre_closepre_close-和-pre_settlepre_settle>pre_close/pre_close 和 pre_settle/pre_settle</h3><p>pre_close/pre_close 和 pre_settle/pre_settle 的复权因子的计算也很简单了。因为这里是手动拼接的价格数据，当前合约和上个合约的价格上个交易日的价格都很容易拿到。</p><p>pre_close/pre_close：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>data[<span style=color:#e6db74>&#34;rollover_factor&#34;</span>] <span style=color:#f92672>=</span> rollover_data[<span style=color:#e6db74>&#34;prev_close&#34;</span>] <span style=color:#f92672>/</span> rollover_data[<span style=color:#e6db74>&#34;pre_close_before&#34;</span>]
</span></span><span style=display:flex><span>data[<span style=color:#e6db74>&#34;adj_factor&#34;</span>] <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#34;rollover_factor&#34;</span>]<span style=color:#f92672>.</span>fillna(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>cumprod()
</span></span></code></pre></td></tr></table></div></div><p>pre_settle/pre_settle：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>data[<span style=color:#e6db74>&#34;pre_settle_before&#34;</span>] <span style=color:#f92672>=</span> data[<span style=color:#e6db74>&#34;settle&#34;</span>]<span style=color:#f92672>.</span>shift(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>data[<span style=color:#e6db74>&#34;rollover_factor&#34;</span>] <span style=color:#f92672>=</span> rollover_data[<span style=color:#e6db74>&#34;prev_settle&#34;</span>] <span style=color:#f92672>/</span> rollover_data[<span style=color:#e6db74>&#34;pre_settle_before&#34;</span>]
</span></span><span style=display:flex><span>data[<span style=color:#e6db74>&#34;adj_factor&#34;</span>] <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span><span style=color:#f92672>/</span>data[<span style=color:#e6db74>&#34;rollover_factor&#34;</span>])<span style=color:#f92672>.</span>fillna(<span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>cumprod()
</span></span></code></pre></td></tr></table></div></div><p>有了复权因子，就可以将价格数据与其相乘就能拿到复权价格了。</p><h2 id=总结>总结</h2><p>这篇文章主要实现如何基于 tushare 计算期货的复权数据，包含了常见的复权计算方法，完整的脚本请查看地址：<a href=https://gist.github.com/poloxue/74fc77c6069a2293c6b776f0ea40a5bf>download_future_adj_data.py</a>。如果没有 tushare 数据，文中也提供了实现的具体思路，即使没有合约映射数据，也可以自己制定规则实现。</p><p>希望本文对你有用。</p><hr><p>最近有不少朋友希望我开群，如果有这个需求的，可以扫码加群：</p><p><img src=https://cdn.jsdelivr.net/gh/poloxue/images@2025-03/2025-03-08-adj-data-using-tushare-in-china-future-market-05-v1.png style=width:300px><img></p><p>补充：</p><div style=color:#ff2020><p>如果想直接用 Tushare 的数据，可联系我，有 20% 的折扣。Tushare 一年 200 元的积分等级就包含了这篇文章中的所有数据 API（这个等级其实已经支持了 tushare.pro 上 60% 的数据接口）。如只是临时需要，可以免费提供一个品种的复权数据。</div></p><div>本文来源于 <a href=https://www.poloxue.com>POLOXUE's BLOG</a>，地址： <a href=https://www.poloxue.com/posts/2025-03-08-adj-data-using-tushare-in-china-future-market/>期货回测大坑-基于 tushare 下载和计算期货的复权数据</a></div></div><nav class="hide-on-mobile section-nav"><nav id=TableOfContents><ol><li><a href=#背景概述>背景概述</a></li><li><a href=#期货复权数据下载工具>期货复权数据下载工具</a></li><li><a href=#准备工作>准备工作</a></li><li><a href=#映射数据>映射数据</a><ol><li><a href=#标准映射数据>标准映射数据</a></li><li><a href=#自定义换仓规则>自定义换仓规则</a></li><li><a href=#查询换仓详情>查询换仓详情</a></li></ol></li><li><a href=#计算复权数据>计算复权数据</a><ol><li><a href=#复权方法>复权方法</a></li><li><a href=#openpre_close>open/pre_close</a></li><li><a href=#pre_closepre_close-和-pre_settlepre_settle>pre_close/pre_close 和 pre_settle/pre_settle</a></li></ol></li><li><a href=#总结>总结</a></li></ol></nav></nav></div><div class=post><hr class=footer-separator><div class=tags></div><div class=back><a href=https://www.poloxue.com/><span aria-hidden=true>← Back</span></a></div><div class=back></div></div><div class=post><img style=width:85% src=https://cdn.jsdelivr.net/gh/poloxue/images@main/wechat.png><div class=utterances></div><script src=https://utteranc.es/client.js repo=poloxue/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div><div class="footer wrapper"><nav class=nav><div>2025 Polo Xue All rights reserved</div></nav></div><script>feather.replace()</script><script>var enableTruncate=!0,filterDepth=!1;const MAX_DEPTH=9;window.addEventListener("DOMContentLoaded",()=>{const e=new IntersectionObserver(e=>{e.reverse().forEach(e=>{const n=e.target.getAttribute("id");if(e.intersectionRatio>0){var t=document.querySelectorAll(`nav li a[href="#${n}"]`);t!=null&&t.forEach(e=>{if(e!=null){var t=getDepth(e.parentElement);filterDepth&&t<=MAX_DEPTH&&(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))}else filterDepth||(clearActiveStatesInTableOfContents(),e.parentElement.classList.add("active"))})}})});document.querySelectorAll("h1[id],h2[id],h3[id],h4[id]").forEach(t=>{e.observe(t)})});function isVisible(e){if(!(e instanceof Element))return!1;const n=getComputedStyle(e);if(n.display==="none")return!1;if(n.visibility!=="visible")return!1;if(n.opacity<.1)return!1;if(e.offsetWidth+e.offsetHeight+e.getBoundingClientRect().height+e.getBoundingClientRect().width===0)return!1;const t={x:e.getBoundingClientRect().left+e.offsetWidth/2,y:e.getBoundingClientRect().top+e.offsetHeight/2};if(t.x<0)return!1;if(t.x>(document.documentElement.clientWidth||window.innerWidth))return!1;if(t.y<0)return!1;if(t.y>(document.documentElement.clientHeight||window.innerHeight))return!1;let s=document.elementFromPoint(t.x,t.y);do if(s===e)return!0;while(s=s.parentNode)return!1}function clearActiveStatesInTableOfContents(){document.querySelectorAll("nav li").forEach(e=>{e.classList.remove("active")})}function getDepth(e){for(var t=0;e!==null&&e.tagName.toLowerCase()!=="ul";)t++,e=e.parentElement;return t}function navItems(){var e=document.querySelectorAll("nav nav li a");return Array.from(e).filter(e=>e.href!=null&&e.hash.startsWith("#"))}function lasItemInNavBarVisible(){var e=navItems().slice(-1)[0];return isVisible(e)}document.addEventListener("DOMContentLoaded",function(){if(!enableTruncate)return;var e=navItems();console.log(e),lasItemInNavBarVisible()||(filterDepth=!0,e.forEach(function(e){var t=getDepth(e.parentElement);t>MAX_DEPTH&&e.parentElement.classList.add("depth-nested")}))})</script></body></html>